# 测试系统设计文档

## 1. 概述

本测试系统旨在通过对比转换结果来修正我们的方案，确保与Claude Code Router的逻辑转换一致，同时保持架构独立性。系统包含数据捕获、对比分析、启动脚本和修复流程等功能。

## 2. 系统架构

### 2.1 核心组件

1. **数据捕获模块** - 捕获Claude Code Router和我们系统的请求/响应数据
2. **对比分析模块** - 对比两套系统的转换结果，识别差异
3. **自动化修正模块** - 基于差异分析自动生成和执行修正策略
4. **启动脚本** - 提供完整的测试执行入口
5. **报告生成模块** - 生成详细的测试和修正报告

### 2.2 数据流向

```
真实请求 → [Claude Code Router] → 请求/响应数据
        → [我们的系统] → 请求/响应数据
                ↓
            对比分析 → 差异报告
                ↓
            自动修正 → 更新配置/代码
                ↓
            验证测试 → 修正效果确认
```

## 3. 功能详细设计

### 3.1 数据捕获功能

#### 3.1.1 捕获点设计
- Transformer模块输入/输出
- ServerCompatibility模块输入/输出
- Protocol模块输入/输出
- 完整的端到端请求/响应

#### 3.1.2 数据格式
```json
{
  "requestId": "唯一请求标识",
  "timestamp": "时间戳",
  "module": "模块名称",
  "input": "输入数据",
  "output": "输出数据",
  "metadata": {
    "provider": "提供商",
    "model": "模型",
    "processingTime": "处理时间"
  }
}
```

### 3.2 对比分析功能

#### 3.2.1 对比维度
1. **字段完整性** - 检查必需字段是否存在
2. **字段值一致性** - 比较相同字段的值是否一致
3. **结构一致性** - 比较数据结构是否一致
4. **语义一致性** - 比较语义是否一致（如工具调用参数）

#### 3.2.2 差异类型
1. **缺失字段** - Claude Code Router有但我们的系统没有的字段
2. **多余字段** - 我们的系统有但Claude Code Router没有的字段
3. **字段值差异** - 相同字段但值不同的情况
4. **结构差异** - 数据结构不一致的情况

### 3.3 自动化修正功能

#### 3.3.1 修正策略
1. **配置修正** - 更新转换表和兼容性配置
2. **代码修正** - 修改模块代码逻辑
3. **参数调整** - 调整处理参数

#### 3.3.2 修正流程
1. 分析差异报告
2. 生成修正策略
3. 执行修正操作
4. 验证修正效果
5. 生成修正报告

## 4. 启动脚本设计

### 4.1 脚本功能
1. 启动测试环境
2. 执行测试用例
3. 捕获对比数据
4. 生成差异报告
5. 执行自动修正
6. 验证修正结果

### 4.2 使用方式
```bash
# 启动完整测试流程
./scripts/test-with-comparison.sh

# 只执行数据捕获
./scripts/capture-data.sh

# 只执行对比分析
./scripts/compare-results.sh

# 执行自动修正
./scripts/auto-fix.sh
```

## 5. 修复流程设计

### 5.1 修复触发条件
1. 对比分析发现显著差异
2. 用户手动触发修复
3. 定期自动修复检查

### 5.2 修复步骤
1. **差异分析** - 详细分析差异点
2. **策略生成** - 生成修复策略
3. **修复执行** - 执行修复操作
4. **效果验证** - 验证修复效果
5. **报告生成** - 生成修复报告

### 5.3 修复类型
1. **配置修复** - 更新配置文件和转换表
2. **代码修复** - 修改模块实现代码
3. **参数修复** - 调整处理参数

## 6. 实现计划

### 6.1 第一阶段 - 基础框架
- [x] 设计测试系统架构
- [x] 实现数据捕获功能
- [x] 实现对比分析功能
- [x] 编写完整测试系统文档

### 6.2 第二阶段 - 自动化功能
- [ ] 设计完整的启动脚本
- [ ] 实现自动化调整修正机制
- [ ] 实现修复流程
- [ ] 集成所有功能模块

### 6.3 第三阶段 - 优化完善
- [ ] 优化对比算法
- [ ] 增强修复策略
- [ ] 完善报告生成
- [ ] 性能优化

## 7. 配置文件

### 7.1 测试配置
```json
{
  "testConfig": {
    "captureEnabled": true,
    "comparisonEnabled": true,
    "autoFixEnabled": true,
    "providers": ["lmstudio", "qwen", "iflow"],
    "testCases": [
      {
        "name": "basic_request",
        "description": "基本请求测试",
        "inputFile": "test-cases/basic-request.json"
      }
    ]
  }
}
```

## 8. API接口

### 8.1 数据捕获API
```
POST /api/v1/test/capture/start     # 开始数据捕获
POST /api/v1/test/capture/stop      # 停止数据捕获
GET  /api/v1/test/capture/status    # 获取捕获状态
```

### 8.2 对比分析API
```
POST /api/v1/test/compare           # 执行对比分析
GET  /api/v1/test/compare/results   # 获取对比结果
GET  /api/v1/test/compare/report    # 获取对比报告
```

### 8.3 修复执行API
```
POST /api/v1/test/fix/analyze       # 分析修复需求
POST /api/v1/test/fix/execute       # 执行修复
GET  /api/v1/test/fix/status        # 获取修复状态
```