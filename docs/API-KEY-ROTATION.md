# OpenAI API Keyè½®è¯¢ç³»ç»Ÿ

## æ¦‚è¿°

Claude Code Routerçš„OpenAI API Keyè½®è¯¢ç³»ç»Ÿå…è®¸ä¸ºå•ä¸ªprovideré…ç½®å¤šä¸ªAPI keyï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è½®è¯¢ä½¿ç”¨è¿™äº›keyæ¥é¿å…rate limité—®é¢˜ã€‚å½“æŸä¸ªkeyé‡åˆ°429é”™è¯¯æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨çš„keyã€‚

## åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°åŠŸèƒ½
- **å¤škeyé…ç½®**: æ”¯æŒä¸ºå•ä¸ªprovideré…ç½®å¤šä¸ªAPI key
- **è‡ªåŠ¨è½®è¯¢**: æŒ‰é…ç½®çš„ç­–ç•¥è‡ªåŠ¨è½®æ¢API keyä½¿ç”¨
- **Rate limitæ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹429é”™è¯¯å¹¶æ ‡è®°keyä¸ºä¸´æ—¶ä¸å¯ç”¨
- **é”™è¯¯è¿½è¸ª**: è·Ÿè¸ªæ¯ä¸ªkeyçš„æˆåŠŸç‡å’Œè¿ç»­é”™è¯¯æ¬¡æ•°
- **ç­–ç•¥é€‰æ‹©**: æ”¯æŒå¤šç§è½®è¯¢ç­–ç•¥ (round_robin, health_based, rate_limit_aware)
- **å†·å´æœºåˆ¶**: keyä½¿ç”¨åçš„å†·å´æ—¶é—´ï¼Œé¿å…è¿‡äºé¢‘ç¹ä½¿ç”¨
- **ä¼˜é›…é™çº§**: æ‰€æœ‰keyä¸å¯ç”¨æ—¶è‡ªåŠ¨é‡ç½®çŠ¶æ€å°è¯•æ¢å¤

### ğŸ¯ æ ¸å¿ƒåŸåˆ™
æŒ‰ç…§ç”¨æˆ·è¦æ±‚ï¼š"è¿™ä¸ªè½®è¯¢ç³»ç»Ÿç›®å‰é‡‡ç”¨æœ€ç®€å•çš„æ–¹å¼ï¼Œä¾æ¬¡å‘é€ï¼Œå¹³å‡å‘é€"

## é…ç½®æ–¹æ³•

### åŸºæœ¬é…ç½®
```json
{
  "providers": {
    "provider-name": {
      "type": "openai",
      "endpoint": "https://api.openai.com/v1/chat/completions",
      "authentication": {
        "type": "bearer",
        "credentials": {
          "apiKey": [
            "sk-key1-xxxxxxxxxxxxxxxxxxxxxxxxxxxx",
            "sk-key2-yyyyyyyyyyyyyyyyyyyyyyyyyyyy", 
            "sk-key3-zzzzzzzzzzzzzzzzzzzzzzzzzzzz"
          ]
        }
      },
      "keyRotation": {
        "enabled": true,
        "strategy": "round_robin",
        "cooldownMs": 5000,
        "maxRetriesPerKey": 3
      }
    }
  }
}
```

### é…ç½®å‚æ•°è¯´æ˜

#### `authentication.credentials.apiKey`
- **ç±»å‹**: `string | string[]`
- **è¯´æ˜**: å•ä¸ªAPI keyï¼ˆå­—ç¬¦ä¸²ï¼‰æˆ–å¤šä¸ªAPI keyï¼ˆæ•°ç»„ï¼‰
- **ç¤ºä¾‹**: 
  ```json
  "apiKey": "sk-single-key"  // å•ä¸ªkey
  "apiKey": ["sk-key1", "sk-key2", "sk-key3"]  // å¤šä¸ªkey
  ```

#### `keyRotation` (å¯é€‰)
å½“é…ç½®å¤šä¸ªAPI keyæ—¶ï¼Œå¯ä»¥è®¾ç½®è½®è¯¢å‚æ•°ï¼š

- **`enabled`** (boolean, é»˜è®¤: true)
  - æ˜¯å¦å¯ç”¨keyè½®è¯¢ï¼Œè®¾ä¸ºfalseæ—¶ä½¿ç”¨ç¬¬ä¸€ä¸ªkey
  
- **`strategy`** (string, é»˜è®¤: "round_robin")
  - `"round_robin"`: ç®€å•è½®è¯¢ï¼Œä¾æ¬¡ä½¿ç”¨æ¯ä¸ªkey
  - `"health_based"`: åŸºäºæˆåŠŸç‡é€‰æ‹©æœ€å¥åº·çš„key
  - `"rate_limit_aware"`: ä¼˜å…ˆä½¿ç”¨æœ€ä¹…æœªä½¿ç”¨çš„keyï¼Œé¿å…rate limit

- **`cooldownMs`** (number, é»˜è®¤: 5000)
  - å•ä¸ªkeyä½¿ç”¨åçš„å†·å´æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  - åœ¨å†·å´æœŸå†…è¯¥keyä¸ä¼šè¢«é€‰æ‹©

- **`maxRetriesPerKey`** (number, é»˜è®¤: 3) 
  - å•ä¸ªkeyè¿ç»­å¤±è´¥å¤šå°‘æ¬¡åæš‚æ—¶ç¦ç”¨
  - å½“æ‰€æœ‰keyéƒ½è¢«ç¦ç”¨æ—¶ä¼šè‡ªåŠ¨é‡ç½®

## è½®è¯¢ç­–ç•¥è¯¦è§£

### Round Robin (è½®è¯¢)
- **ç‰¹ç‚¹**: æœ€ç®€å•çš„ç­–ç•¥ï¼ŒæŒ‰é¡ºåºä¾æ¬¡ä½¿ç”¨æ¯ä¸ªkey
- **é€‚ç”¨åœºæ™¯**: keyè´¨é‡ç›¸è¿‘ï¼Œå¸Œæœ›å¹³å‡åˆ†é…è´Ÿè½½
- **å®ç°**: ç»´æŠ¤ä¸€ä¸ªç´¢å¼•ï¼Œæ¯æ¬¡è¯·æ±‚åé€’å¢åˆ°ä¸‹ä¸€ä¸ªkey

### Health Based (åŸºäºå¥åº·åº¦)
- **ç‰¹ç‚¹**: ä¼˜å…ˆé€‰æ‹©æˆåŠŸç‡é«˜ã€é”™è¯¯å°‘çš„key
- **é€‚ç”¨åœºæ™¯**: keyè´¨é‡ä¸åŒï¼Œå¸Œæœ›ä¼˜å…ˆä½¿ç”¨ç¨³å®šçš„key
- **å®ç°**: æŒ‰æˆåŠŸç‡å’Œé”™è¯¯æ¬¡æ•°æ’åºé€‰æ‹©æœ€ä½³key

### Rate Limit Aware (é¿å…rate limit)
- **ç‰¹ç‚¹**: ä¼˜å…ˆé€‰æ‹©æœ€ä¹…æœªä½¿ç”¨çš„keyï¼Œæœ‰æ•ˆé¿å…rate limit
- **é€‚ç”¨åœºæ™¯**: é¢‘ç¹è¯·æ±‚åœºæ™¯ï¼Œéœ€è¦æœ€å¤§åŒ–é¿å…429é”™è¯¯
- **å®ç°**: æŒ‰æœ€åä½¿ç”¨æ—¶é—´å’Œé”™è¯¯æ¬¡æ•°ç»¼åˆæ’åº

## å·¥ä½œæµç¨‹

### 1. åˆå§‹åŒ–é˜¶æ®µ
```
é…ç½®å¤šä¸ªAPI key â†’ åˆå§‹åŒ–ApiKeyRotationManager â†’ è®¾ç½®è½®è¯¢ç­–ç•¥
```

### 2. è¯·æ±‚å¤„ç†é˜¶æ®µ
```
æ”¶åˆ°è¯·æ±‚ â†’ é€‰æ‹©å¯ç”¨key â†’ å‘é€è¯·æ±‚ â†’ å¤„ç†å“åº”/é”™è¯¯
```

### 3. é”™è¯¯å¤„ç†é˜¶æ®µ
```
æ£€æµ‹åˆ°429é”™è¯¯ â†’ æ ‡è®°keyä¸ºrate limited â†’ é€‰æ‹©ä¸‹ä¸€ä¸ªkey â†’ é‡è¯•
è¿ç»­é”™è¯¯è¾¾åˆ°é˜ˆå€¼ â†’ æš‚æ—¶ç¦ç”¨key â†’ å°è¯•å…¶ä»–key
æ‰€æœ‰keyä¸å¯ç”¨ â†’ é‡ç½®æ‰€æœ‰keyçŠ¶æ€ â†’ ç»§ç»­å°è¯•
```

## çŠ¶æ€ç®¡ç†

### KeyçŠ¶æ€
æ¯ä¸ªAPI keyç»´æŠ¤ä»¥ä¸‹çŠ¶æ€ä¿¡æ¯ï¼š
- `isActive`: æ˜¯å¦å¯ç”¨
- `lastUsed`: æœ€åä½¿ç”¨æ—¶é—´
- `consecutiveErrors`: è¿ç»­é”™è¯¯æ¬¡æ•°
- `successfulRequests`: æˆåŠŸè¯·æ±‚æ•°
- `totalRequests`: æ€»è¯·æ±‚æ•°
- `rateLimitUntil`: Rate limitç»“æŸæ—¶é—´

### è‡ªåŠ¨æ¢å¤æœºåˆ¶
- **Rate limitè‡ªåŠ¨æ¸…é™¤**: æˆåŠŸè¯·æ±‚åè‡ªåŠ¨æ¸…é™¤rate limitçŠ¶æ€
- **é”™è¯¯çŠ¶æ€é‡ç½®**: æ‰€æœ‰keyä¸å¯ç”¨æ—¶è‡ªåŠ¨é‡ç½®é”™è¯¯çŠ¶æ€
- **å¥åº·åº¦æ›´æ–°**: å®æ—¶æ›´æ–°æ¯ä¸ªkeyçš„æˆåŠŸç‡å’Œå¥åº·åº¦

## æ—¥å¿—ç›‘æ§

### å…³é”®æ—¥å¿—äº‹ä»¶
- **Keyé€‰æ‹©**: è®°å½•é€‰æ‹©çš„keyï¼ˆè„±æ•æ˜¾ç¤ºæœ«4ä½ï¼‰
- **Rate limitæ£€æµ‹**: è®°å½•429é”™è¯¯å’Œå†·å´æ—¶é—´
- **KeyçŠ¶æ€å˜æ›´**: è®°å½•keyç¦ç”¨/å¯ç”¨äº‹ä»¶
- **è½®è¯¢ç»Ÿè®¡**: å®šæœŸè¾“å‡ºå„keyçš„ä½¿ç”¨ç»Ÿè®¡

### ç¤ºä¾‹æ—¥å¿—
```
[INFO] API key rotation manager initialized: keyCount=3, strategy=round_robin
[DEBUG] API key selected for use: keyIndex=1, consecutiveErrors=0
[WARN] API key marked with rate limit: keyIndex=1, rateLimitUntil=2025-07-30T13:45:30Z
[INFO] API key rate limit cleared due to successful request: keyIndex=1
```

## æœ€ä½³å®è·µ

### 1. Keyé…ç½®å»ºè®®
- å»ºè®®é…ç½®2-5ä¸ªkeyï¼Œè¿‡å¤škeyä¼šå¢åŠ ç®¡ç†å¤æ‚åº¦
- ç¡®ä¿æ‰€æœ‰keyéƒ½æœ‰è¶³å¤Ÿçš„rate limité¢åº¦
- å®šæœŸè½®æ¢keyä»¥ä¿æŒå®‰å…¨æ€§

### 2. ç­–ç•¥é€‰æ‹©å»ºè®®
- **å¼€å‘æµ‹è¯•**: ä½¿ç”¨`round_robin`ç­–ç•¥ï¼Œç®€å•å¯é¢„æµ‹
- **ç”Ÿäº§ç¯å¢ƒ**: ä½¿ç”¨`rate_limit_aware`ç­–ç•¥ï¼Œæœ€å¤§åŒ–é¿å…429é”™è¯¯
- **æ··åˆç¯å¢ƒ**: ä½¿ç”¨`health_based`ç­–ç•¥ï¼Œè‡ªåŠ¨é€‚åº”keyè´¨é‡å·®å¼‚

### 3. å‚æ•°è°ƒä¼˜å»ºè®®
- **cooldownMs**: æ ¹æ®APIæä¾›å•†çš„rate limitæ”¿ç­–è°ƒæ•´ï¼Œä¸€èˆ¬5-10ç§’
- **maxRetriesPerKey**: è®¾ç½®ä¸º2-3æ¬¡ï¼Œé¿å…è¿‡åº¦é‡è¯•å•ä¸ªkey
- **å®šæœŸç›‘æ§**: æŸ¥çœ‹æ—¥å¿—ä¸­çš„keyä½¿ç”¨ç»Ÿè®¡ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸

## å…¼å®¹æ€§

### å‘åå…¼å®¹
- å•ä¸ªAPI keyé…ç½®å®Œå…¨å…¼å®¹ç°æœ‰é…ç½®
- ä¸é…ç½®`keyRotation`æ—¶ä½¿ç”¨é»˜è®¤è½®è¯¢è®¾ç½®
- ç°æœ‰providerï¼ˆAnthropic, CodeWhispererç­‰ï¼‰ä¸å—å½±å“

### Provideræ”¯æŒ
- âœ… **EnhancedOpenAIClient**: å®Œå…¨æ”¯æŒkeyè½®è¯¢
- âœ… **OpenAIClient**: å…¼å®¹å¤škeyé…ç½®ï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªkeyï¼‰
- âŒ **å…¶ä»–provider**: æš‚ä¸æ”¯æŒï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªkeyï¼‰

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: é…ç½®äº†å¤šä¸ªkeyä½†åªä½¿ç”¨ç¬¬ä¸€ä¸ªï¼Ÿ**
A: æ£€æŸ¥providerç±»å‹æ˜¯å¦ä¸º`openai`ä¸”ä½¿ç”¨`EnhancedOpenAIClient`

**Q: Keyè½®è¯¢é¢‘ç‡å¤ªé«˜ï¼Ÿ**  
A: å¢åŠ `cooldownMs`å‚æ•°ï¼Œå»ºè®®5000msä»¥ä¸Š

**Q: æ‰€æœ‰keyéƒ½æ˜¾ç¤ºrate limitedï¼Ÿ**
A: æ£€æŸ¥API keyé¢åº¦ï¼Œæˆ–ç­‰å¾…ç³»ç»Ÿè‡ªåŠ¨é‡ç½®çŠ¶æ€

**Q: è½®è¯¢ç»Ÿè®¡åœ¨å“ªé‡ŒæŸ¥çœ‹ï¼Ÿ**
A: æŸ¥çœ‹provideræ—¥å¿—ï¼ŒåŒ…å«è¯¦ç»†çš„keyä½¿ç”¨ç»Ÿè®¡

### è°ƒè¯•æ–¹æ³•
1. å¯ç”¨debugæ—¥å¿—ï¼š`"logLevel": "debug"`
2. æŸ¥çœ‹keyé€‰æ‹©æ—¥å¿—ç¡®è®¤è½®è¯¢æ˜¯å¦æ­£å¸¸
3. ç›‘æ§429é”™è¯¯å’Œé‡è¯•æƒ…å†µ
4. æ£€æŸ¥å„keyçš„æˆåŠŸç‡ç»Ÿè®¡

## ç¤ºä¾‹é…ç½®æ–‡ä»¶

å®Œæ•´çš„é…ç½®ç¤ºä¾‹è¯·å‚è€ƒï¼š`docs/api-key-rotation-config-example.json`