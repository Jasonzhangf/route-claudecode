# RCC v4.0 重构架构设计文档

## 1. 架构概述

RCC v4.0 采用清晰的职责分离架构，将系统分为五个核心组件：

1. **路由器 (Router)** - 负责模型到类别的映射和路由决策
2. **流水线组装器 (PipelineAssembler)** - 负责静态流水线的创建和管理
3. **负载均衡器 (LoadBalancer)** - 负责运行时流水线选择和负载均衡
4. **请求处理器 (RequestProcessor)** - 负责执行具体的请求处理
5. **协调器 (Orchestrator)** - 负责组件间的协调和整体生命周期管理

## 2. 组件职责详细说明

### 2.1 路由器 (Router)
**职责**：静态路由决策
- 将输入模型映射到模型类别
- 提供路由决策信息（可用流水线列表）
- 不参与运行时流水线选择
- 管理路由表状态

**生命周期**：系统启动时初始化，运行时只读

### 2.2 流水线组装器 (PipelineAssembler)
**职责**：静态流水线组装
- 系统启动时根据配置组装所有流水线
- 管理流水线的创建、销毁和查询
- 提供流水线实例的获取接口
- 不参与运行时请求处理

**生命周期**：系统启动时组装，系统停止时销毁

### 2.3 负载均衡器 (LoadBalancer)
**职责**：运行时负载均衡
- 根据路由决策选择具体的流水线
- 实现轮询、加权等负载均衡策略
- 管理流水线健康状态和错误处理
- 处理流水线的临时阻塞和黑名单

**生命周期**：运行时持续工作

### 2.4 请求处理器 (RequestProcessor)
**职责**：请求执行
- 执行选中的流水线处理请求
- 验证请求格式和参数
- 处理流水线执行结果
- 错误处理和重试机制

**生命周期**：运行时按需处理请求

### 2.5 协调器 (Orchestrator)
**职责**：系统协调
- 协调各组件的生命周期
- 处理组件间的通信和数据流转
- 提供统一的系统状态管理和监控
- 处理系统级事件和错误

**生命周期**：整个系统运行期间

## 3. 数据流向

```
客户端请求 → 协调器 → 路由器(路由决策) → 负载均衡器(选择流水线) → 请求处理器(执行) → 响应返回
     ↑                                                                      ↓
     └────────────────────────────────────────────────────────────────────────┘
```

详细流程：
1. 客户端发送请求到协调器
2. 协调器调用路由器进行路由决策，获取模型类别和可用流水线列表
3. 协调器调用负载均衡器从可用流水线中选择具体流水线
4. 协调器调用请求处理器执行选中的流水线
5. 请求处理器返回处理结果给协调器
6. 协调器返回响应给客户端

## 4. 生命周期管理

### 4.1 系统启动流程
```
1. 协调器.initialize()
   ├── 路由器初始化(加载路由表)
   ├── 流水线组装器初始化(组装所有流水线)
   ├── 负载均衡器初始化
   └── 请求处理器初始化

2. 协调器.start()
   ├── 启动各组件
   └── 系统进入运行状态
```

### 4.2 系统停止流程
```
1. 协调器.stop()
   ├── 停止请求处理
   └── 停止负载均衡

2. 协调器.cleanup()
   ├── 清理流水线资源
   └── 清理系统资源
```

## 5. 接口设计

所有组件都通过接口进行交互，确保松耦合和可测试性：

- `RouterInterface` - 路由器接口
- `PipelineAssemblerInterface` - 流水线组装器接口
- `LoadBalancerInterface` - 负载均衡器接口
- `RequestProcessorInterface` - 请求处理器接口
- `PipelineOrchestratorInterface` - 协调器接口

## 6. 错误处理和监控

### 6.1 零Fallback策略
- 任何组件失败都会立即抛出错误
- 不进行静默的备选路由
- 错误信息包含完整的上下文信息

### 6.2 健康检查
- 各组件定期进行健康检查
- 流水线状态实时更新到负载均衡器
- 失败流水线自动加入黑名单

### 6.3 监控和统计
- 各组件提供统计信息接口
- 协调器汇总系统级监控数据
- 性能指标实时收集和报告

## 7. 部署和扩展

### 7.1 部署模式
- 单体部署：所有组件运行在同一进程中
- 分布式部署：各组件可独立部署和扩展

### 7.2 扩展性
- 通过接口实现轻松替换组件
- 支持插件化添加新的路由策略
- 支持自定义负载均衡算法

## 8. 性能考虑

### 8.1 启动性能
- 流水线静态组装避免运行时开销
- 路由表预加载提高决策速度

### 8.2 运行时性能
- 负载均衡器缓存可用流水线列表
- 请求处理器优化流水线执行流程
- 协调器最小化组件间通信开销

## 9. 安全考虑

### 9.1 数据安全
- 敏感信息通过配置管理
- 请求处理过程中的数据隔离
- 流水线间的数据传输安全

### 9.2 访问控制
- 组件间通过接口访问控制
- 系统级权限管理
- 审计日志记录

## 10. 测试策略

### 10.1 单元测试
- 各组件独立的单元测试
- 接口契约测试
- 错误处理测试

### 10.2 集成测试
- 组件间集成测试
- 完整请求流程测试
- 性能基准测试

### 10.3 端到端测试
- 系统级功能测试
- 负载和压力测试
- 故障恢复测试