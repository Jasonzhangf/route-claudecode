# RCC v4.0 模块化文档总览

## 文档结构

本目录包含RCC v4.0系统的完整模块化文档，按照项目路径进行组织，每个模块都有独立的README文档。

## 模块架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   客户端模块     │───▶│   路由器模块     │───▶│  流水线Worker   │
│   (Client)      │    │   (Router)      │    │  (Pipeline)     │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │ CLI管理     │ │    │ │ 配置管理     │ │    │ │ Transformer │ │
│ │ 服务器管理   │ │    │ │ 请求路由     │ │    │ │ Protocol    │ │
│ │ 会话管理     │ │    │ │ 会话流控     │ │    │ │ Server-Comp │ │
│ │ 错误处理     │ │    │ │ 流水线管理   │ │    │ │ Server      │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                    支撑系统模块                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ Debug系统    │  │ 配置系统     │  │ 错误处理     │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   核心类型定义   │
                    │   (Types)       │
                    └─────────────────┘
```

## 会话流控架构图

```
Client Request (带会话信息)
        │
        ▼
┌─────────────────────────────────────────────────────────────────┐
│                      客户端模块                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   会话提取器     │  │   会话管理器     │  │   HTTP服务器     │  │
│  │                 │  │                 │  │                 │  │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │
│  │ │X-Session-ID │ │  │ │会话跟踪     │ │  │ │请求接收     │ │  │
│  │ │conversation │ │  │ │生命周期管理 │ │  │ │响应返回     │ │  │
│  │ │Token Hash   │ │  │ │统计信息     │ │  │ │错误处理     │ │  │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
        │ (sessionId, conversationId, requestId)
        ▼
┌─────────────────────────────────────────────────────────────────┐
│                      路由器模块                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │  会话流控管理器  │  │   请求路由器     │  │  流水线管理器    │  │
│  │                 │  │                 │  │                 │  │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │
│  │ │会话队列管理 │ │  │ │智能分类     │ │  │ │流水线选择   │ │  │
│  │ │对话内排队   │ │  │ │负载均衡     │ │  │ │健康检查     │ │  │
│  │ │优先级调度   │ │  │ │路由决策     │ │  │ │动态管理     │ │  │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
        │ (按session.conversation.request顺序处理)
        ▼
┌─────────────────────────────────────────────────────────────────┐
│                    流水线Worker池                                │
│                                                                 │
│  Session A.Conv1: req1 → req2 → req3 (串行处理)                 │
│  Session A.Conv2: req1 → req2 (串行处理)                        │
│  Session B.Conv1: req1 → req2 → req3 → req4 (串行处理)          │
│  Session C.Conv1: req1 (处理中)                                 │
│                                                                 │
│  不同会话和对话可以并行处理，同一对话内请求严格串行              │
└─────────────────────────────────────────────────────────────────┘
```

## 模块列表

### 1. 核心业务模块

#### [客户端模块 (Client)](./client/README.md)
- **路径**: `src/client/`
- **职责**: CLI命令处理、HTTP服务器管理、统一错误处理、会话管理
- **核心功能**: 
  - CLI命令系统 (`rcc start`, `rcc stop`, `rcc code`, `rcc status`)
  - HTTP服务器管理
  - 统一错误处理
  - 会话和对话ID提取管理

#### [路由器模块 (Router)](./router/README.md)
- **路径**: `src/router/`
- **职责**: 配置管理、请求路由、流水线生命周期管理、会话流控
- **核心功能**:
  - 配置管理系统
  - 智能请求路由
  - 流水线动态管理
  - 负载均衡
  - 会话流控系统 (基于session.conversationID.requestID)

#### [流水线Worker模块 (Pipeline)](./pipeline/README.md)
- **路径**: `src/pipeline/`
- **职责**: 核心处理单元，每个provider.model独立流水线
- **核心功能**:
  - 流水线框架
  - 动态创建和销毁
  - 模块化处理链

### 2. 流水线子模块

#### [Transformer模块](./pipeline/transformer/README.md)
- **路径**: `src/pipeline/modules/transformer/`
- **职责**: Anthropic格式与目标协议格式双向转换
- **支持协议**: OpenAI, Anthropic, Gemini
- **核心功能**: 格式转换、工具调用转换、流式处理

#### [Protocol模块](./pipeline/protocol/README.md)
- **路径**: `src/pipeline/modules/protocol/`
- **职责**: 协议控制转换，流式和非流式处理
- **核心功能**: 流式控制、协议验证、格式标准化

#### [Server-Compatibility模块](./pipeline/server-compatibility/README.md)
- **路径**: `src/pipeline/modules/server-compatibility/`
- **职责**: 第三方服务器兼容处理
- **支持服务**: OpenAI, DeepSeek, LMStudio, Gemini, Anthropic
- **核心功能**: 请求适配、响应适配、特殊处理

#### [Server模块](./pipeline/server/README.md)
- **路径**: `src/pipeline/modules/server/`
- **职责**: 与AI服务提供商的实际通信
- **SDK支持**: 优先使用官方SDK，回退到HTTP客户端
- **支持服务**: OpenAI, Anthropic, Gemini, LMStudio, Ollama, CodeWhisperer

### 3. 支撑系统模块

#### [Debug系统模块](./debug/README.md)
- **路径**: `src/debug/`
- **职责**: 完整的调试和回放功能
- **核心功能**:
  - Debug管理和控制
  - 数据记录和存储
  - 回放系统和单元测试生成

#### [配置系统模块](./config/README.md)
- **路径**: `src/config/`
- **职责**: 配置管理、验证、动态重载
- **核心功能**:
  - 配置加载和验证
  - 环境变量替换
  - 动态重载和监听

#### [标准API Error Handler系统](./error-handler/README.md)
- **路径**: `src/error-handler/`
- **职责**: 统一错误处理机制
- **核心功能**:
  - 标准错误格式
  - 错误分类和状态码映射
  - 敏感信息过滤

#### [核心类型定义模块](./types/README.md)
- **路径**: `src/types/`
- **职责**: 系统中所有模块共享的类型定义
- **核心功能**:
  - 核心类型定义
  - AI服务类型定义
  - 模块接口类型

### 4. 开发支持模块

#### [测试系统模块](./testing/README.md)
- **路径**: `src/__tests__/`
- **职责**: 完整的测试框架和质量保证
- **核心功能**:
  - 单元测试、集成测试、端到端测试
  - 真实流水线测试（禁止Mock）
  - 回放测试和性能测试
  - 测试数据管理和覆盖率报告

#### [开发调试系统](./development/README.md)
- **路径**: `scripts/dev/`, `scripts/debug/`
- **职责**: 开发环境支持和调试工具
- **核心功能**:
  - 开发环境设置和热重载
  - 调试命令和日志管理
  - cURL测试脚本和调试会话管理
  - 文件命名规则和临时文件管理

#### [编译构建系统](./build/README.md)
- **路径**: `scripts/build/`
- **职责**: 完整的构建流程和部署支持
- **核心功能**:
  - TypeScript编译和Webpack打包
  - 一键构建和一键启动脚本
  - 代码质量检查和构建验证
  - 构建报告和性能分析

#### [CLI扩展命令模块](./cli-extensions/README.md)
- **路径**: `src/cli-extensions/`
- **职责**: 高级CLI功能和智能化管理
- **核心功能**:
  - `rcc provider update` - 自动更新Provider配置
  - 模型发现和Token限制测试
  - 黑名单和白名单管理
  - 长上下文模型自动选择

## 模块间依赖关系

### 依赖层级
```
Level 1: 核心类型定义 (types)
         ↑
Level 2: 支撑系统 (error-handler, config, debug)
         ↑
Level 3: 流水线子模块 (transformer, protocol, server-compatibility, server)
         ↑
Level 4: 核心业务模块 (pipeline, router)
         ↑
Level 5: 客户端模块 (client, cli-extensions)
         ↑
Level 6: 开发支持模块 (testing, development, build)
```

### 依赖规则
- **向上依赖**: 高层级模块可以依赖低层级模块
- **禁止循环依赖**: 任何模块不能形成循环依赖
- **接口通信**: 模块间只能通过定义的接口通信
- **物理隔离**: 每个模块物理上存在于独立的文件夹中

## 质量标准

### 模块交付检查标准
每个模块完成交付时必须通过以下检查：
- ✅ 是否有静默失败？（必须无静默失败）
- ✅ 是否有mockup响应？（必须无mockup响应）
- ✅ 是否有重复代码？（必须无重复代码）
- ✅ 是否有硬编码实现？（必须无硬编码实现）

### 模块设计基本要求
1. **功能不重叠**: 每个模块的功能彼此不覆盖，职责单一明确
2. **标准接口**: 模块间通过标准接口连接，不允许直接调用内部方法
3. **物理隔离**: 每个模块物理上存在于独立的文件夹中
4. **文档完整**: 每个模块文件夹内必须有README说明功能和接口
5. **数据校验**: 每个模块的输入输出都有标准的数据校验方式
6. **错误处理**: 输入输出有问题时第一时间调用error handler处理
7. **禁止Mockup**: 严禁mockup响应，这是最高优先级要求

## 开发指南

### 新模块开发流程
1. **需求分析**: 明确模块职责和边界
2. **接口设计**: 定义标准接口和类型
3. **文档编写**: 编写模块README文档
4. **实现开发**: 按照质量标准实现功能
5. **测试验证**: 进行真实流水线测试
6. **质量检查**: 通过模块交付检查标准
7. **集成测试**: 与其他模块集成测试

### 模块修改流程
1. **影响分析**: 分析修改对其他模块的影响
2. **接口兼容**: 确保接口向后兼容
3. **文档更新**: 更新相关文档
4. **测试验证**: 进行回归测试
5. **版本管理**: 适当更新版本号

## 实现优先级

### Phase 1: 基础架构 (Week 1-2)
1. **核心类型定义**: 建立类型系统基础
2. **标准API Error Handler**: 统一错误处理机制
3. **配置系统**: 基础配置管理

### Phase 2: 核心模块 (Week 2-4)
4. **客户端模块**: CLI和HTTP服务器
5. **路由器模块**: 请求路由和流水线管理
6. **流水线框架**: 基础流水线架构

### Phase 3: 流水线子模块 (Week 4-6)
7. **Transformer模块**: 格式转换
8. **Protocol模块**: 协议处理
9. **Server-Compatibility模块**: 兼容性处理
10. **Server模块**: 网络通信

### Phase 4: 支撑系统 (Week 6-7)
11. **Debug系统**: 调试和回放功能
12. **CLI扩展**: Provider自动更新和智能管理

### Phase 5: 开发支持系统 (Week 7-8)
13. **测试系统**: 完整的测试框架
14. **开发调试系统**: 开发工具和调试支持
15. **编译构建系统**: 构建流程和部署脚本

### Phase 6: 集成测试和优化 (Week 8-9)
16. **集成测试**: 端到端测试
17. **性能优化**: 系统性能调优
18. **文档完善**: 完善所有文档

## 维护指南

### 日常维护
- **配置更新**: 定期检查和更新配置文件
- **日志监控**: 监控错误日志和性能指标
- **健康检查**: 定期检查各模块健康状态
- **依赖更新**: 及时更新依赖包和SDK

### 故障排查
- **错误追踪**: 使用Debug系统追踪错误
- **日志分析**: 分析错误日志定位问题
- **回放测试**: 使用回放功能重现问题
- **模块隔离**: 逐个模块排查问题

### 性能优化
- **监控指标**: 监控关键性能指标
- **瓶颈分析**: 识别性能瓶颈
- **缓存优化**: 合理使用缓存机制
- **资源管理**: 优化内存和连接使用

这个模块化文档结构为RCC v4.0的开发、维护和扩展提供了完整的指导框架。