# ç²¾å‡†æµæ°´çº¿æ‹‰é»‘æœºåˆ¶è®¾è®¡

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

åŸºäºç”¨æˆ·éœ€æ±‚è®¾è®¡çš„ç²¾å‡†æµæ°´çº¿æ‹‰é»‘ç®¡ç†ç³»ç»Ÿï¼Œç¡®ä¿åœ¨é‡åˆ°å„ç§APIé”™è¯¯æ—¶é‡‡å–åˆé€‚çš„å¤„ç†ç­–ç•¥ï¼Œé¿å…è¿‡åº¦æ‹‰é»‘å’Œèµ„æºæµªè´¹ã€‚

## ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. æ‰‹åŠ¨é…ç½®ä¼˜å…ˆ
- **é•¿æœŸæ‹‰é»‘å¿…é¡»æ‰‹åŠ¨é…ç½®** - ç¦æ­¢ä»»ä½•è‡ªåŠ¨é•¿æœŸæ‹‰é»‘è¡Œä¸º
- **é”€æ¯è§„åˆ™éœ€æ˜¾å¼å¯ç”¨** - æ‰€æœ‰é”€æ¯è§„åˆ™é»˜è®¤disabledï¼Œéœ€è¦ç®¡ç†å‘˜æ‰‹åŠ¨å¯ç”¨

### 2. ä¸¤ç§å¤„ç†æ¨¡å¼
- **ç«‹å³é”€æ¯æ¨¡å¼**: 402ä½™é¢ä¸è¶³ã€401è®¤è¯å¤±è´¥ â†’ ç«‹å³é”€æ¯æµæ°´çº¿ï¼Œä¸‹æ¬¡å¯åŠ¨é‡å»º
- **çŸ­æœŸæ‹‰é»‘æ¨¡å¼**: 429æµæ§ â†’ 1åˆ†é’Ÿç¦ç”¨ï¼Œè®°å½•å†å²ï¼Œè¿ç»­3æ¬¡åé”€æ¯

### 3. ç²¾å‡†é”™è¯¯è¯†åˆ«
- **çŠ¶æ€ç  + é”™è¯¯æ¶ˆæ¯æ¨¡å¼åŒ¹é…** - é¿å…è¯¯åˆ¤
- **å¯é…ç½®é”™è¯¯æ¨¡å¼** - æ”¯æŒçµæ´»çš„é”™è¯¯è¯†åˆ«è§„åˆ™

## ğŸ”’ é”™è¯¯åˆ†ç±»å’Œå¤„ç†ç­–ç•¥

### ç«‹å³é”€æ¯é”™è¯¯ (éœ€æ‰‹åŠ¨é…ç½®)

| çŠ¶æ€ç  | é”™è¯¯æ¨¡å¼ | å¤„ç†ç­–ç•¥ | é»˜è®¤çŠ¶æ€ |
|--------|----------|----------|----------|
| 402 | payment, balance, credit, quota | ç«‹å³é”€æ¯ | disabled |
| 401 | invalid api key, unauthorized, authentication | ç«‹å³é”€æ¯ | disabled |
| 403 | forbidden, banned, suspended, account disabled | ç«‹å³é”€æ¯ | disabled |

### çŸ­æœŸæ‹‰é»‘é”™è¯¯ (è‡ªåŠ¨å¤„ç†)

| çŠ¶æ€ç  | å¤„ç†ç­–ç•¥ | æ‹‰é»‘æ—¶é•¿ | å¤±è´¥é˜ˆå€¼ |
|--------|----------|----------|----------|
| 429 | ä¸´æ—¶æ‹‰é»‘ | 1åˆ†é’Ÿ | è¿ç»­3æ¬¡é”€æ¯ |

### æ­£å¸¸é‡è¯•é”™è¯¯ (ä¸æ‹‰é»‘)

| çŠ¶æ€ç /é”™è¯¯ | å¤„ç†ç­–ç•¥ |
|------------|----------|
| 500, 502, 503 | æ­£å¸¸é‡è¯•æœºåˆ¶ |
| ECONNRESET, ETIMEDOUT | æ­£å¸¸é‡è¯•æœºåˆ¶ |
| å…¶ä»–ç½‘ç»œé”™è¯¯ | æ­£å¸¸é‡è¯•æœºåˆ¶ |

## ğŸ›  æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶

1. **PrecisePipelineBlacklistManager** - æ ¸å¿ƒæ‹‰é»‘é€»è¾‘ç®¡ç†å™¨
2. **BlacklistConfigValidator** - é…ç½®éªŒè¯å™¨
3. **RateLimitCounter** - 429é”™è¯¯è®¡æ•°å™¨
4. **PersistenceManager** - æŒä¹…åŒ–å­˜å‚¨ç®¡ç†

### æ•°æ®ç»“æ„

```typescript
interface BlacklistConfig {
  enabled: boolean;
  persistenceFile: string;
  destroyRules: DestroyRule[];
  rateLimitRule: RateLimitRule;
}

interface DestroyRule {
  statusCode: number;
  errorPatterns: string[];
  enabled: boolean; // å¿…é¡»æ‰‹åŠ¨è®¾ç½®ä¸ºtrue
  description: string;
}

interface RateLimitRule {
  statusCode: 429;
  blockDuration: number; // æ¯«ç§’
  maxConsecutiveFailures: number;
  resetInterval: number;
}
```

### å¤„ç†æµç¨‹

1. **é”™è¯¯å‘ç”Ÿ** â†’ é”™è¯¯åˆ†ç±»è¯†åˆ«
2. **åŒ¹é…é”€æ¯è§„åˆ™** â†’ æ£€æŸ¥æ˜¯å¦æ‰‹åŠ¨å¯ç”¨
3. **æ‰§è¡Œå¯¹åº”ç­–ç•¥** â†’ é”€æ¯/ä¸´æ—¶æ‹‰é»‘/æ­£å¸¸é‡è¯•
4. **æŒä¹…åŒ–çŠ¶æ€** â†’ ä¿å­˜æ‹‰é»‘ä¿¡æ¯
5. **æ—¥å¿—è®°å½•** â†’ å®Œæ•´çš„æ“ä½œå®¡è®¡

## ğŸ“ é…ç½®æ–‡ä»¶è§„èŒƒ

```json
{
  "pipeline": {
    "blacklist": {
      "enabled": true,
      "persistenceFile": "./data/pipeline-blacklist.json",
      
      "destroyRules": [
        {
          "statusCode": 402,
          "errorPatterns": ["payment", "balance", "credit", "quota", "billing"],
          "enabled": false,
          "description": "è´¦æˆ·ä½™é¢ä¸è¶³æˆ–é…é¢ç”¨å°½ - éœ€è¦æ‰‹åŠ¨å¯ç”¨",
          "adminNote": "å¯ç”¨å‰è¯·ç¡®è®¤è¿™æ˜¯æœŸæœ›çš„è¡Œä¸º"
        },
        {
          "statusCode": 401,
          "errorPatterns": ["invalid api key", "unauthorized", "authentication failed"],
          "enabled": false,
          "description": "è®¤è¯å¤±è´¥æˆ–API Keyæ— æ•ˆ - éœ€è¦æ‰‹åŠ¨å¯ç”¨"
        },
        {
          "statusCode": 403,
          "errorPatterns": ["forbidden", "banned", "suspended", "account disabled"],
          "enabled": false,
          "description": "è´¦æˆ·è¢«å°ç¦æˆ–æš‚åœ - éœ€è¦æ‰‹åŠ¨å¯ç”¨"
        }
      ],

      "rateLimitRule": {
        "statusCode": 429,
        "blockDuration": 60000,
        "maxConsecutiveFailures": 3,
        "resetInterval": 300000,
        "description": "429æµæ§å¤„ç†ï¼š1åˆ†é’Ÿæ‹‰é»‘ï¼Œ3æ¬¡åé”€æ¯"
      }
    }
  }
}
```

## ğŸ”§ é›†æˆç‚¹

### 1. Pipelineè¯·æ±‚å¤„ç†å™¨é›†æˆ
- åœ¨processServerLayerä¸­æ£€æŸ¥æµæ°´çº¿çŠ¶æ€
- æ ¹æ®é”™è¯¯ç±»å‹æ‰§è¡Œç›¸åº”ç­–ç•¥
- è®°å½•è¯¦ç»†çš„æ“ä½œæ—¥å¿—

### 2. æµæ°´çº¿ç®¡ç†å™¨é›†æˆ
- æä¾›æµæ°´çº¿é”€æ¯æ¥å£
- æ”¯æŒæµæ°´çº¿é‡å»ºæœºåˆ¶
- çŠ¶æ€æŸ¥è¯¢å’Œç›‘æ§

### 3. CLIå‘½ä»¤é›†æˆ
- é…ç½®ç®¡ç†å‘½ä»¤
- çŠ¶æ€æŸ¥è¯¢å‘½ä»¤
- æ‰‹åŠ¨å¹²é¢„å‘½ä»¤

## ğŸ® ç®¡ç†å‘½ä»¤

```bash
# æŸ¥çœ‹æ‹‰é»‘é…ç½®çŠ¶æ€
rcc4 blacklist config

# å¯ç”¨é”€æ¯è§„åˆ™ (éœ€è¦æ˜ç¡®ç¡®è®¤)
rcc4 blacklist enable-destroy 402 --confirm

# ç¦ç”¨é”€æ¯è§„åˆ™
rcc4 blacklist disable-destroy 402

# æŸ¥çœ‹æ‰€æœ‰æµæ°´çº¿æ‹‰é»‘çŠ¶æ€
rcc4 blacklist status

# æŸ¥çœ‹ç‰¹å®šæµæ°´çº¿çŠ¶æ€
rcc4 blacklist status <pipelineId>

# æ‰‹åŠ¨è§£é™¤ä¸´æ—¶æ‹‰é»‘
rcc4 blacklist unblock <pipelineId>

# é‡ç½®429è®¡æ•°å™¨
rcc4 blacklist reset-counter <pipelineId>

# æ¸…ç†è¿‡æœŸæ¡ç›®
rcc4 blacklist cleanup

# å¯¼å…¥/å¯¼å‡ºæ‹‰é»‘æ•°æ®
rcc4 blacklist export --file backup.json
rcc4 blacklist import --file backup.json
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### å…³é”®æ—¥å¿—äº‹ä»¶
- æµæ°´çº¿é”€æ¯äº‹ä»¶
- ä¸´æ—¶æ‹‰é»‘äº‹ä»¶
- æ‹‰é»‘è§£é™¤äº‹ä»¶
- é…ç½®å˜æ›´äº‹ä»¶

### ç»Ÿè®¡ä¿¡æ¯
- å„ç±»é”™è¯¯çš„å¤„ç†ç»Ÿè®¡
- æµæ°´çº¿é”€æ¯åŸå› åˆ†æ
- 429é”™è¯¯æ¢å¤æˆåŠŸç‡

## ğŸš€ å®ç°ä¼˜å…ˆçº§

1. **Phase 1**: æ ¸å¿ƒæ‹‰é»‘ç®¡ç†å™¨å®ç°
2. **Phase 2**: é…ç½®éªŒè¯å’ŒæŒä¹…åŒ–
3. **Phase 3**: é›†æˆåˆ°pipelineå¤„ç†å™¨
4. **Phase 4**: CLIå‘½ä»¤å’Œç®¡ç†æ¥å£
5. **Phase 5**: ç›‘æ§å’Œç»Ÿè®¡åŠŸèƒ½

## âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **é…ç½®å®‰å…¨**: é”€æ¯è§„åˆ™å¿…é¡»æ˜¾å¼å¯ç”¨ï¼Œé˜²æ­¢æ„å¤–é”€æ¯
2. **æ•°æ®æŒä¹…åŒ–**: ç¡®ä¿æ‹‰é»‘çŠ¶æ€åœ¨é‡å¯åæ­£ç¡®æ¢å¤
3. **æ—¥å¿—å®¡è®¡**: è®°å½•æ‰€æœ‰æ‹‰é»‘ç›¸å…³æ“ä½œï¼Œä¾¿äºè¿½æº¯
4. **æƒé™æ§åˆ¶**: ç®¡ç†å‘½ä»¤éœ€è¦é€‚å½“çš„æƒé™æ£€æŸ¥

## ğŸ¯ æˆåŠŸæ ‡å‡†

- âœ… 402é”™è¯¯å¯¼è‡´æµæ°´çº¿ç«‹å³é”€æ¯ï¼ˆæ‰‹åŠ¨å¯ç”¨åï¼‰
- âœ… 429é”™è¯¯å®ç°1åˆ†é’Ÿä¸´æ—¶æ‹‰é»‘
- âœ… è¿ç»­3æ¬¡429é”™è¯¯é”€æ¯æµæ°´çº¿
- âœ… é‡å¯åä¿æŒæ‹‰é»‘çŠ¶æ€
- âœ… æä¾›å®Œæ•´çš„CLIç®¡ç†ç•Œé¢
- âœ… è¯¦ç»†çš„æ“ä½œæ—¥å¿—å’Œå®¡è®¡è®°å½•

è¿™ä¸ªè®¾è®¡ç¡®ä¿äº†æµæ°´çº¿æ‹‰é»‘æœºåˆ¶çš„ç²¾ç¡®æ€§ã€å¯æ§æ€§å’Œå®‰å…¨æ€§ï¼Œæ»¡è¶³äº†ç”¨æˆ·å¯¹æ‰‹åŠ¨é…ç½®å’Œç²¾å‡†å¤„ç†çš„è¦æ±‚ã€‚