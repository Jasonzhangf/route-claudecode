# ğŸ—ï¸ æµæ°´çº¿æ¶æ„è§„åˆ™ (Pipeline Architecture Rules) - v3.0 æ­£ç¡®ç‰ˆ

## ğŸ¯ æ ¸å¿ƒæ¶æ„åŸåˆ™

### æ­£ç¡®çš„æµæ°´çº¿æ¶æ„ç†è§£
**é‡è¦**: æµæ°´çº¿æ˜¯è¿è¡Œæ—¶æ‰§è¡Œæµç¨‹ï¼Œä¸æ˜¯ç›®å½•ç»“æ„ï¼

#### âœ… æ­£ç¡®ç†è§£
```
é…ç½®é©±åŠ¨ â†’ å®ä½“åˆ›å»º â†’ è¿è¡Œæ—¶æ³¨å†Œ â†’ 8æ­¥ä¸šåŠ¡æ‰§è¡Œ â†’ è°ƒç”¨åŠŸèƒ½æ¨¡å—
    â†“         â†“         â†“           â†“          â†“
è·¯ç”±å™¨é…ç½®   Pipeline   Stepæ³¨å†Œ    ä¸šåŠ¡æµç¨‹    src/input/
          å®ä½“ç®¡ç†å™¨    Registry    Executor   src/transformers/
                                            src/providers/
                                            src/routing/
```

#### âŒ é”™è¯¯ç†è§£ (å·²çº æ­£)
```
âŒ src/pipeline/step1-input-processing/    # é”™è¯¯ï¼šé™æ€ç›®å½•ç»“æ„
âŒ src/pipeline/step2-preprocessing/       # é”™è¯¯ï¼šæŒ‰æ­¥éª¤ç»„ç»‡æ–‡ä»¶
âŒ src/pipeline/step3-routing/             # é”™è¯¯ï¼šæ··æ·†æ‰§è¡Œæµç¨‹å’Œæ–‡ä»¶ç»„ç»‡
```

## ğŸ“ æ­£ç¡®çš„ç›®å½•ç»“æ„ (Correct Directory Structure)

### åŠŸèƒ½æ¨¡å—ç»„ç»‡ (ä¿æŒåŸæœ‰æ¶æ„)
```
src/
â”œâ”€â”€ input/                              # è¾“å…¥å¤„ç†åŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ anthropic/
â”‚   â”‚   â”œâ”€â”€ processor.ts
â”‚   â”‚   â””â”€â”€ validator.ts
â”‚   â”œâ”€â”€ openai/
â”‚   â”‚   â””â”€â”€ processor.ts
â”‚   â””â”€â”€ universal-input-processor.ts
â”‚
â”œâ”€â”€ transformers/                       # è½¬æ¢åŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ openai.ts
â”‚   â”œâ”€â”€ anthropic.ts
â”‚   â”œâ”€â”€ gemini.ts
â”‚   â””â”€â”€ manager.ts
â”‚
â”œâ”€â”€ providers/                          # æä¾›å•†åŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ openai/
â”‚   â”‚   â”œâ”€â”€ client.ts
â”‚   â”‚   â”œâ”€â”€ enhanced-client.ts
â”‚   â”‚   â””â”€â”€ client-factory.ts
â”‚   â”œâ”€â”€ anthropic/
â”‚   â”œâ”€â”€ gemini/
â”‚   â””â”€â”€ codewhisperer/
â”‚
â”œâ”€â”€ routing/                            # è·¯ç”±åŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ engine.ts
â”‚   â”œâ”€â”€ provider-expander.ts
â”‚   â””â”€â”€ index.ts
â”‚
â”œâ”€â”€ patches/                            # è¡¥ä¸åŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ openai/
â”‚   â”œâ”€â”€ anthropic/
â”‚   â””â”€â”€ gemini/
â”‚
â”œâ”€â”€ preprocessing/                      # é¢„å¤„ç†åŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ modular-preprocessing-manager.ts
â”‚   â””â”€â”€ parsers/
â”‚
â””â”€â”€ pipeline/                           # âœ… è¿è¡Œæ—¶æµæ°´çº¿ç³»ç»Ÿ
    â”œâ”€â”€ registry.ts                     # æ­¥éª¤æ³¨å†Œæœºåˆ¶
    â”œâ”€â”€ executor.ts                     # 8æ­¥æ‰§è¡Œå¼•æ“
    â”œâ”€â”€ entity-manager.ts               # é…ç½®é©±åŠ¨å®ä½“ç®¡ç†
    â”œâ”€â”€ index.ts                        # ä¸»å…¥å£
    â””â”€â”€ steps/                          # æ­¥éª¤å®ç°
        â”œâ”€â”€ openai-input-processing-step.ts
        â”œâ”€â”€ openai-api-interaction-step.ts
        â””â”€â”€ [å…¶ä»–æ­¥éª¤å®ç°]
```

## ğŸ”„ è¿è¡Œæ—¶æµæ°´çº¿æœºåˆ¶ (Runtime Pipeline Mechanism)

### 1. é…ç½®é©±åŠ¨å®ä½“åˆ›å»º
```typescript
// è·¯ç”±å™¨é…ç½®å†³å®šå®ä½“æ•°é‡
interface RouterConfig {
  entities: [
    { configPath: "/config/openai-5501.json", provider: "openai", active: true },
    { configPath: "/config/gemini-5502.json", provider: "gemini", active: true },
    { configPath: "/config/multi-provider.json", provider: "mixed", active: true }
  ]
}

// æ¯ä¸ªé…ç½®åˆ›å»ºä¸€ä¸ªå®ä½“ï¼Œæ¯ä¸ªå®ä½“æœ‰è‡ªå·±çš„æµæ°´çº¿
Entity1 (OpenAI) â†’ 8æ­¥æ‰§è¡Œæµç¨‹ â†’ è°ƒç”¨src/input/, src/providers/openai/, etc.
Entity2 (Gemini) â†’ 8æ­¥æ‰§è¡Œæµç¨‹ â†’ è°ƒç”¨src/input/, src/providers/gemini/, etc.
Entity3 (Mixed)  â†’ 8æ­¥æ‰§è¡Œæµç¨‹ â†’ è°ƒç”¨å¤šä¸ªåŠŸèƒ½æ¨¡å—
```

### 2. è¿è¡Œæ—¶æ³¨å†Œæœºåˆ¶
```typescript
const registry = getPipelineRegistry();

// æ³¨å†Œæ­¥éª¤å®ç°ï¼ˆè¿è¡Œæ—¶ï¼‰
registry.registerStep('openai-input-processing', OpenAIInputProcessingStep);
registry.registerStep('openai-api-interaction', OpenAIAPIInteractionStep);

// åˆ›å»ºå®ä½“ï¼ˆè¿è¡Œæ—¶ï¼‰
const entityId = await registry.createEntity(configPath, provider);

// æ¿€æ´»å®ä½“æµæ°´çº¿
registry.activateEntity(entityId);
```

### 3. 8æ­¥ä¸šåŠ¡æ‰§è¡Œæµç¨‹
```typescript
// ä¸šåŠ¡æ‰§è¡Œé¡ºåºï¼ˆè¿è¡Œæ—¶è°ƒç”¨åŠŸèƒ½æ¨¡å—ï¼‰
Step 1: Input Processing     â†’ è°ƒç”¨ src/input/[provider]/processor.ts
Step 2: Input Preprocessing  â†’ è°ƒç”¨ src/preprocessing/[modules].ts  
Step 3: Routing             â†’ è°ƒç”¨ src/routing/engine.ts
Step 4: Request Transform   â†’ è°ƒç”¨ src/transformers/[provider].ts
Step 5: API Interaction     â†’ è°ƒç”¨ src/providers/[provider]/client.ts
Step 6: Response Preprocess â†’ è°ƒç”¨ src/patches/[provider]/[fixes].ts
Step 7: Response Transform  â†’ è°ƒç”¨ src/transformers/[provider].ts
Step 8: Output Processing   â†’ è°ƒç”¨ src/output/[provider]/processor.ts
```
â”‚   â”‚   â”œâ”€â”€ anthropic/
â”‚   â”‚   â”œâ”€â”€ gemini/
â”‚   â”‚   â””â”€â”€ unified/
â”‚   â”‚       â””â”€â”€ universal-input-processor.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ step2-input-preprocessing/      # è¾“å…¥é¢„å¤„ç†
â”‚   â”‚   â”œâ”€â”€ openai/
â”‚   â”‚   â”‚   â”œâ”€â”€ preprocess-manager.ts   # é¢„å¤„ç†ç®¡ç†å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ openai-parser.ts        # OpenAIè§£æå™¨
â”‚   â”‚   â”‚   â””â”€â”€ data-capture.ts         # Step2æ•°æ®æ•è·
â”‚   â”‚   â”œâ”€â”€ patches/
â”‚   â”‚   â”‚   â””â”€â”€ openai/                 # OpenAIè¡¥ä¸é›†åˆ
â”‚   â”‚   â””â”€â”€ unified/
â”‚   â”‚
â”‚   â”œâ”€â”€ step3-routing/                  # è·¯ç”±å†³ç­–
â”‚   â”‚   â”œâ”€â”€ openai/
â”‚   â”‚   â”‚   â”œâ”€â”€ routing-logic.ts        # OpenAIè·¯ç”±é€»è¾‘
â”‚   â”‚   â”‚   â””â”€â”€ data-capture.ts         # Step3æ•°æ®æ•è·
â”‚   â”‚   â””â”€â”€ unified/
â”‚   â”‚       â”œâ”€â”€ engine.ts               # è·¯ç”±å¼•æ“
â”‚   â”‚       â””â”€â”€ provider-expander.ts    # Provideræ‰©å±•å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ step4-request-transformation/   # è¯·æ±‚è½¬æ¢
â”‚   â”‚   â”œâ”€â”€ openai/
â”‚   â”‚   â”‚   â”œâ”€â”€ transformer.ts          # OpenAIè½¬æ¢å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ format-converter.ts     # æ ¼å¼è½¬æ¢å™¨
â”‚   â”‚   â”‚   â””â”€â”€ data-capture.ts         # Step4æ•°æ®æ•è·
â”‚   â”‚   â”œâ”€â”€ anthropic/
â”‚   â”‚   â”œâ”€â”€ gemini/
â”‚   â”‚   â””â”€â”€ unified/
â”‚   â”‚       â””â”€â”€ manager.ts              # è½¬æ¢ç®¡ç†å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ step5-api-interaction/          # APIäº¤äº’
â”‚   â”‚   â”œâ”€â”€ openai/
â”‚   â”‚   â”‚   â”œâ”€â”€ client-factory.ts       # å®¢æˆ·ç«¯å·¥å‚
â”‚   â”‚   â”‚   â”œâ”€â”€ pure-client.ts          # çº¯å®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”œâ”€â”€ sdk-client.ts           # SDKå®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”œâ”€â”€ enhanced-api-key-manager.ts # APIå¯†é’¥ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ data-capture.ts         # Step5æ•°æ®æ•è·
â”‚   â”‚   â”œâ”€â”€ anthropic/
â”‚   â”‚   â”œâ”€â”€ codewhisperer/
â”‚   â”‚   â”œâ”€â”€ gemini/
â”‚   â”‚   â””â”€â”€ common/
â”‚   â”‚       â””â”€â”€ universal-streaming-parser.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ step6-response-preprocessing/   # å“åº”é¢„å¤„ç†
â”‚   â”‚   â”œâ”€â”€ openai/
â”‚   â”‚   â”‚   â”œâ”€â”€ response-parser.ts      # å“åº”è§£æå™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ buffered-processor.ts   # ç¼“å†²å¤„ç†å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ universal-openai-parser.ts # é€šç”¨è§£æå™¨
â”‚   â”‚   â”‚   â””â”€â”€ data-capture.ts         # Step6æ•°æ®æ•è·
â”‚   â”‚   â”œâ”€â”€ patches/
â”‚   â”‚   â”‚   â””â”€â”€ openai/
â”‚   â”‚   â”‚       â”œâ”€â”€ streaming-tool-format-fix.ts
â”‚   â”‚   â”‚       â”œâ”€â”€ tool-format-fix.ts
â”‚   â”‚   â”‚       â””â”€â”€ modelscope-format-fix.ts
â”‚   â”‚   â””â”€â”€ unified/
â”‚   â”‚
â”‚   â”œâ”€â”€ step7-response-transformation/  # å“åº”è½¬æ¢
â”‚   â”‚   â”œâ”€â”€ openai/
â”‚   â”‚   â”‚   â”œâ”€â”€ response-transformer.ts # å“åº”è½¬æ¢å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ response-converter.ts   # å“åº”è½¬æ¢å™¨
â”‚   â”‚   â”‚   â””â”€â”€ data-capture.ts         # Step7æ•°æ®æ•è·
â”‚   â”‚   â”œâ”€â”€ anthropic/
â”‚   â”‚   â”œâ”€â”€ gemini/
â”‚   â”‚   â””â”€â”€ unified/
â”‚   â”‚       â”œâ”€â”€ streaming.ts            # æµå¼å¤„ç†
â”‚   â”‚       â””â”€â”€ manager.ts              # è½¬æ¢ç®¡ç†å™¨
â”‚   â”‚
â”‚   â””â”€â”€ step8-output-processing/        # è¾“å‡ºå¤„ç†
â”‚       â”œâ”€â”€ openai/
â”‚       â”‚   â”œâ”€â”€ output-processor.ts     # è¾“å‡ºå¤„ç†å™¨
â”‚       â”‚   â”œâ”€â”€ output-validator.ts     # è¾“å‡ºéªŒè¯å™¨
â”‚       â”‚   â””â”€â”€ data-capture.ts         # Step8æ•°æ®æ•è·
â”‚       â”œâ”€â”€ anthropic/
â”‚       â””â”€â”€ unified/
â”‚           â””â”€â”€ output-manager.ts       # è¾“å‡ºç®¡ç†å™¨
â”‚
â”œâ”€â”€ database/
â”‚   â””â”€â”€ pipeline-data-capture/          # æµæ°´çº¿æ•°æ®æ•è·ç³»ç»Ÿ
â”‚       â”œâ”€â”€ unified-pipeline-capture.ts # ç»Ÿä¸€æ•°æ®æ•è·ç®¡ç†å™¨
â”‚       â”œâ”€â”€ step1-data-capture.ts       # Step1ä¸“ç”¨æ•è·
â”‚       â”œâ”€â”€ step2-data-capture.ts       # Step2ä¸“ç”¨æ•è·
â”‚       â”œâ”€â”€ step4-data-capture.ts       # Step4ä¸“ç”¨æ•è·
â”‚       â”œâ”€â”€ step5-data-capture.ts       # Step5ä¸“ç”¨æ•è·
â”‚       â””â”€â”€ openai-pipeline-integration.ts # OpenAIæµæ°´çº¿é›†æˆ
â”‚
â””â”€â”€ types/
    â””â”€â”€ pipeline.ts                     # æµæ°´çº¿ç±»å‹å®šä¹‰
```

### Legacyä»£ç ç®¡ç†
```
src/
â””â”€â”€ legacy/                             # å¾…è¿ç§»çš„æ—§ä»£ç 
    â”œâ”€â”€ transformers/                   # æ—§è½¬æ¢å™¨ â†’ è¿ç§»åˆ°step4,step7
    â”œâ”€â”€ providers/                      # æ—§Provider â†’ è¿ç§»åˆ°step5
    â”œâ”€â”€ preprocessing/                  # æ—§é¢„å¤„ç† â†’ è¿ç§»åˆ°step2,step6
    â””â”€â”€ input/                         # æ—§è¾“å…¥å¤„ç† â†’ è¿ç§»åˆ°step1
```

## ğŸ”„ æ¨¡å—èŒè´£å®šä¹‰ (Module Responsibilities)

### Step 1: Input Processing (è¾“å…¥å¤„ç†)
- **ä¸»è¦èŒè´£**: APIè¯·æ±‚æ¥æ”¶ã€æ ¼å¼åˆæ­¥éªŒè¯ã€requestIdåˆ†é…
- **è¾“å…¥**: åŸå§‹HTTPè¯·æ±‚
- **è¾“å‡º**: æ ‡å‡†åŒ–è¾“å…¥å¯¹è±¡ + Step1æ•°æ®æ•è·
- **OpenAIç‰¹å®š**: OpenAIæ ¼å¼è¯·æ±‚è§£æå’ŒéªŒè¯
- **æ•°æ®æ•è·**: è¯·æ±‚åˆ†æã€éªŒè¯ç»“æœã€æ€§èƒ½æŒ‡æ ‡

### Step 2: Input Preprocessing (è¾“å…¥é¢„å¤„ç†)  
- **ä¸»è¦èŒè´£**: è¡¥ä¸æ£€æµ‹ã€å·¥å…·è°ƒç”¨è¯†åˆ«ã€è¾“å…¥æ ¼å¼ä¿®å¤
- **è¾“å…¥**: æ ‡å‡†åŒ–è¾“å…¥å¯¹è±¡
- **è¾“å‡º**: é¢„å¤„ç†åè¾“å…¥å¯¹è±¡ + Step2æ•°æ®æ•è·
- **OpenAIç‰¹å®š**: OpenAIç‰¹æ®Šæ ¼å¼å¤„ç†ã€å·¥å…·è°ƒç”¨é¢„å¤„ç†
- **æ•°æ®æ•è·**: è¡¥ä¸åº”ç”¨è®°å½•ã€å·¥å…·è°ƒç”¨ç»Ÿè®¡ã€æ ¼å¼ä¿®å¤è®°å½•

### Step 3: Routing (è·¯ç”±å†³ç­–)
- **ä¸»è¦èŒè´£**: æ¨¡å‹è·¯ç”±ã€Provideré€‰æ‹©ã€è´Ÿè½½å‡è¡¡
- **è¾“å…¥**: é¢„å¤„ç†åè¾“å…¥å¯¹è±¡
- **è¾“å‡º**: è·¯ç”±å†³ç­–å¯¹è±¡ + Step3æ•°æ®æ•è·
- **OpenAIç‰¹å®š**: OpenAI provideré€‰æ‹©é€»è¾‘
- **æ•°æ®æ•è·**: è·¯ç”±å†³ç­–è¿‡ç¨‹ã€Provideré€‰æ‹©ç†ç”±ã€è´Ÿè½½å‡è¡¡çŠ¶æ€

### Step 4: Request Transformation (è¯·æ±‚è½¬æ¢)
- **ä¸»è¦èŒè´£**: è¯·æ±‚æ ¼å¼è½¬æ¢ã€Provideré€‚é…
- **è¾“å…¥**: è·¯ç”±å†³ç­–å¯¹è±¡ + åŸå§‹è¯·æ±‚
- **è¾“å‡º**: Providerç‰¹å®šè¯·æ±‚æ ¼å¼ + Step4æ•°æ®æ•è·
- **OpenAIç‰¹å®š**: Anthropicâ†’OpenAIæ ¼å¼è½¬æ¢
- **æ•°æ®æ•è·**: è½¬æ¢å¤æ‚åº¦åˆ†æã€å­—æ®µæ˜ å°„è®°å½•ã€æ•°æ®å®Œæ•´æ€§æ£€æŸ¥

### Step 5: API Interaction (APIäº¤äº’)
- **ä¸»è¦èŒè´£**: ä¸ç¬¬ä¸‰æ–¹APIé€šä¿¡ã€é”™è¯¯å¤„ç†ã€é‡è¯•
- **è¾“å…¥**: Providerç‰¹å®šè¯·æ±‚æ ¼å¼
- **è¾“å‡º**: åŸå§‹APIå“åº” + Step5æ•°æ®æ•è·
- **OpenAIç‰¹å®š**: OpenAI APIå®¢æˆ·ç«¯ã€è®¤è¯ç®¡ç†
- **æ•°æ®æ•è·**: APIæ€§èƒ½æŒ‡æ ‡ã€ç½‘ç»œå»¶è¿Ÿã€é‡è¯•æ¬¡æ•°ã€é”™è¯¯ç»Ÿè®¡

### Step 6: Response Preprocessing (å“åº”é¢„å¤„ç†)
- **ä¸»è¦èŒè´£**: å“åº”æ ¼å¼ä¿®å¤ã€å·¥å…·è°ƒç”¨è§£æã€è¡¥ä¸åº”ç”¨
- **è¾“å…¥**: åŸå§‹APIå“åº”
- **è¾“å‡º**: é¢„å¤„ç†åå“åº” + Step6æ•°æ®æ•è·
- **OpenAIç‰¹å®š**: æ–‡æœ¬æ ¼å¼å·¥å…·è°ƒç”¨è§£æ
- **æ•°æ®æ•è·**: å“åº”ä¿®å¤è®°å½•ã€è§£æç»Ÿè®¡ã€è¡¥ä¸æ•ˆæœåˆ†æ

### Step 7: Response Transformation (å“åº”è½¬æ¢)
- **ä¸»è¦èŒè´£**: å“åº”æ ¼å¼è½¬æ¢ã€ç»“æ„åŒ–å¤„ç†
- **è¾“å…¥**: é¢„å¤„ç†åå“åº”
- **è¾“å‡º**: ç»Ÿä¸€æ ¼å¼å“åº” + Step7æ•°æ®æ•è·
- **OpenAIç‰¹å®š**: OpenAIâ†’Anthropicæ ¼å¼è½¬æ¢
- **æ•°æ®æ•è·**: è½¬æ¢å‡†ç¡®æ€§ã€æ•°æ®æ˜ å°„å®Œæ•´æ€§ã€æ ¼å¼ä¸€è‡´æ€§

### Step 8: Output Processing (è¾“å‡ºå¤„ç†)
- **ä¸»è¦èŒè´£**: æœ€ç»ˆæ ¼å¼åŒ–ã€ç”¨æˆ·ä½“éªŒä¼˜åŒ–ã€è¾“å‡ºéªŒè¯
- **è¾“å…¥**: ç»Ÿä¸€æ ¼å¼å“åº”
- **è¾“å‡º**: æœ€ç»ˆç”¨æˆ·å“åº” + Step8æ•°æ®æ•è·
- **OpenAIç‰¹å®š**: OpenAIç‰¹å®šè¾“å‡ºä¼˜åŒ–
- **æ•°æ®æ•è·**: è¾“å‡ºè´¨é‡æŒ‡æ ‡ã€ç”¨æˆ·ä½“éªŒè¯„ä¼°ã€æœ€ç»ˆéªŒè¯ç»“æœ

## ğŸ“Š æ•°æ®æ•è·ç³»ç»Ÿè§„èŒƒ (Data Capture System)

### ç»Ÿä¸€æ•°æ®æ•è·æ¶æ„
```typescript
interface StepDataCapture {
  stepNumber: number;                    // æ­¥éª¤ç¼–å· (1-8)
  stepName: string;                      // æ­¥éª¤åç§°
  provider: 'openai' | 'anthropic' | 'gemini' | 'codewhisperer';
  input: any;                           // æ­¥éª¤è¾“å…¥æ•°æ®
  output: any;                          // æ­¥éª¤è¾“å‡ºæ•°æ®
  timing: {
    startTime: number;                  // å¼€å§‹æ—¶é—´æˆ³
    endTime: number;                    // ç»“æŸæ—¶é—´æˆ³
    duration: number;                   // æ‰§è¡Œæ—¶é•¿(ms)
  };
  metadata: {
    requestId: string;                  // è¯·æ±‚ID
    sessionId: string;                  // ä¼šè¯ID
    model: string;                      // æ¨¡å‹åç§°
    category: string;                   // åˆ†ç±» (tool-calls/long-text/normal-text/error)
  };
  errors?: any[];                       // é”™è¯¯ä¿¡æ¯ (å¦‚æœ‰)
}
```

### æ•°æ®å­˜å‚¨ç»“æ„
```
database/pipeline-data/
â”œâ”€â”€ openai/                            # OpenAI Provideræ•°æ®
â”‚   â”œâ”€â”€ step1/                         # Step1æ•°æ®
â”‚   â”‚   â”œâ”€â”€ 2025-08-08/               # æŒ‰æ—¥æœŸåˆ†ç»„
â”‚   â”‚   â”‚   â”œâ”€â”€ input-processing-normal-text-req-123.json
â”‚   â”‚   â”‚   â””â”€â”€ input-processing-tool-calls-req-456.json
â”‚   â”‚   â””â”€â”€ metrics.json              # Step1æŒ‡æ ‡ç»Ÿè®¡
â”‚   â”œâ”€â”€ step2/                        # Step2æ•°æ®
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ step8/
â”œâ”€â”€ anthropic/                        # Anthropic Provideræ•°æ®
â”œâ”€â”€ performance-metrics.json          # å…¨å±€æ€§èƒ½æŒ‡æ ‡
â”œâ”€â”€ flow-statistics.json             # æµç¨‹ç»Ÿè®¡
â””â”€â”€ pipeline-flows/                   # å®Œæ•´æµç¨‹è®°å½•
    â”œâ”€â”€ 2025-08-08/
    â”‚   â”œâ”€â”€ flow-openai-flow-123.json # å®Œæ•´æµç¨‹æ•°æ®
    â”‚   â””â”€â”€ flow-openai-flow-456.json
    â””â”€â”€ ...
```

### æ•°æ®æ•è·é…ç½®
```typescript
interface DataCaptureConfig {
  enabled: boolean;                     // æ˜¯å¦å¯ç”¨æ•°æ®æ•è·
  steps: number[];                      // è¦æ•è·çš„æ­¥éª¤ [1,2,3,4,5,6,7,8]
  providers: string[];                  // è¦æ•è·çš„Provider
  categories: string[];                 // è¦æ•è·çš„åˆ†ç±»
  sampling?: {
    enabled: boolean;                   // æ˜¯å¦å¯ç”¨é‡‡æ ·
    rate: number;                       // é‡‡æ ·ç‡ (0-1)
  };
  storage: {
    type: 'file' | 'database';         // å­˜å‚¨ç±»å‹
    path: string;                       // å­˜å‚¨è·¯å¾„
    maxSize?: number;                   // æœ€å¤§å­˜å‚¨å¤§å°
    rotation?: boolean;                 # æ˜¯å¦è‡ªåŠ¨è½®è½¬
  };
}
```

## ğŸ”§ å®ç°å’Œè¿ç§»è§„åˆ™ (Implementation & Migration Rules)

### æ–°æ¨¡å—å¼€å‘è§„èŒƒ

#### 1. æ¥å£ç»Ÿä¸€æ€§
- **æ‰€æœ‰æ­¥éª¤æ¨¡å—å¿…é¡»å®ç° `PipelineStep` æ¥å£**
- **å¿…é¡»åŒ…å«æ•°æ®æ•è·åŠŸèƒ½**
- **å¿…é¡»æ”¯æŒé”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶**

#### 2. æ•°æ®æµä¸€è‡´æ€§
- **è¾“å…¥è¾“å‡ºæ ¼å¼å¿…é¡»ä¸æ­¥éª¤å®šä¹‰ä¸€è‡´**
- **å¿…é¡»ä¿æŒrequestIdåœ¨æ•´ä¸ªæµç¨‹ä¸­ä¼ é€’**
- **æ•°æ®è½¬æ¢å¿…é¡»å¯é€†å’Œå¯è¿½è¸ª**

#### 3. æ€§èƒ½è¦æ±‚
- **å•æ­¥éª¤æ‰§è¡Œæ—¶é—´ä¸è¶…è¿‡5ç§’**
- **å†…å­˜ä½¿ç”¨å³°å€¼ä¸è¶…è¿‡100MB**
- **æ•°æ®æ•è·å¼€é”€ä¸è¶…è¿‡æ‰§è¡Œæ—¶é—´çš„10%**

### ä»£ç è¿ç§»ç­–ç•¥

#### Phase 1: åŸºç¡€è®¾æ–½å»ºç«‹
1. âœ… åˆ›å»ºæ–°ç›®å½•ç»“æ„
2. âœ… å®ç°æ•°æ®æ•è·åŸºç¡€æ¡†æ¶  
3. âœ… å»ºç«‹ç±»å‹å®šä¹‰å’Œæ¥å£
4. âœ… å®ç°ç»Ÿä¸€æ•°æ®æ•è·ç®¡ç†å™¨

#### Phase 2: å…³é”®æ­¥éª¤è¿ç§»
1. **Step1 (è¾“å…¥å¤„ç†)**: ä» `src/input/openai/` è¿ç§»
2. **Step2 (é¢„å¤„ç†)**: ä» `src/preprocessing/` è¿ç§»
3. **Step4 (è¯·æ±‚è½¬æ¢)**: ä» `src/transformers/openai.ts` è¿ç§»
4. **Step5 (APIäº¤äº’)**: ä» `src/providers/openai/` è¿ç§»

#### Phase 3: å®Œæ•´æµæ°´çº¿
1. **Step3 (è·¯ç”±)**: ä» `src/routing/` è¿ç§»
2. **Step6 (å“åº”é¢„å¤„ç†)**: ä» `src/patches/openai/` è¿ç§»  
3. **Step7 (å“åº”è½¬æ¢)**: ä» `src/transformers/` è¿ç§»
4. **Step8 (è¾“å‡ºå¤„ç†)**: æ–°å®ç°

#### Phase 4: éªŒè¯å’Œæ¸…ç†
1. **ç«¯åˆ°ç«¯æµ‹è¯•**: å®Œæ•´æµæ°´çº¿éªŒè¯
2. **æ€§èƒ½åŸºå‡†**: ä¸æ—§ç³»ç»Ÿå¯¹æ¯”
3. **Legacyä»£ç æ¸…ç†**: ç§»é™¤å†—ä½™ä»£ç 
4. **æ–‡æ¡£æ›´æ–°**: å®Œå–„æ¶æ„æ–‡æ¡£

### å‘åå…¼å®¹æ€§è§„åˆ™

#### 1. APIæ¥å£ä¿æŒä¸å˜
- **ç°æœ‰APIå…¥å£ç‚¹å¿…é¡»ä¿æŒå…¼å®¹**
- **å“åº”æ ¼å¼ä¸èƒ½æ”¹å˜**
- **é”™è¯¯å¤„ç†æ–¹å¼ä¿æŒä¸€è‡´**

#### 2. é…ç½®å…¼å®¹æ€§
- **ç°æœ‰é…ç½®æ–‡ä»¶æ ¼å¼ä¿æŒæ”¯æŒ**
- **ç¯å¢ƒå˜é‡å‘½åä¿æŒä¸å˜**
- **Providerè®¤è¯æ–¹å¼ä¸å˜**

#### 3. æ•°æ®è¿ç§»
- **ç°æœ‰æµ‹è¯•æ•°æ®å¿…é¡»åœ¨æ–°ç³»ç»Ÿä¸­å¯ç”¨**
- **å†å²æ—¥å¿—æ ¼å¼ä¿æŒå…¼å®¹**
- **æ€§èƒ½åŸºå‡†æ•°æ®å¯æ¯”è¾ƒ**

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯è§„èŒƒ (Testing & Validation)

### æµæ°´çº¿æµ‹è¯•ç­–ç•¥

#### 1. å•æ­¥æµ‹è¯•
æ¯ä¸ªæ­¥éª¤éƒ½å¿…é¡»æœ‰ç‹¬ç«‹çš„å•å…ƒæµ‹è¯•:
```bash
# Step1æµ‹è¯•
node test-step1-input-processing.js

# Step2æµ‹è¯•  
node test-step2-input-preprocessing.js

# ... å…¶ä»–æ­¥éª¤
```

#### 2. é›†æˆæµ‹è¯•
éªŒè¯æ­¥éª¤é—´çš„æ•°æ®æµè½¬:
```bash
# å®Œæ•´æµæ°´çº¿æµ‹è¯•
node test-pipeline-integration.js

# OpenAIç‰¹å®šæµæ°´çº¿æµ‹è¯•
node test-openai-pipeline-complete.js
```

#### 3. æ•°æ®æ•è·æµ‹è¯•
éªŒè¯æ•°æ®æ•è·ç³»ç»Ÿ:
```bash
# æ•°æ®æ•è·ç³»ç»Ÿæµ‹è¯•
node test-pipeline-data-capture.js

# æ€§èƒ½æŒ‡æ ‡æµ‹è¯•
node test-performance-metrics.js
```

#### 4. ç«¯åˆ°ç«¯éªŒè¯
```bash
# STD-8-STEP-PIPELINEå®Œæ•´éªŒè¯
./test-runner.sh --pipeline --provider openai

# æ€§èƒ½å›å½’æµ‹è¯•
./test-runner.sh --performance --baseline
```

### è´¨é‡æ ‡å‡†

#### 1. ä»£ç è¦†ç›–ç‡
- **å•æ­¥æµ‹è¯•è¦†ç›–ç‡ â‰¥ 95%**
- **é›†æˆæµ‹è¯•è¦†ç›–ç‡ â‰¥ 90%**
- **é”™è¯¯è·¯å¾„è¦†ç›–ç‡ â‰¥ 85%**

#### 2. æ€§èƒ½åŸºå‡†
- **ç«¯åˆ°ç«¯å“åº”æ—¶é—´ â‰¤ åŸç³»ç»Ÿ 110%**
- **å†…å­˜ä½¿ç”¨ â‰¤ åŸç³»ç»Ÿ 120%**
- **æ•°æ®æ•è·å¼€é”€ â‰¤ 10%**

#### 3. æ•°æ®è´¨é‡
- **æ•°æ®å®Œæ•´æ€§ 100%**
- **æ ¼å¼ä¸€è‡´æ€§ 100%**
- **å¯è¿½æº¯æ€§ 100%**

## ğŸ“ˆ ç›‘æ§å’ŒæŒ‡æ ‡ (Monitoring & Metrics)

### å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPIs)

#### 1. æ­¥éª¤çº§æŒ‡æ ‡
- **å¹³å‡æ‰§è¡Œæ—¶é—´**: æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œæ—¶é•¿ç»Ÿè®¡
- **æˆåŠŸç‡**: æ­¥éª¤æ‰§è¡ŒæˆåŠŸç‡
- **é”™è¯¯ç‡**: æ­¥éª¤é”™è¯¯ç‡å’Œé”™è¯¯ç±»å‹åˆ†å¸ƒ
- **å¹¶å‘å¤„ç†èƒ½åŠ›**: åŒæ—¶å¤„ç†çš„è¯·æ±‚æ•°é‡

#### 2. æµæ°´çº¿çº§æŒ‡æ ‡  
- **ç«¯åˆ°ç«¯å»¶è¿Ÿ**: ä»è¾“å…¥åˆ°è¾“å‡ºçš„æ€»æ—¶é•¿
- **ååé‡**: æ¯ç§’å¤„ç†çš„è¯·æ±‚æ•°é‡
- **èµ„æºåˆ©ç”¨ç‡**: CPUã€å†…å­˜ä½¿ç”¨ç‡
- **æ•°æ®æµè½¬æ•ˆç‡**: æ­¥éª¤é—´æ•°æ®ä¼ è¾“æ•ˆç‡

#### 3. æ•°æ®è´¨é‡æŒ‡æ ‡
- **æ•°æ®æ•è·å®Œæ•´æ€§**: æ•è·æ•°æ®çš„å®Œæ•´ç¨‹åº¦
- **å­˜å‚¨æ•ˆç‡**: æ•°æ®å‹ç¼©ç‡å’Œå­˜å‚¨ä½¿ç”¨
- **æŸ¥è¯¢å“åº”æ—¶é—´**: å†å²æ•°æ®æŸ¥è¯¢é€Ÿåº¦
- **æ•°æ®ä¿ç•™åˆè§„æ€§**: æ•°æ®ä¿ç•™ç­–ç•¥æ‰§è¡Œæƒ…å†µ

### ç›‘æ§ä»ªè¡¨æ¿
```bash
# ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
node database/pipeline-data-capture/unified-pipeline-capture.js report

# æŸ¥çœ‹å®æ—¶æŒ‡æ ‡
curl http://localhost:3456/pipeline/metrics

# å¯¼å‡ºå†å²æ•°æ®
curl http://localhost:3456/pipeline/export?days=7
```

## ğŸ”„ æŒç»­æ”¹è¿› (Continuous Improvement)

### 1. å®šæœŸè¯„ä¼°
- **æ¯æœˆæ€§èƒ½å›é¡¾**: åˆ†ææ€§èƒ½è¶‹åŠ¿å’Œç“¶é¢ˆ
- **å­£åº¦æ¶æ„å®¡æŸ¥**: è¯„ä¼°æ¶æ„åˆç†æ€§
- **å¹´åº¦æŠ€æœ¯å€ºåŠ¡æ¸…ç†**: æ¸…ç†è¿‡æ—¶ä»£ç å’Œä¼˜åŒ–ç»“æ„

### 2. è‡ªåŠ¨ä¼˜åŒ–
- **è‡ªåŠ¨æ€§èƒ½è°ƒä¼˜**: åŸºäºå†å²æ•°æ®ä¼˜åŒ–å‚æ•°
- **æ™ºèƒ½è´Ÿè½½å‡è¡¡**: åŠ¨æ€è°ƒæ•´Provideræƒé‡
- **é¢„æµ‹æ€§ç»´æŠ¤**: åŸºäºæŒ‡æ ‡é¢„æµ‹æ½œåœ¨é—®é¢˜

### 3. ç‰ˆæœ¬æ¼”è¿›
- **å‘å‰å…¼å®¹**: æ–°ç‰ˆæœ¬ä¿æŒå‘å‰å…¼å®¹æ€§
- **æ¸è¿›è¿ç§»**: æ”¯æŒæ–°æ—§ç³»ç»Ÿå¹³æ»‘åˆ‡æ¢
- **åŠŸèƒ½å¼€å…³**: æ”¯æŒåŠŸèƒ½çº§åˆ«çš„å¼€å¯å…³é—­

---

## ğŸ“‹ æ£€æŸ¥æ¸…å• (Checklist)

### å¼€å‘è€…æ£€æŸ¥æ¸…å•
ä½¿ç”¨æ–°æ¶æ„å¼€å‘æ—¶å¿…é¡»ç¡®è®¤:

- [ ] **æ¨¡å—æ”¾ç½®æ­£ç¡®**: ä»£ç æ”¾åœ¨å¯¹åº”çš„stepç›®å½•ä¸‹
- [ ] **å®ç°PipelineStepæ¥å£**: æ‰€æœ‰æ­¥éª¤æ¨¡å—å®ç°ç»Ÿä¸€æ¥å£
- [ ] **åŒ…å«æ•°æ®æ•è·**: é›†æˆå¯¹åº”çš„æ•°æ®æ•è·åŠŸèƒ½
- [ ] **é”™è¯¯å¤„ç†å®Œæ•´**: åŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘
- [ ] **æ€§èƒ½æŒ‡æ ‡ç›‘æ§**: åŒ…å«æ‰§è¡Œæ—¶é—´å’Œèµ„æºä½¿ç”¨ç›‘æ§
- [ ] **å•å…ƒæµ‹è¯•è¦†ç›–**: ç¼–å†™å¯¹åº”çš„å•å…ƒæµ‹è¯•
- [ ] **é›†æˆæµ‹è¯•éªŒè¯**: éªŒè¯ä¸å…¶ä»–æ­¥éª¤çš„é›†æˆ
- [ ] **æ–‡æ¡£æ›´æ–°åŒæ­¥**: æ›´æ–°ç›¸å…³æŠ€æœ¯æ–‡æ¡£

### éƒ¨ç½²æ£€æŸ¥æ¸…å•
éƒ¨ç½²æ–°æ¶æ„æ—¶å¿…é¡»ç¡®è®¤:

- [ ] **ç›®å½•ç»“æ„åˆ›å»º**: æ‰€æœ‰pipelineç›®å½•æ­£ç¡®åˆ›å»º
- [ ] **æ•°æ®åº“è·¯å¾„é…ç½®**: æ•°æ®æ•è·è·¯å¾„æ­£ç¡®é…ç½®
- [ ] **æƒé™è®¾ç½®æ­£ç¡®**: æ•°æ®å†™å…¥æƒé™æ­£ç¡®è®¾ç½®
- [ ] **ç¯å¢ƒå˜é‡é…ç½®**: å¿…è¦çš„ç¯å¢ƒå˜é‡æ­£ç¡®è®¾ç½®
- [ ] **å‘åå…¼å®¹éªŒè¯**: ç°æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] **æ€§èƒ½åŸºå‡†æµ‹è¯•**: æ€§èƒ½ä¸ä½äºåŸç³»ç»Ÿ
- [ ] **ç›‘æ§ç³»ç»Ÿå°±ç»ª**: ç›‘æ§å’Œå‘Šè­¦æ­£å¸¸å·¥ä½œ
- [ ] **å›æ»šæ–¹æ¡ˆå‡†å¤‡**: å‡†å¤‡å¿«é€Ÿå›æ»šæ–¹æ¡ˆ

---
**æ¶æ„ç‰ˆæœ¬**: v2.0 (æµæ°´çº¿æ•°æ®æ•è·æ¶æ„)  
**å®æ–½çŠ¶æ€**: Phase 1 å®Œæˆ (åŸºç¡€è®¾æ–½å»ºç«‹)  
**ä¸‹ä¸€é˜¶æ®µ**: Phase 2 (å…³é”®æ­¥éª¤è¿ç§»)  
**è´Ÿè´£äºº**: Jason Zhang  
**æœ€åæ›´æ–°**: 2025-08-08