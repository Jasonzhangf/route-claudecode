# 🧪 测试系统规则 (Testing System Rules)

## 🎯 核心测试原则 (Core Testing Principles)

### 四大核心规则
1. **测试脚本化**: 所有测试必须通过脚本执行，禁止手动测试
2. **语义明确**: 每个测试文件名用一句话清楚表达测试目的
3. **文档同步**: 每个测试文件(.js)都有对应的同名文档(.md)
4. **实时更新**: 每次测试执行后必须更新对应MD文档

### 附加原则
5. **复用检查**: 发现问题需要测试时，先检查是否已有类似测试
6. **真实数据**: 优先使用真实日志数据构建测试用例
7. **修复验证**: 每个修复都必须有对应验证测试

## 📁 测试目录架构 (Test Directory Structure)

```
test/
├── functional/     # 功能测试 - 工具调用、多轮对话、API集成
├── integration/    # 集成测试 - 端到端流程、供应商集成
├── pipeline/       # 流水线测试 - 6步骤标准验证流程
├── performance/    # 性能测试 - 负载测试、并发处理
├── unit/          # 单元测试 - 基础组件测试
├── debug/         # 调试测试 - 问题诊断和重现
└── docs/          # 测试文档 - 综合报告和规范
```

## 🔄 STD-6-STEP-PIPELINE (标准六步测试流程)

**适用场景**: 新功能开发或重大问题调试的标准验证流程

### Step 1: Input Processing (`test-step1-input-processing.js`)
- **目标**: 验证API请求链路通畅性
- **输入**: 原始Anthropic API请求
- **输出**: 完整API响应 → `step1-output.json`
- **验证点**: 请求发送、响应接收、格式正确性

### Step 2: Routing Logic (`test-step2-routing.js`)
- **目标**: 验证模型路由逻辑正确性  
- **输入**: `step1-output.json`
- **输出**: 路由分析结果 → `step2-output.json`
- **验证点**: 类别识别、provider选择、模型映射

### Step 3: Transformation (`test-step3-transformation.js`)
- **目标**: 验证格式转换逻辑
- **输入**: `step2-output.json`
- **输出**: 转换测试结果 → `step3-output.json`
- **验证点**: 请求转换、响应转换、工具调用处理

### Step 4: Raw API Response (`test-step4-raw-api-response.js`)
- **目标**: 测试真实第三方API响应
- **输入**: Step2路由结果
- **输出**: 原始API响应 → `step4-output.json`
- **验证点**: API可达性、响应有效性、格式符合性

### Step 5: Transformer Input (`test-step5-transformer-input.js`)
- **目标**: 验证transformer数据接收
- **输入**: `step4-output.json`
- **输出**: Transformer输入数据 → `step5-output.json`
- **验证点**: 数据传递、结构完整性、关键字段存在

### Step 6: Transformer Output (`test-step6-transformer-output.js`)
- **目标**: 测试transformer转换输出
- **输入**: `step5-output.json`
- **输出**: 转换结果 → `step6-output.json`
- **验证点**: 转换逻辑、内容提取、格式正确性

### 数据流验证链
```
请求处理: Step1 → Step2 → Step3
         ↓
API调用: Step4
         ↓
响应处理: Step5 → Step6
```

## 🛠️ 测试工具和脚本

### 统一测试运行器 (`test-runner.sh`)
```bash
# 列出所有测试
./test-runner.sh --list

# 搜索相关测试
./test-runner.sh --search <关键词>

# 按分类运行
./test-runner.sh --category functional

# 运行单个测试
./test-runner.sh test/functional/test-tool-calls.js
```

### 测试命名规范
- **功能测试**: `test-[功能描述].js`
- **流水线测试**: `test-step[N]-[功能描述].js`
- **组件测试**: `test-[组件名]-[功能].js`
- **调试脚本**: `debug-[问题域].js`

### 文档命名规范
- **测试文档**: `test-[功能描述].md`
- **调试记录**: `debug-[问题关键字]-[YYYYMMDD]-[HHMM].md`
- **日志文件**: `/tmp/test-[测试名]-[时间戳].log`

## 📋 测试文档规范 (Test Documentation Standards)

### 必需内容
每个测试文档必须包含：

#### 基本信息
- **测试用例**: 用一句话描述测试目的
- **测试目标**: 具体要验证的问题或功能
- **相关文件**: 测试脚本和日志文件路径

#### 执行记录
- **最近执行**: 时间、状态、执行时长、日志文件
- **历史记录**: 保留多次执行的历史信息
- **结果统计**: 成功率、失败原因、性能数据

#### 实现细节
- **测试数据**: 输入数据格式和来源
- **验证逻辑**: 关键验证点和期望结果
- **错误处理**: 常见错误和处理方式

### 文档模板
```markdown
# Test: [一句话描述测试目的]

## 测试目标
具体要验证什么问题

## 最近执行记录
- **时间**: 2025-08-01 14:30:00
- **状态**: PASSED/FAILED
- **执行时长**: 2.5秒
- **日志文件**: `/tmp/test-xxx-1722513000.log`

## 历史执行记录
| 时间 | 状态 | 时长 | 备注 |
|------|------|------|------|
| 2025-08-01 | PASSED | 2.5s | 正常执行 |

## 相关文件
- **测试脚本**: `test/functional/test-xxx.js`
- **配置文件**: `test-config.json`
```

## 🔍 测试策略分类

### 功能测试策略
- **工具调用测试**: 验证各Provider的工具调用处理
- **多轮对话测试**: 验证会话状态管理
- **格式转换测试**: 验证跨Provider格式转换
- **错误处理测试**: 验证各种错误场景处理

### 集成测试策略
- **端到端测试**: 完整请求响应链路验证
- **Provider集成**: 各AI服务商的集成测试
- **负载均衡测试**: Round Robin机制验证
- **故障切换测试**: Provider故障恢复测试

### 性能测试策略
- **并发测试**: 多请求并发处理验证
- **负载测试**: 高频请求下的系统稳定性
- **内存测试**: 内存泄漏和资源管理
- **响应时间**: 各组件响应时间测量

## 🚨 测试失败处理流程

### 失败分类
1. **环境问题**: 网络、API密钥、服务不可用
2. **配置问题**: 路由配置、Provider配置错误
3. **代码问题**: 逻辑错误、格式转换失败
4. **数据问题**: 测试数据损坏、格式不匹配

### 问题定位策略
- **Step1失败**: 基础服务问题 (端口、路由、服务器)
- **Step2失败**: 路由配置问题 (规则、映射、provider配置)
- **Step3失败**: 转换器设计问题 (逻辑、接口、格式)
- **Step4失败**: 第三方API问题 (服务、认证、网络)
- **Step5-6失败**: 数据处理问题 (传递、转换、格式)

### 修复验证流程
1. **问题重现**: 使用测试脚本重现问题
2. **修复实施**: 针对性修复代码或配置
3. **回归测试**: 运行相关测试验证修复
4. **文档更新**: 更新测试文档记录修复

## 📊 测试质量指标

### 覆盖率要求
- **功能覆盖**: 所有核心功能必须有测试覆盖
- **Provider覆盖**: 所有Provider必须有集成测试
- **错误覆盖**: 所有可能的错误路径必须有测试
- **性能覆盖**: 关键性能指标必须有基准测试

### 质量指标
- **测试通过率**: ≥95%
- **测试执行时间**: 单个测试 ≤30秒
- **文档同步率**: 100% (每个测试都有对应文档)
- **问题修复时间**: ≤24小时

## 🔄 持续集成规则

### 提交前检查
- [ ] 运行相关测试验证功能正常
- [ ] 更新或创建对应测试文档
- [ ] 检查测试覆盖率是否满足要求

### 发布前验证
- [ ] 运行完整测试套件
- [ ] 执行STD-6-STEP-PIPELINE验证
- [ ] 性能回归测试通过
- [ ] 所有测试文档更新完成

---
**测试框架版本**: v2.6.0  
**维护者**: Jason Zhang  
**最后更新**: 2025-08-01