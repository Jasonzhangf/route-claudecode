# 🚀 部署和发布规则 (Deployment and Release Rules)

## 🔒 发布前置规则 (Pre-Release Requirements)

### 强制检查清单
- [ ] **构建成功**: 运行 `./build.sh` 确保项目能成功构建
- [ ] **测试通过**: 运行 `./test-runner.sh` 确保所有核心测试通过
- [ ] **用户确认**: npm和github提交必须获得用户明确确认

### 三步验证流程
1. **构建验证**: `npm run build` 无错误完成
2. **测试验证**: STD-6-STEP-PIPELINE 100%通过
3. **功能验证**: 核心功能端到端测试通过

## 🏗️ 构建规则 (Build Rules)

### 零Fallback构建原则
- **完整构建必须成功**: 不使用fallback机制，不允许手动操作
- **依赖解析**: 必须解决所有外部依赖和workspace包依赖
- **Clean安装验证**: 每次构建后必须验证clean环境下的npm全局安装成功

### 构建流程标准
```bash
1. 修复依赖 → npm install
2. 完整构建 → npm run build  
3. 包测试   → npm pack
4. 全局安装验证 → npm install -g [package].tgz
```

### esbuild配置要求
- **外部依赖列表**: 包含完整的external依赖列表
- **Workspace解析**: 正确处理workspace包依赖
- **Bundle优化**: 最小化bundle大小和启动时间

## 🔄 启动脚本规范 (Startup Script Standards)

### 统一脚本集合
- **推荐启动**: `./rcc start` - 简化启动器，支持正常Ctrl+C退出
- **完整开发流程**: `./fix-and-test.sh` - 构建+启动+测试一体化
- **开发模式启动**: `./start-dev.sh` - 自动构建+启动服务+日志记录
- **单独构建**: `./build.sh` - 清理和构建项目
- **测试套件**: `./test-all.sh` - 完整测试，包括API和transformer验证
- **本地安装**: `./install-local.sh` - 构建+打包+全局安装

### 端口管理规范
- **Development Port**: 3456 (主要API端点)
- **Production Port**: 3457 (生产环境)
- **日志监控**: `/tmp/ccr-dev.log`
- **自动端口管理**: 启动时自动监控端口冲突，直接关闭并继续启动

### 服务管理标准
- **推荐启动**: `./rcc start` (支持正常Ctrl+C退出)
- **状态检查**: `./rcc status` 或 `node dist/cli.js status`
- **停止服务**: `./rcc stop` 或 Ctrl+C
- **服务监控**: 日志直接显示或 `tail -f ~/.route-claude-code/logs/ccr-*.log`
- **多实例处理**: 最后启动的服务器替代前面的实例

## 📦 包管理和分发 (Package Management and Distribution)

### NPM发布规则
- **版本管理**: 严格遵循语义化版本控制 (SemVer)
- **包内容**: 只包含必要的分发文件 (dist/, public/, README.md, LICENSE)
- **依赖清理**: 确保dependencies中只包含运行时必需依赖
- **平台兼容**: 支持Node.js >=16.0.0

### GitHub发布规则
- **分支策略**: main分支为稳定发布分支
- **标签管理**: 每个发布版本必须有对应的git标签
- **Release Notes**: 每个版本必须有详细的更新说明
- **安全检查**: 发布前进行安全漏洞扫描

### 文件包含清单
```json
"files": [
  "dist/",
  "public/",
  "README.md", 
  "LICENSE",
  "config.sample.json",
  "rcc-daemon.sh",
  "rcc-daemon.ps1"
]
```

## 🔧 脚本自动化规则 (Script Automation Rules)

### 命令脚本化原则
- **频繁命令脚本化**: 频繁调用的命令构建脚本，无需等待用户批准
- **三次规则**: 一条命令在一个对话里被调用三次以上就写成脚本
- **脚本命名**: 脚本命名要显而易见，清晰表达功能

### 脚本类型分类
- **构建脚本**: `build.sh`, `clean-build.sh`
- **启动脚本**: `start-dev.sh`, `rcc`
- **测试脚本**: `test-runner.sh`, `test-all.sh`
- **部署脚本**: `install-local.sh`, `deploy.sh`
- **维护脚本**: `fix-and-test.sh`, `migrate-config.js`

## 🛡️ 安全配置规则 (Security Configuration Rules)

### 环境保护原则
- **禁止覆盖全局配置**: 不允许覆盖~/.gemini/.env等全局配置文件
- **凭据分离**: 敏感凭据与代码完全分离
- **权限最小化**: 脚本和程序以最小必要权限运行

### 配置安全检查
- [ ] 配置模板不包含真实API密钥
- [ ] 敏感配置文件添加到.gitignore
- [ ] 生产环境配置通过环境变量或安全存储管理
- [ ] 定期轮换API密钥和认证令牌

## 🔍 发布质量保证 (Release Quality Assurance)

### 代码质量检查
- **静态分析**: TypeScript类型检查无错误
- **代码风格**: 通过ESLint检查
- **安全扫描**: 依赖安全漏洞扫描
- **性能测试**: 核心功能性能回归测试

### 功能完整性验证
- **核心功能**: 所有四个Provider正常工作
- **路由功能**: 五种路由类别正确映射
- **工具调用**: 工具调用在所有Provider中正常工作
- **负载均衡**: Round Robin机制正确工作

### 兼容性测试
- **Node.js版本**: 支持的Node.js版本范围测试
- **操作系统**: Windows, macOS, Linux兼容性测试
- **依赖兼容**: 第三方依赖版本兼容性测试

## 📊 部署监控 (Deployment Monitoring)

### 部署指标跟踪
- **构建时间**: 记录构建耗时趋势
- **包大小**: 监控分发包大小变化
- **启动时间**: 跟踪应用启动性能
- **内存占用**: 监控运行时内存使用

### 错误监控
- **构建错误**: 自动收集和分类构建错误
- **启动错误**: 监控应用启动失败情况
- **运行时错误**: 跟踪生产环境错误率
- **性能回归**: 检测性能指标异常变化

## 🔄 回滚和恢复策略 (Rollback and Recovery Strategy)

### 版本回滚机制
- **快速回滚**: 能够快速回滚到上一稳定版本
- **数据兼容**: 确保配置和数据向后兼容
- **服务连续**: 回滚过程中最小化服务中断

### 故障恢复流程
1. **问题识别**: 快速识别和分类部署问题
2. **影响评估**: 评估问题影响范围和严重程度
3. **决策制定**: 决定修复还是回滚
4. **执行操作**: 快速执行修复或回滚操作
5. **验证恢复**: 验证问题已解决且服务正常

## 🎯 部署最佳实践 (Deployment Best Practices)

### 渐进式部署
- **分阶段发布**: 先内部测试，再小范围发布，最后全量发布
- **金丝雀部署**: 使用少量用户验证新版本稳定性
- **蓝绿部署**: 维护两套环境确保零停机部署

### 自动化程度
- **自动构建**: CI/CD流水线自动触发构建
- **自动测试**: 部署前自动运行测试套件
- **自动部署**: 测试通过后自动部署到目标环境
- **自动监控**: 部署后自动监控关键指标

## 📋 部署检查清单 (Deployment Checklist)

### 发布前检查
- [ ] 代码审查完成并批准
- [ ] 所有测试通过(单元测试、集成测试、端到端测试)
- [ ] 性能测试通过，无性能回归
- [ ] 安全扫描通过，无高危漏洞
- [ ] 文档更新完成
- [ ] 版本号更新正确
- [ ] 更新日志编写完成

### 发布后验证
- [ ] 应用成功启动并运行
- [ ] 核心功能正常工作
- [ ] 监控指标正常
- [ ] 日志无严重错误
- [ ] 用户反馈收集
- [ ] 性能指标符合预期

---
**部署规则版本**: v2.6.0  
**维护者**: Jason Zhang  
**最后更新**: 2025-08-01