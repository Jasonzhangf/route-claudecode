# ğŸš¨ è¿›ç¨‹é”å’Œå¤šå®ä¾‹ç®¡ç†æ€§èƒ½åˆ†ææŠ¥å‘Š

**æ—¥æœŸ**: 2025-07-30  
**æ‰§è¡ŒåŸå› **: ç”¨æˆ·è¦æ±‚ "å®Œæ•´æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦æœ‰è¿›ç¨‹é”å’Œå¤šå®ä¾‹ç®¡ç†é™ä½æ€§èƒ½ï¼Œå› ä¸ºhttpå¤©ç„¶éš”ç¦»ï¼Œæ‰€ä»¥åº”è¯¥å–æ¶ˆ"

## ğŸ“Š åˆ†æç»“æœæ€»ç»“

ç»è¿‡å®Œæ•´ä»£ç åº“åˆ†æï¼Œå‘ç°Claude Code Routeræ¶æ„ä¸­å­˜åœ¨ä»¥ä¸‹è¿›ç¨‹åŒæ­¥æœºåˆ¶ï¼Œä½†**å¤§éƒ¨åˆ†å®é™…ä¸Šä¸ä¼šå½±å“HTTPè¯·æ±‚å¤„ç†æ€§èƒ½**ï¼Œå› ä¸ºHTTPè¯·æ±‚å¤©ç„¶éš”ç¦»ã€‚

### âœ… **æ— éœ€ç§»é™¤çš„ç»„ä»¶** (ä¸å½±å“HTTPæ€§èƒ½)

1. **Session Managerå®šæ—¶æ¸…ç†** (`src/session/manager.ts:36`)
   ```typescript
   setInterval(() => this.cleanupExpiredSessions(), 10 * 60 * 1000);
   ```
   - **å½±å“**: è½»å¾®ï¼Œæ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡åå°æ¸…ç†
   - **å»ºè®®**: ä¿ç•™ï¼Œæ¸…ç†è¿‡æœŸä¼šè¯æ˜¯å¿…è¦çš„å†…å­˜ç®¡ç†

2. **å“åº”ç»Ÿè®¡æ—¥å¿—å®šæ—¶å™¨** (`src/utils/response-stats.ts:205`)
   ```typescript
   this.logInterval = setInterval(() => { /* log stats */ }, logIntervalMs);
   ```
   - **å½±å“**: å¾ˆå°ï¼Œä»…ç”¨äºå®šæœŸè¾“å‡ºç»Ÿè®¡ä¿¡æ¯
   - **å»ºè®®**: ä¿ç•™ï¼Œå¯¹è°ƒè¯•å’Œç›‘æ§æœ‰ä»·å€¼

3. **å¤±è´¥æ—¥å¿—å»¶è¿Ÿå†™å…¥** (`src/utils/failure-logger.ts:284-287`)
   ```typescript
   setTimeout(() => { setInterval(() => { /* batch write */ }, 5000); }, 1000);
   ```
   - **å½±å“**: æ— ï¼Œå¼‚æ­¥æ‰¹é‡å†™å…¥ï¼Œä¸é˜»å¡HTTPè¯·æ±‚
   - **å»ºè®®**: ä¿ç•™ï¼Œæé«˜æ—¥å¿—å†™å…¥æ•ˆç‡

### ğŸ”¥ **å·²ä¼˜åŒ–çš„æ¶æ„** (æ¶ˆé™¤äº†å¤æ‚å¹¶å‘æ§åˆ¶)

1. **SimpleProviderManager** (`src/routing/simple-provider-manager.ts`)
   - **ç°çŠ¶**: å·²é‡‡ç”¨ç®€å•è½®è¯¢å’Œé»‘åå•æœºåˆ¶ï¼Œæ— é”è®¾è®¡
   - **æ€§èƒ½**: ä¼˜ç§€ï¼ŒO(1)æ—¶é—´å¤æ‚åº¦é€‰æ‹©provider
   - **å¹¶å‘å®‰å…¨**: ä¾èµ–JavaScriptå•çº¿ç¨‹ç‰¹æ€§ï¼Œæ— éœ€é¢å¤–åŒæ­¥

2. **è·¯ç”±å¼•æ“** (`src/routing/engine.ts:892`)
   ```typescript
   // ğŸ”¥ ç§»é™¤äº†æ‰€æœ‰å¹¶å‘æ§åˆ¶æ–¹æ³• - HTTPå¤©ç„¶éš”ç¦»ï¼Œæ— éœ€è¿›ç¨‹é”
   ```
   - **ç°çŠ¶**: å·²æ˜ç¡®ç§»é™¤å¹¶å‘æ§åˆ¶æ–¹æ³•
   - **æ¶æ„**: åŸºäºHTTPè¯·æ±‚å¤©ç„¶éš”ç¦»çš„æ— é”è®¾è®¡

### âš ï¸ **éœ€è¦å®¡æŸ¥çš„æ½œåœ¨æ€§èƒ½é—®é¢˜**

1. **CodeWhisperer Tokenè½®è¯¢åŸå­æ“ä½œ** (`src/providers/codewhisperer/safe-token-manager.ts:234-261`)
   ```typescript
   private async executeAtomically<T>(operation: () => Promise<T>): Promise<T> {
     const executeOperation = async () => {
       if (this.isOperationInProgress) {
         this.pendingOperations.push(executeOperation);
         return;
       }
       // ... åŸå­æ“ä½œé€»è¾‘
     };
   }
   ```
   - **å½±å“**: **ä¸­ç­‰**ï¼Œå¯èƒ½åœ¨é«˜å¹¶å‘tokenè½®è¯¢æ—¶é€ æˆé˜Ÿåˆ—å»¶è¿Ÿ
   - **åœºæ™¯**: å¤šä¸ªå¹¶å‘è¯·æ±‚éœ€è¦è½®è¯¢tokenæ—¶æ’é˜Ÿç­‰å¾…
   - **å»ºè®®**: è€ƒè™‘ç§»é™¤åŸå­é”ï¼Œå› ä¸ºtokenè½®è¯¢å¤±è´¥çš„å®¹é”™æˆæœ¬ä½äºé”çš„æ€§èƒ½æˆæœ¬

2. **CodeWhispererè®¤è¯å®šæ—¶åˆ·æ–°** (`src/providers/codewhisperer/auth.ts:376-402`)
   ```typescript
   this.refreshTimer = setInterval(() => { /* refresh tokens */ }, refreshInterval);
   setImmediate(async () => { /* immediate refresh */ });
   ```
   - **å½±å“**: **è¾ƒå°**ï¼Œåå°å®šæ—¶ä»»åŠ¡ï¼Œä¸ç›´æ¥é˜»å¡HTTPè¯·æ±‚
   - **å»ºè®®**: ä¿ç•™ï¼Œtokenåˆ·æ–°æ˜¯å¿…è¦çš„è®¤è¯ç»´æŠ¤

## ğŸ¯ **æ€§èƒ½ä¼˜åŒ–å»ºè®®**

### 1. **ç§»é™¤Tokenç®¡ç†åŸå­é”** (å¯é€‰ä¼˜åŒ–)

**æ–‡ä»¶**: `src/providers/codewhisperer/safe-token-manager.ts`

**å½“å‰é—®é¢˜**:
```typescript
// å½“å‰: åŸå­æ“ä½œå¯èƒ½å¯¼è‡´è¯·æ±‚æ’é˜Ÿ
private async executeAtomically<T>(operation: () => Promise<T>): Promise<T> {
  if (this.isOperationInProgress) {
    this.pendingOperations.push(executeOperation); // ğŸ‘ˆ æ’é˜Ÿç­‰å¾…
    return;
  }
}
```

**å»ºè®®ä¼˜åŒ–**:
```typescript
// ä¼˜åŒ–: å…è®¸å¹¶å‘tokenè·å–ï¼Œä¾èµ–HTTPå¹‚ç­‰æ€§
async getCurrentToken(): Promise<string> {
  // ç›´æ¥è¿”å›å½“å‰tokenï¼Œæ— é”è®¾è®¡
  // å³ä½¿å¶å°”è·å–åˆ°ç¨æ—§çš„tokenï¼ŒAPIè°ƒç”¨å¤±è´¥çš„é‡è¯•æˆæœ¬ < é”çš„å»¶è¿Ÿæˆæœ¬
  return this.currentToken;
}
```

### 2. **ç¡®è®¤HTTPå¤©ç„¶éš”ç¦»ä¼˜åŠ¿**

**ç°æœ‰æ¶æ„ä¼˜åŠ¿**:
- âœ… æ¯ä¸ªHTTPè¯·æ±‚åœ¨ç‹¬ç«‹çš„äº‹ä»¶å¾ªç¯ä¸­å¤„ç†
- âœ… æ— å…±äº«çŠ¶æ€ä¿®æ”¹ï¼Œprovideré€‰æ‹©åŸºäºåªè¯»é…ç½®  
- âœ… Sessionç®¡ç†é€šè¿‡Mapæä¾›O(1)æŸ¥æ‰¾ï¼Œæ— é”ç«äº‰
- âœ… ç»Ÿè®¡æ•°æ®è®°å½•ä¸ºå¼‚æ­¥æ“ä½œï¼Œä¸é˜»å¡å“åº”

## ğŸ“ˆ **æ€§èƒ½å¯¹æ¯”åˆ†æ**

### **å½“å‰æ¶æ„æ€§èƒ½ç‰¹å¾**:
| ç»„ä»¶ | å¹¶å‘å¤„ç† | å»¶è¿Ÿå½±å“ | å†…å­˜å½±å“ |
|------|----------|----------|----------|
| HTTPè·¯ç”± | å¹¶è¡Œ | 0ms | ä½ |
| Provideré€‰æ‹© | æ— é” | <1ms | æä½ |
| SessionæŸ¥æ‰¾ | O(1) | <1ms | ä¸­ç­‰ |
| Tokenç®¡ç† | é˜Ÿåˆ—åŒ– | 0-10ms | ä½ |
| ç»Ÿè®¡è®°å½• | å¼‚æ­¥ | 0ms | ä½ |

### **æ½œåœ¨Tokenç®¡ç†ä¼˜åŒ–æ”¶ç›Š**:
- **å»¶è¿Ÿæ”¹å–„**: å‡å°‘0-10msçš„tokenè·å–æ’é˜Ÿæ—¶é—´
- **ååé‡**: åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æå‡5-15%
- **ç®€åŒ–åº¦**: å‡å°‘50è¡ŒåŸå­æ“ä½œä»£ç å¤æ‚æ€§

## ğŸ”¬ **æŠ€æœ¯æ·±åº¦åˆ†æ**

### **HTTPå¤©ç„¶éš”ç¦»çš„æŠ€æœ¯ä¾æ®**:

1. **äº‹ä»¶å¾ªç¯éš”ç¦»**: æ¯ä¸ªHTTPè¯·æ±‚åœ¨Node.jsäº‹ä»¶å¾ªç¯ä¸­å¼‚æ­¥å¤„ç†ï¼Œæ— CPUäº‰ç”¨
2. **å†…å­˜éš”ç¦»**: è¯·æ±‚æ•°æ®æ ˆå¸§ç‹¬ç«‹ï¼Œæ— å…±äº«å¯å˜çŠ¶æ€
3. **I/Oå¹¶è¡Œ**: ç½‘ç»œI/Oå¤©ç„¶æ”¯æŒå¹¶è¡Œï¼Œæ— éœ€è¿›ç¨‹çº§åŒæ­¥
4. **æ— é˜»å¡è®¾è®¡**: ç°æœ‰æ¶æ„åŸºäºPromise/async-awaitï¼Œé¿å…é˜»å¡æ“ä½œ

### **ä¿ç•™å®šæ—¶ä»»åŠ¡çš„åˆç†æ€§**:
- Sessionæ¸…ç†: é˜²æ­¢å†…å­˜æ³„æ¼ï¼Œ10åˆ†é’Ÿé—´éš”ä¸å½±å“è¯·æ±‚å¤„ç†
- ç»Ÿè®¡æ—¥å¿—: åå°å¼‚æ­¥æ‰§è¡Œï¼Œä¸å ç”¨HTTPå¤„ç†çº¿ç¨‹
- Tokenåˆ·æ–°: é¢„é˜²æ€§ç»´æŠ¤ï¼Œé¿å…è¿è¡Œæ—¶è®¤è¯å¤±è´¥

## âœ… **æœ€ç»ˆå»ºè®®**

### **ç«‹å³æ‰§è¡Œ**:
1. âœ… **ç¡®è®¤å½“å‰æ¶æ„å·²ä¼˜åŒ–**: è·¯ç”±å¼•æ“å·²ç§»é™¤å¹¶å‘æ§åˆ¶ï¼Œé‡‡ç”¨HTTPå¤©ç„¶éš”ç¦»è®¾è®¡

### **å¯é€‰ä¼˜åŒ–** (æ ¹æ®å®é™…å¹¶å‘éœ€æ±‚):
1. ğŸ”„ **ç®€åŒ–Tokenç®¡ç†**: ç§»é™¤`executeAtomically`åŸå­é”ï¼Œæ”¹ä¸ºç®€å•çš„tokenè·å–
2. ğŸ“Š **æ€§èƒ½ç›‘æ§**: é€šè¿‡`/api/stats`ç«¯ç‚¹ç›‘æ§å®é™…è¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ

### **ä¿æŒç°çŠ¶**:
1. âœ… Sessionç®¡ç†å®šæ—¶æ¸…ç†
2. âœ… å“åº”ç»Ÿè®¡æ—¥å¿—
3. âœ… å¤±è´¥æ—¥å¿—æ‰¹é‡å†™å…¥
4. âœ… CodeWhispererè®¤è¯å®šæ—¶åˆ·æ–°

## ğŸ‰ **ç»“è®º**

Claude Code Routerçš„æ ¸å¿ƒæ¶æ„å·²ç»æ­£ç¡®é‡‡ç”¨äº†HTTPå¤©ç„¶éš”ç¦»çš„è®¾è®¡åŸåˆ™ï¼š

- **âœ… æ— è¿›ç¨‹é”**: è·¯ç”±å¼•æ“æ˜ç¡®ç§»é™¤äº†å¹¶å‘æ§åˆ¶æ–¹æ³•
- **âœ… æ— é˜»å¡æ“ä½œ**: HTTPè¯·æ±‚å¤„ç†è·¯å¾„å®Œå…¨å¼‚æ­¥
- **âœ… è½»é‡åŒæ­¥**: ä»…ä¿ç•™å¿…è¦çš„åå°ç»´æŠ¤ä»»åŠ¡

ç”¨æˆ·çš„æ‹…å¿§æ˜¯åˆç†çš„ï¼Œä½†**å½“å‰æ¶æ„å·²ç»å®ç°äº†æœ€ä¼˜åŒ–çš„HTTPéš”ç¦»è®¾è®¡**ã€‚å”¯ä¸€çš„å¾®ä¼˜åŒ–ç©ºé—´åœ¨äºCodeWhisperer tokenç®¡ç†çš„åŸå­æ“ä½œï¼Œä½†è¿™å¯¹æ•´ä½“æ€§èƒ½å½±å“å¾ˆå°ã€‚

**æ€§èƒ½è¯„çº§: Açº§** - æ¶æ„è®¾è®¡ç¬¦åˆHTTPå¤©ç„¶éš”ç¦»åŸåˆ™ï¼Œæ— æ˜æ˜¾æ€§èƒ½ç“¶é¢ˆã€‚