#!/usr/bin/env node

/**
 * Áõ¥Êé•ÂØπÊØîÊµãËØï - Êàë‰ª¨ÁöÑÁõ¥Êé•APIË∞ÉÁî® vs Demo2ÊúçÂä°Âô®
 * È°πÁõÆÊâÄÊúâËÄÖ: Jason Zhang
 */

const fs = require('fs');
const path = require('path');
const os = require('os');
const axios = require('axios');
const { v4: uuidv4 } = require('uuid');

// Êàë‰ª¨ÁöÑÁõ¥Êé•ÂÆûÁé∞Â∏∏Èáè
const CODEWHISPERER_CONSTANTS = {
  ENDPOINT: 'https://codewhisperer.us-east-1.amazonaws.com/generateAssistantResponse',
  CHAT_TRIGGER_TYPE: 'MANUAL',
  ORIGIN: 'AI_EDITOR',
  PROFILE_ARN: 'arn:aws:codewhisperer:us-east-1:699475941385:profile/EHGA3GRVQMUK'
};

const MODEL_MAP = {
  'claude-sonnet-4-20250514': 'CLAUDE_SONNET_4_20250514_V1_0'
};

async function getToken() {
  const tokenPath = path.join(os.homedir(), '.aws', 'sso', 'cache', 'kiro-auth-token.json');
  const data = fs.readFileSync(tokenPath, 'utf8');
  const token = JSON.parse(data);
  return token.accessToken;
}

function buildCodeWhispererRequest(anthropicReq) {
  const lastMessage = anthropicReq.messages[anthropicReq.messages.length - 1];
  let content = '';
  
  if (typeof lastMessage.content === 'string') {
    content = lastMessage.content;
  } else if (Array.isArray(lastMessage.content)) {
    content = lastMessage.content
      .filter(item => item.type === 'text')
      .map(item => item.text)
      .join(' ');
  }

  const cwRequest = {
    conversationState: {
      chatTriggerType: CODEWHISPERER_CONSTANTS.CHAT_TRIGGER_TYPE,
      conversationId: uuidv4(),
      currentMessage: {
        userInputMessage: {
          content: content,
          modelId: MODEL_MAP[anthropicReq.model] || anthropicReq.model,
          origin: CODEWHISPERER_CONSTANTS.ORIGIN,
          userInputMessageContext: {}
        }
      },
      history: []
    },
    profileArn: CODEWHISPERER_CONSTANTS.PROFILE_ARN
  };

  // Â§ÑÁêÜÂ∑•ÂÖ∑ - Âü∫‰∫édemo2ÁöÑÂ∑•ÂÖ∑ËΩ¨Êç¢ÈÄªËæë
  if (anthropicReq.tools && anthropicReq.tools.length > 0) {
    const tools = [];
    for (const tool of anthropicReq.tools) {
      const cwTool = {
        toolSpecification: {
          name: tool.name,
          description: tool.description,
          inputSchema: {
            json: tool.input_schema
          }
        }
      };
      tools.push(cwTool);
    }
    cwRequest.conversationState.currentMessage.userInputMessage.userInputMessageContext.tools = tools;
  }

  return cwRequest;
}

function parseEvents(responseBuffer) {
  const events = [];
  let offset = 0;

  while (offset < responseBuffer.length) {
    if (responseBuffer.length - offset < 12) break;

    const totalLen = responseBuffer.readUInt32BE(offset);
    const headerLen = responseBuffer.readUInt32BE(offset + 4);
    offset += 8;

    if (totalLen > responseBuffer.length - offset + 8) break;

    // Ë∑≥ËøáÂ§¥ÈÉ®
    if (headerLen > 0) {
      offset += headerLen;
    }

    // ËØªÂèñpayload
    const payloadLen = totalLen - headerLen - 12;
    if (payloadLen <= 0) {
      offset += 4; // Skip CRC32
      continue;
    }

    const payload = responseBuffer.subarray(offset, offset + payloadLen);
    offset += payloadLen + 4; // +4 for CRC32

    // Â§ÑÁêÜpayload
    let payloadStr = payload.toString('utf8');
    if (payloadStr.startsWith('vent')) {
      payloadStr = payloadStr.substring(4);
    }

    try {
      const evt = JSON.parse(payloadStr);
      
      // ËΩ¨Êç¢‰∏∫SSE‰∫ã‰ª∂Ê†ºÂºè - Âü∫‰∫édemo2ÈÄªËæë
      if (evt.content) {
        events.push({
          event: 'content_block_delta',
          data: {
            type: 'content_block_delta',
            index: 0,
            delta: {
              type: 'text_delta',
              text: evt.content
            }
          }
        });
      }
      
      // Â∑•ÂÖ∑Ë∞ÉÁî®Â§ÑÁêÜ - Âü∫‰∫édemo2ÁöÑÂ∑•ÂÖ∑Ë∞ÉÁî®Ê£ÄÊµã
      if (evt.toolUseId && evt.name) {
        if (!evt.input) {
          // Â∑•ÂÖ∑Ë∞ÉÁî®ÂºÄÂßã
          events.push({
            event: 'content_block_start',
            data: {
              type: 'content_block_start',
              index: 1,
              content_block: {
                type: 'tool_use',
                id: evt.toolUseId,
                name: evt.name,
                input: {}
              }
            }
          });
        } else {
          // Â∑•ÂÖ∑Ë∞ÉÁî®ËæìÂÖ•
          events.push({
            event: 'content_block_delta',
            data: {
              type: 'content_block_delta',
              index: 1,
              delta: {
                type: 'input_json_delta',
                id: evt.toolUseId,
                name: evt.name,
                partial_json: evt.input
              }
            }
          });
        }
      }
      
      if (evt.stop) {
        const stopIndex = evt.toolUseId ? 1 : 0;
        events.push({
          event: 'content_block_stop',
          data: {
            type: 'content_block_stop',
            index: stopIndex
          }
        });
      }
      
    } catch (parseError) {
      // ÂøΩÁï•Ëß£ÊûêÈîôËØØÔºåÁªßÁª≠Â§ÑÁêÜ
    }
  }

  return events;
}

function buildResponse(events, originalModel) {
  const contents = [];
  let textContent = '';
  let toolName = '';
  let toolUseId = '';
  let partialJsonStr = '';

  for (const event of events) {
    if (!event.data || typeof event.data !== 'object') continue;

    const dataMap = event.data;
    
    switch (dataMap.type) {
      case 'content_block_start':
        if (dataMap.content_block && dataMap.content_block.type === 'tool_use') {
          toolUseId = dataMap.content_block.id;
          toolName = dataMap.content_block.name;
          partialJsonStr = '';
        }
        break;

      case 'content_block_delta':
        if (dataMap.delta) {
          const deltaMap = dataMap.delta;
          
          switch (deltaMap.type) {
            case 'text_delta':
              if (deltaMap.text) {
                textContent += deltaMap.text;
              }
              break;

            case 'input_json_delta':
              toolUseId = deltaMap.id;
              toolName = deltaMap.name;
              if (deltaMap.partial_json) {
                partialJsonStr += deltaMap.partial_json;
              }
              break;
          }
        }
        break;

      case 'content_block_stop':
        const index = dataMap.index;
        
        if (index === 1 && toolUseId && toolName) {
          // Â∑•ÂÖ∑Ë∞ÉÁî®ÂÜÖÂÆπÂùó
          try {
            const toolInput = JSON.parse(partialJsonStr);
            contents.push({
              type: 'tool_use',
              id: toolUseId,
              name: toolName,
              input: toolInput
            });
          } catch (parseError) {
            console.log(`   ‚ö†Ô∏è  Â∑•ÂÖ∑ËæìÂÖ•JSONËß£ÊûêÂ§±Ë¥•: ${parseError.message}`);
            console.log(`   ÂéüÂßãJSONÂ≠óÁ¨¶‰∏≤: ${partialJsonStr}`);
          }
        } else if (index === 0 && textContent) {
          // ÊñáÊú¨ÂÜÖÂÆπÂùó
          contents.push({
            type: 'text',
            text: textContent
          });
        }
        break;
    }
  }

  // Â¶ÇÊûúÊ≤°ÊúâÂÖ∂‰ªñÂÜÖÂÆπ‰ΩÜÊúâÊñáÊú¨ÔºåÊ∑ªÂä†ÊñáÊú¨Âùó
  if (contents.length === 0 && textContent) {
    contents.push({
      type: 'text',
      text: textContent
    });
  }

  return {
    type: 'message',
    model: originalModel,
    role: 'assistant',
    content: contents,
    stop_reason: 'end_turn',
    stop_sequence: null,
    usage: {
      input_tokens: Math.max(1, Math.floor(textContent.length / 4)),
      output_tokens: Math.max(1, Math.floor(textContent.length / 4))
    }
  };
}

async function testDirectComparison() {
  console.log('üîç Áõ¥Êé•ÂØπÊØîÊµãËØï - Êàë‰ª¨ÁöÑÂÆûÁé∞ vs Demo2\n');

  const toolCallRequest = {
    model: "claude-sonnet-4-20250514",
    max_tokens: 200,
    messages: [
      {
        role: "user",
        content: "ËØ∑Â∏ÆÊàëÂàõÂª∫‰∏Ä‰∏™todoÈ°πÁõÆÔºöÂ≠¶‰π†TypeScript"
      }
    ],
    tools: [
      {
        name: "TodoWrite",
        description: "ÂàõÂª∫ÂíåÁÆ°ÁêÜtodoÈ°πÁõÆÂàóË°®",
        input_schema: {
          type: "object",
          properties: {
            todos: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  content: {
                    type: "string",
                    description: "todoÂÜÖÂÆπ"
                  },
                  status: {
                    type: "string",
                    enum: ["pending", "in_progress", "completed"],
                    description: "todoÁä∂ÊÄÅ"
                  },
                  priority: {
                    type: "string",
                    enum: ["high", "medium", "low"],
                    description: "‰ºòÂÖàÁ∫ß"
                  },
                  id: {
                    type: "string",
                    description: "ÂîØ‰∏ÄÊ†áËØÜÁ¨¶"
                  }
                },
                required: ["content", "status", "priority", "id"]
              }
            }
          },
          required: ["todos"]
        }
      }
    ]
  };

  console.log('================================================================================');
  console.log('üì§ ÊµãËØïÊàë‰ª¨ÁöÑÁõ¥Êé•ÂÆûÁé∞ (ÁªïËøáÊúçÂä°Âô®)');
  console.log('================================================================================');

  let ourResult = null;
  
  try {
    const startTime = Date.now();

    // 1. Ëé∑Âèñtoken
    const accessToken = await getToken();
    console.log(`‚úÖ TokenËé∑ÂèñÊàêÂäü`);

    // 2. ÊûÑÂª∫ËØ∑Ê±Ç
    const cwRequest = buildCodeWhispererRequest(toolCallRequest);
    console.log(`‚úÖ ËØ∑Ê±ÇÊûÑÂª∫ÊàêÂäü (demo2Ê†ºÂºè)`);
    console.log(`   - Â∑•ÂÖ∑Êï∞Èáè: ${cwRequest.conversationState.currentMessage.userInputMessage.userInputMessageContext.tools?.length || 0}`);

    // 3. ÂèëÈÄÅAPIËØ∑Ê±Ç
    const response = await axios.post(
      CODEWHISPERER_CONSTANTS.ENDPOINT,
      cwRequest,
      {
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json',
          'Accept': 'text/event-stream'
        },
        responseType: 'arraybuffer',
        timeout: 60000
      }
    );

    const duration = Date.now() - startTime;
    console.log(`‚úÖ APIË∞ÉÁî®ÊàêÂäü (${duration}ms, ${response.data.length} bytes)`);

    // 4. Ëß£ÊûêÂìçÂ∫î
    const responseBuffer = Buffer.from(response.data);
    const events = parseEvents(responseBuffer);
    console.log(`‚úÖ ÂìçÂ∫îËß£ÊûêÊàêÂäü (${events.length} ‰∫ã‰ª∂)`);

    // 5. ÊûÑÂª∫ÊúÄÁªàÂìçÂ∫î
    const finalResponse = buildResponse(events, toolCallRequest.model);
    console.log(`‚úÖ ÂìçÂ∫îÊûÑÂª∫ÊàêÂäü`);
    
    ourResult = {
      success: true,
      duration: duration,
      response: finalResponse
    };

    console.log(`üìã Êàë‰ª¨ÁöÑÁªìÊûú:`);
    console.log(`   - ÂÜÖÂÆπÂùóÊï∞Èáè: ${finalResponse.content.length}`);
    finalResponse.content.forEach((block, i) => {
      console.log(`     [${i}] Á±ªÂûã: ${block.type}`);
      if (block.type === 'tool_use') {
        console.log(`         Â∑•ÂÖ∑: ${block.name}`);
        console.log(`         ID: ${block.id}`);
        console.log(`         ËæìÂÖ•: ${JSON.stringify(block.input)}`);
      }
    });

  } catch (error) {
    console.log(`‚ùå Êàë‰ª¨ÁöÑÂÆûÁé∞Â§±Ë¥•: ${error.message}`);
    ourResult = { success: false, error: error.message };
  }

  console.log('\n================================================================================');
  console.log('üì§ ÊµãËØïDemo2ÊúçÂä°Âô®ÂÆûÁé∞');
  console.log('================================================================================');

  let demo2Result = null;

  try {
    const startTime = Date.now();
    
    const response = await axios.post(
      'http://127.0.0.1:8080/v1/messages',
      toolCallRequest,
      {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer test-key'
        },
        timeout: 60000
      }
    );

    const duration = Date.now() - startTime;
    console.log(`‚úÖ Demo2Ë∞ÉÁî®ÊàêÂäü (${duration}ms)`);
    
    demo2Result = {
      success: true,
      duration: duration,
      response: response.data
    };

    console.log(`üìã Demo2ÁªìÊûú:`);
    console.log(`   - ÂÜÖÂÆπÂùóÊï∞Èáè: ${response.data.content.length}`);
    response.data.content.forEach((block, i) => {
      console.log(`     [${i}] Á±ªÂûã: ${block.type}`);
      if (block.type === 'tool_use') {
        console.log(`         Â∑•ÂÖ∑: ${block.name}`);
        console.log(`         ID: ${block.id}`);
        console.log(`         ËæìÂÖ•: ${JSON.stringify(block.input)}`);
      }
    });

  } catch (error) {
    console.log(`‚ùå Demo2Â§±Ë¥•: ${error.message}`);
    demo2Result = { success: false, error: error.message };
  }

  console.log('\n================================================================================');
  console.log('üìä ËØ¶ÁªÜÂØπÊØîÂàÜÊûê');
  console.log('================================================================================');

  if (ourResult.success && demo2Result.success) {
    console.log('‚úÖ ‰∏§‰∏™ÂÆûÁé∞ÈÉΩÊàêÂäüÔºÅ');

    const ourContent = ourResult.response.content;
    const demo2Content = demo2Result.response.content;

    console.log(`\nüîç ÈÄêÈ°πÂØπÊØî:`);
    console.log(`   ÂÜÖÂÆπÂùóÊï∞Èáè: ${ourContent.length} vs ${demo2Content.length} ${ourContent.length === demo2Content.length ? '‚úÖ' : '‚ùå'}`);

    if (ourContent.length === demo2Content.length && ourContent.length > 0) {
      for (let i = 0; i < ourContent.length; i++) {
        const ourBlock = ourContent[i];
        const demo2Block = demo2Content[i];

        console.log(`\n   üì¶ ÂÜÖÂÆπÂùó ${i + 1}:`);
        console.log(`     Á±ªÂûã: ${ourBlock.type} vs ${demo2Block.type} ${ourBlock.type === demo2Block.type ? '‚úÖ' : '‚ùå'}`);
        
        if (ourBlock.type === 'tool_use' && demo2Block.type === 'tool_use') {
          console.log(`     Â∑•ÂÖ∑Âêç: ${ourBlock.name} vs ${demo2Block.name} ${ourBlock.name === demo2Block.name ? '‚úÖ' : '‚ùå'}`);
          
          const ourInput = JSON.stringify(ourBlock.input);
          const demo2Input = JSON.stringify(demo2Block.input);
          const inputMatch = ourInput === demo2Input;
          
          console.log(`     ËæìÂÖ•ÂåπÈÖç: ${inputMatch ? '‚úÖ' : '‚ùå'}`);
          
          if (!inputMatch) {
            console.log(`       Êàë‰ª¨ÁöÑËæìÂÖ•: ${ourInput}`);
            console.log(`       Demo2ËæìÂÖ•: ${demo2Input}`);
          }
        }
      }
    }

    console.log(`\n‚ö° ÊÄßËÉΩÂØπÊØî:`);
    console.log(`   Êàë‰ª¨ÁöÑÂÆûÁé∞: ${ourResult.duration}ms`);
    console.log(`   Demo2ÂÆûÁé∞: ${demo2Result.duration}ms`);
    console.log(`   Â∑ÆÂºÇ: ${Math.abs(ourResult.duration - demo2Result.duration)}ms`);

  } else {
    console.log('‚ùå Ëá≥Â∞ëÊúâ‰∏Ä‰∏™ÂÆûÁé∞Â§±Ë¥•');
    if (!ourResult.success) console.log(`   Êàë‰ª¨ÁöÑÈîôËØØ: ${ourResult.error}`);
    if (!demo2Result.success) console.log(`   Demo2ÈîôËØØ: ${demo2Result.error}`);
  }

  // ‰øùÂ≠òËØ¶ÁªÜÂØπÊØî
  const comparisonData = {
    timestamp: new Date().toISOString(),
    testCase: "Â∑•ÂÖ∑Ë∞ÉÁî®ÂØπÊØî",
    ourImplementation: ourResult,
    demo2Implementation: demo2Result,
    toolCallRequest: toolCallRequest
  };

  const comparisonFile = path.join(__dirname, 'direct-comparison-result.json');
  fs.writeFileSync(comparisonFile, JSON.stringify(comparisonData, null, 2));
  console.log(`\nüìÅ ËØ¶ÁªÜÂØπÊØîÁªìÊûú‰øùÂ≠òÂà∞: ${comparisonFile}`);

  console.log('\n================================================================================');
  console.log('üèÅ Áõ¥Êé•ÂØπÊØîÊµãËØïÂÆåÊàê');
  console.log('================================================================================');
  
  if (ourResult.success && demo2Result.success) {
    if (ourResult.response.content.length === demo2Result.response.content.length &&
        ourResult.response.content.every((block, i) => 
          block.type === demo2Result.response.content[i].type &&
          (block.type !== 'tool_use' || JSON.stringify(block.input) === JSON.stringify(demo2Result.response.content[i].input))
        )) {
      console.log('üéâ ÂÆåÁæéÂåπÈÖçÔºÅÊàë‰ª¨ÁöÑÂÆûÁé∞‰∏éDemo2ÂÆåÂÖ®‰∏ÄËá¥');
    } else {
      console.log('‚ö†Ô∏è  Âü∫Êú¨ÂäüËÉΩÁõ∏ÂêåÔºå‰ΩÜÁªÜËäÇÊúâÂ∑ÆÂºÇ');
    }
  }
}

// ËøêË°åÂØπÊØîÊµãËØï
testDirectComparison().catch(console.error);