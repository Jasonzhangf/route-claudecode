# 全面错误处理覆盖测试

## 测试用例
验证Claude Code Router的错误处理系统完整性，确保所有错误都返回正确的HTTP状态码，禁止沉默失败。

## 测试目标
1. **零沉默失败**: 验证所有错误场景都有适当的HTTP状态码和错误响应
2. **错误格式标准化**: 确保所有错误响应都包含必要的错误信息
3. **流式/非流式错误处理**: 验证两种响应模式的错误处理一致性
4. **Provider错误传播**: 确保Provider错误正确传播到客户端
5. **错误分类覆盖**: 测试所有主要错误类别的处理机制

## 测试分类

### 1. 流式请求错误 (Streaming Errors)
- **无效模型名称**: 流式请求使用不存在的模型
- **空消息数组**: 流式请求缺少必要的messages数组
- **格式错误请求**: 流式请求缺少必要字段

### 2. 非流式请求错误 (Non-Streaming Errors)  
- **无效模型名称**: 非流式请求使用不存在的模型
- **Max Tokens超限**: 设置过小的max_tokens导致的错误

### 3. Provider错误 (Provider Errors)
- **健康检查**: 测试Provider服务状态检查
- **服务不可用**: Provider服务不可达时的错误处理

### 4. 网络错误 (Network Errors)
- **连接被拒绝**: 测试ECONNREFUSED错误处理
- **连接超时**: 测试网络超时错误处理

### 5. 认证错误 (Authentication Errors)
- **缺少认证头**: 请求缺少必要的认证信息
- **无效Token**: 使用无效的认证令牌

### 6. Max Tokens错误 (Max Tokens Errors)
- **Token限制超限**: 专门测试max_tokens错误处理机制

### 7. 工具调用错误 (Tool Call Errors)
- **无效工具定义**: 测试格式错误的工具定义
- **工具调用失败**: 测试工具调用过程中的错误

### 8. 路由错误 (Routing Errors)
- **不支持的端点**: 请求不存在的API端点
- **HTTP方法错误**: 使用错误的HTTP方法

## 沉默失败检测机制

### 检测条件
1. **状态码检查**: 错误发生但状态码仍为200
2. **错误格式检查**: 错误状态码但缺少适当的错误响应格式
3. **流式错误检查**: 流式请求错误但缺少`event: error`
4. **连接状态检查**: 流式错误但连接未正确关闭

### 错误格式验证
- **流式响应**: 必须包含`event: error`和`data:`字段
- **非流式响应**: 必须包含`error`对象，包含`type`和`message`字段
- **状态码匹配**: HTTP状态码必须与错误类型匹配

## 测试执行记录

### 最近执行记录
- **时间**: 2025-08-06 T04:12:00Z  
- **状态**: 待执行
- **执行时长**: N/A
- **日志文件**: `/tmp/error-handling-coverage-test-[timestamp].json`

### 预期结果指标
- **总测试数**: 15-20个测试用例
- **通过率目标**: ≥90%
- **沉默失败率目标**: 0%
- **错误格式合规率目标**: 100%

## 测试配置
- **测试端口**: 5508 (ShuaiHong OpenAI兼容服务)
- **超时设置**: 10秒
- **重试机制**: 禁用 (为了准确测试错误处理)
- **验证模式**: 接受所有HTTP状态码进行分析

## 相关文件
- **测试脚本**: `test/functional/test-comprehensive-error-handling-coverage.js`
- **错误处理系统**: `src/utils/error-handler.ts`
- **错误诊断系统**: `src/utils/error-system-diagnostics.ts`
- **服务器错误处理**: `src/server.ts`

## 执行方式
```bash
# 运行完整覆盖测试
./test-runner.sh test/functional/test-comprehensive-error-handling-coverage.js

# 或直接执行
node test/functional/test-comprehensive-error-handling-coverage.js
```

## 成功标准
1. **零沉默失败**: 沉默失败率必须为0%
2. **高通过率**: 测试通过率应≥90%
3. **标准错误格式**: 所有错误响应必须符合格式规范
4. **状态码正确性**: 所有错误都有对应的HTTP状态码
5. **详细错误信息**: 错误响应包含provider、model、stage等关键信息

## 失败处理
如果检测到沉默失败：
1. **立即报告**: 输出详细的沉默失败信息
2. **强制修复**: 更新错误处理代码确保返回适当状态码
3. **重新测试**: 修复后重新执行覆盖测试
4. **记录经验**: 更新项目记忆系统记录修复经验

## 历史执行记录
- **2025-08-06**: 测试脚本创建，准备执行覆盖测试