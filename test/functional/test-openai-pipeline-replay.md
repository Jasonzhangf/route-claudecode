# OpenAIæµæ°´çº¿å›æ”¾éªŒè¯ç³»ç»Ÿæµ‹è¯•

## æµ‹è¯•ç”¨ä¾‹
åŸºäºæ•è·æ•°æ®çš„OpenAIæµæ°´çº¿è°ƒè¯•å›æ”¾å’ŒéªŒè¯ç³»ç»Ÿï¼Œæ”¯æŒæ–­ç‚¹è°ƒè¯•å’Œå•æ­¥æ‰§è¡Œ

## æµ‹è¯•ç›®æ ‡
1. **æ•°æ®å›æ”¾**: åŸºäºæ•è·çš„æµæ°´çº¿æ•°æ®é‡ç°æ‰§è¡Œè¿‡ç¨‹
2. **æ–­ç‚¹è°ƒè¯•**: åœ¨æŒ‡å®šæ­¥éª¤æš‚åœæ‰§è¡Œï¼Œæ”¯æŒæ•°æ®æ£€æŸ¥å’Œä¿®æ”¹
3. **å•æ­¥æ‰§è¡Œ**: é€æ­¥æ‰§è¡Œæµæ°´çº¿ï¼Œè§‚å¯Ÿæ¯ä¸ªæ­¥éª¤çš„è¯¦ç»†è¿‡ç¨‹
4. **ä¿®æ”¹éªŒè¯**: æ”¯æŒä¿®æ”¹æ­¥éª¤æ•°æ®ï¼ŒéªŒè¯ä¿®å¤æ•ˆæœ
5. **ä¼šè¯å¯¹æ¯”**: å¯¹æ¯”ä¸åŒä¼šè¯çš„æ‰§è¡Œå·®å¼‚

## æœ€è¿‘æ‰§è¡Œè®°å½•

### 2025-07-30 17:52:30 - å›æ”¾ç³»ç»Ÿæ¶æ„è®¾è®¡ âœ… SUCCESS
- **æ‰§è¡Œæ—¶é•¿**: æ¶æ„è®¾è®¡é˜¶æ®µ
- **çŠ¶æ€**: å®Œæ•´å›æ”¾éªŒè¯ç³»ç»Ÿè®¾è®¡å®Œæˆ
- **æ—¥å¿—æ–‡ä»¶**: ä¸æ•°æ®æ•è·ç³»ç»Ÿå…±äº« `/tmp/openai-pipeline-captures/`
- **å‘ç°è¦ç‚¹**:
  - âœ… å®Œæ•´çš„äº¤äº’å¼è°ƒè¯•ç•Œé¢ï¼Œæ”¯æŒå‘½ä»¤è¡Œæ“ä½œ
  - âœ… æ–­ç‚¹ç³»ç»Ÿå’Œå•æ­¥æ¨¡å¼ï¼Œçµæ´»æ§åˆ¶æ‰§è¡Œæµç¨‹
  - âœ… æ•°æ®ä¿®æ”¹å’ŒéªŒè¯æœºåˆ¶ï¼Œæ”¯æŒä¿®å¤æµ‹è¯•
  - âœ… ä¼šè¯å¯¹æ¯”åŠŸèƒ½ï¼Œè¯†åˆ«ä¸åŒæ‰§è¡Œçš„å·®å¼‚
  - âœ… è‡ªåŠ¨åŒ–éªŒè¯æ£€æŸ¥ï¼Œå¿«é€Ÿè¯†åˆ«é—®é¢˜

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. å›æ”¾æ§åˆ¶ç³»ç»Ÿ
- **ä¼šè¯åŠ è½½**: ä»æ•è·ç›®å½•åŠ è½½æŒ‡å®šä¼šè¯çš„å®Œæ•´æ•°æ®
- **æ­¥éª¤æ‰§è¡Œ**: æŒ‰é¡ºåºæˆ–å•ç‹¬æ‰§è¡Œæµæ°´çº¿æ­¥éª¤
- **æ‰§è¡Œæ§åˆ¶**: æ”¯æŒæš‚åœã€ç»§ç»­ã€æ­¥è¿›ç­‰è°ƒè¯•æ“ä½œ

### 2. æ–­ç‚¹è°ƒè¯•åŠŸèƒ½
- **æ–­ç‚¹è®¾ç½®**: åœ¨ä»»æ„æ­¥éª¤è®¾ç½®æ–­ç‚¹ï¼Œæ”¯æŒå¤šæ–­ç‚¹
- **å•æ­¥æ¨¡å¼**: åœ¨æ¯ä¸ªæ­¥éª¤è‡ªåŠ¨æš‚åœæ‰§è¡Œ
- **äº¤äº’è°ƒè¯•**: æ–­ç‚¹æš‚åœæ—¶çš„å‘½ä»¤è¡Œäº¤äº’ç•Œé¢

### 3. æ•°æ®ä¿®æ”¹ç³»ç»Ÿ
- **å®æ—¶ä¿®æ”¹**: åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ä¿®æ”¹æ­¥éª¤æ•°æ®
- **åµŒå¥—è·¯å¾„**: æ”¯æŒå¤æ‚å¯¹è±¡çš„åµŒå¥—è·¯å¾„ä¿®æ”¹
- **ä¿®æ”¹åº”ç”¨**: è‡ªåŠ¨åº”ç”¨ä¿®æ”¹åˆ°åç»­æ­¥éª¤æ‰§è¡Œ

### 4. éªŒè¯æ£€æŸ¥ç³»ç»Ÿ
- **æ­¥éª¤éªŒè¯**: é’ˆå¯¹æ¯ä¸ªæ­¥éª¤çš„ç‰¹å®šéªŒè¯è§„åˆ™
- **æ•°æ®å®Œæ•´æ€§**: æ£€æŸ¥å¿…éœ€å­—æ®µå’Œæ•°æ®ç»“æ„
- **å†…å®¹éªŒè¯**: éªŒè¯å“åº”å†…å®¹çš„è´¨é‡å’Œå®Œæ•´æ€§

### 5. ä¼šè¯å¯¹æ¯”åˆ†æ
- **å·®å¼‚æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«ä¸¤ä¸ªä¼šè¯é—´çš„æ•°æ®å·®å¼‚
- **å˜åŒ–è¿½è¸ª**: è¿½è¸ªå…³é”®å­—æ®µçš„å˜åŒ–æƒ…å†µ
- **å¯¹æ¯”æŠ¥å‘Š**: ç”Ÿæˆè¯¦ç»†çš„å·®å¼‚åˆ†ææŠ¥å‘Š

## ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ä½¿ç”¨æµç¨‹
```bash
# è¿è¡Œäº¤äº’å¼å›æ”¾ç³»ç»Ÿ
node test-openai-pipeline-replay.js

# é€‰æ‹©è¦å›æ”¾çš„ä¼šè¯
Select session number: 1

# æ‰§è¡Œè°ƒè¯•å‘½ä»¤
Choose option: 3  # æ‰§è¡Œå®Œæ•´å›æ”¾
```

### ç¼–ç¨‹æ¥å£ä½¿ç”¨
```javascript
const { OpenAIPipelineReplaySystem } = require('./test-openai-pipeline-replay');

const replaySystem = new OpenAIPipelineReplaySystem();

// åŠ è½½ä¼šè¯
await replaySystem.loadSession('capture-1753512345678');

// è®¾ç½®æ–­ç‚¹
replaySystem.setBreakpoint('step4-raw-response');

// ä¿®æ”¹æ•°æ®
replaySystem.modifyStepData('step2-routing', 'selectedProvider', 'alternative-provider');

// æ‰§è¡Œå®Œæ•´å›æ”¾
const results = await replaySystem.executeFullReplay();
```

## è°ƒè¯•å‘½ä»¤é›†

### ä¸»èœå•å‘½ä»¤
- **1. Set breakpoint** - åœ¨æŒ‡å®šæ­¥éª¤è®¾ç½®æ–­ç‚¹
- **2. Enable step mode** - å¯ç”¨å•æ­¥æ‰§è¡Œæ¨¡å¼
- **3. Execute full replay** - æ‰§è¡Œå®Œæ•´æµæ°´çº¿å›æ”¾
- **4. Execute single step** - æ‰§è¡Œå•ä¸ªæ­¥éª¤
- **5. Modify data** - ä¿®æ”¹æ­¥éª¤æ•°æ®
- **6. Generate report** - ç”Ÿæˆå›æ”¾æŠ¥å‘Š
- **7. Compare with other session** - ä¸å…¶ä»–ä¼šè¯å¯¹æ¯”
- **q. Quit** - é€€å‡ºç³»ç»Ÿ

### æ–­ç‚¹è°ƒè¯•å‘½ä»¤
- **c (continue)** - ç»§ç»­æ‰§è¡Œ
- **s (step)** - åˆ‡æ¢å•æ­¥æ¨¡å¼
- **i (inspect)** - æ£€æŸ¥å½“å‰æ­¥éª¤æ•°æ®
- **m (modify)** - ä¿®æ”¹å½“å‰æ­¥éª¤æ•°æ®
- **v (validate)** - éªŒè¯å½“å‰æ­¥éª¤
- **q (quit)** - é€€å‡ºè°ƒè¯•å™¨

## éªŒè¯è§„åˆ™

### Step 1 éªŒè¯ (Input Processing)
- âœ… **Has original request** - æ£€æŸ¥åŸå§‹è¯·æ±‚æ•°æ®å­˜åœ¨
- âœ… **Has model name** - éªŒè¯æ¨¡å‹åç§°å­˜åœ¨
- âœ… **Has messages** - æ£€æŸ¥æ¶ˆæ¯æ•°ç»„éç©º

### Step 2 éªŒè¯ (Routing)
- âœ… **Has routing category** - éªŒè¯è·¯ç”±ç±»åˆ«ç¡®å®š
- âœ… **Has selected provider** - æ£€æŸ¥é€‰æ‹©çš„Provider
- âœ… **Has model mapping** - éªŒè¯æ¨¡å‹æ˜ å°„å®Œæ•´

### Step 4 éªŒè¯ (Raw Response)
- âœ… **Has response content** - æ£€æŸ¥å“åº”åŒ…å«å†…å®¹
- âœ… **Valid content length** - éªŒè¯å†…å®¹é•¿åº¦åˆç†

### Step 6 éªŒè¯ (Transformer Output)
- âœ… **Has content blocks** - æ£€æŸ¥å†…å®¹å—å­˜åœ¨
- âœ… **Has text content** - éªŒè¯æ–‡æœ¬å†…å®¹å­˜åœ¨

## æ•°æ®ä¿®æ”¹ç¤ºä¾‹

### ä¿®æ”¹è·¯ç”±Provider
```javascript
// ä¿®æ”¹Step 2çš„é€‰æ‹©Provider
replaySystem.modifyStepData('step2-routing', 'selectedProvider', 'backup-provider');
```

### ä¿®æ”¹æ¨¡å‹æ˜ å°„
```javascript
// ä¿®æ”¹ç›®æ ‡æ¨¡å‹
replaySystem.modifyStepData('step2-routing', 'targetModel', 'gpt-4-turbo');
```

### ä¿®æ”¹å“åº”å†…å®¹
```javascript
// ä¿®æ”¹åŸå§‹å“åº”çš„å†…å®¹
replaySystem.modifyStepData('step4-raw-response', 'responseData.choices.0.message.content', 'Modified response content');
```

## ä¼šè¯å¯¹æ¯”åŠŸèƒ½

### å¯¹æ¯”åœºæ™¯
1. **ä¿®å¤å‰åå¯¹æ¯”** - å¯¹æ¯”ä¿®å¤å‰åçš„æ‰§è¡Œå·®å¼‚
2. **ä¸åŒé…ç½®å¯¹æ¯”** - å¯¹æ¯”ä¸åŒè·¯ç”±é…ç½®çš„å½±å“
3. **Provideræ€§èƒ½å¯¹æ¯”** - å¯¹æ¯”ä¸åŒProviderçš„å“åº”å·®å¼‚

### å¯¹æ¯”è¾“å‡ºç¤ºä¾‹
```
ğŸ“Š Comparison Results:

   [step2-routing]:
     ğŸ“ˆ Differences found: 2
       â€¢ selectedProvider: shuaihong-openai â†’ codewhisperer-primary
       â€¢ targetModel: gemini-2.5-flash â†’ CLAUDE_SONNET_4_20250514_V1_0

   [step4-raw-response]:
     ğŸ“ˆ Differences found: 1
       â€¢ responseAnalysis.contentLength: 245 â†’ 312
```

## æŠ¥å‘Šç”Ÿæˆ

### å›æ”¾æŠ¥å‘Šå†…å®¹
- **ä¼šè¯ä¿¡æ¯** - ä¼šè¯IDã€æ—¶é—´æˆ³ã€å¯ç”¨æ­¥éª¤
- **ä¿®æ”¹è®°å½•** - åº”ç”¨çš„æ•°æ®ä¿®æ”¹åˆ—è¡¨
- **è°ƒè¯•é…ç½®** - æ–­ç‚¹è®¾ç½®ã€å•æ­¥æ¨¡å¼çŠ¶æ€
- **éªŒè¯ç»“æœ** - æ¯ä¸ªæ­¥éª¤çš„éªŒè¯æ£€æŸ¥ç»“æœ

### æŠ¥å‘Šæ–‡ä»¶è·¯å¾„
```
/tmp/openai-pipeline-captures/capture-[timestamp]-replay-report.json
```

## ä½¿ç”¨åœºæ™¯

### 1. é—®é¢˜è°ƒè¯•
```javascript
// è®¾ç½®æ–­ç‚¹åœ¨é—®é¢˜æ­¥éª¤
replaySystem.setBreakpoint('step4-raw-response');

// æ£€æŸ¥åŸå§‹APIå“åº”
// [æ–­ç‚¹æš‚åœ] > i (inspect)

// ä¿®æ”¹æ•°æ®æµ‹è¯•ä¿®å¤
// [æ–­ç‚¹æš‚åœ] > m (modify)
```

### 2. ä¿®å¤éªŒè¯
```javascript
// åŠ è½½é—®é¢˜ä¼šè¯
await replaySystem.loadSession('problematic-session');

// åº”ç”¨ä¿®å¤
replaySystem.modifyStepData('step3-transformation', 'openaiRequest.tools', []);

// æ‰§è¡ŒéªŒè¯
await replaySystem.executeFullReplay();
```

### 3. æ€§èƒ½åˆ†æ
```javascript
// å¯¹æ¯”ä¸åŒProviderçš„å“åº”æ—¶é—´
await replaySystem.compareWithSession('fast-provider-session');
```

## æ‰©å±•åŠŸèƒ½

### è‡ªå®šä¹‰éªŒè¯è§„åˆ™
å¯ä»¥æ‰©å±• `performStepValidation` æ–¹æ³•æ·»åŠ è‡ªå®šä¹‰éªŒè¯ï¼š

```javascript
// æ·»åŠ è‡ªå®šä¹‰éªŒè¯
case 'custom-step':
  validations.push({
    check: 'Custom validation',
    passed: customValidationLogic(data),
    message: 'Custom validation result'
  });
```

### æ‰¹é‡ä¿®æ”¹
æ”¯æŒæ‰¹é‡åº”ç”¨ä¿®æ”¹é…ç½®ï¼š

```javascript
const modifications = {
  'step2-routing': {
    'selectedProvider': 'new-provider',
    'targetModel': 'new-model'
  }
};

Object.entries(modifications).forEach(([step, changes]) => {
  Object.entries(changes).forEach(([path, value]) => {
    replaySystem.modifyStepData(step, path, value);
  });
});
```

## æ€§èƒ½ä¼˜åŒ–
- **æ‡’åŠ è½½** - æŒ‰éœ€åŠ è½½æ­¥éª¤æ•°æ®
- **å†…å­˜ç®¡ç†** - åŠæ—¶æ¸…ç†ä¸éœ€è¦çš„æ•°æ®
- **å¼‚æ­¥å¤„ç†** - é¿å…é˜»å¡ç”¨æˆ·äº¤äº’

## ä¸‹ä¸€æ­¥è®¡åˆ’
1. **è‡ªåŠ¨åŒ–ä¿®å¤å»ºè®®** - åŸºäºéªŒè¯ç»“æœç”Ÿæˆä¿®å¤å»ºè®®
2. **å¯è§†åŒ–ç•Œé¢** - Webç•Œé¢æ”¯æŒæ›´ç›´è§‚çš„è°ƒè¯•
3. **æ‰¹é‡ä¼šè¯åˆ†æ** - æ”¯æŒå¤šä¼šè¯çš„æ‰¹é‡åˆ†æå’Œå¯¹æ¯”
4. **é›†æˆCI/CD** - å°†å›æ”¾éªŒè¯é›†æˆåˆ°æŒç»­é›†æˆæµç¨‹

## ç›¸å…³æ–‡ä»¶
- **å›æ”¾ç³»ç»Ÿ**: `/test/functional/test-openai-pipeline-replay.js`
- **æ•°æ®æ•è·ç³»ç»Ÿ**: `/test/functional/test-openai-pipeline-data-capture.js`
- **Hookç³»ç»Ÿ**: `/test/functional/test-openai-pipeline-hooks.js`
- **ä½¿ç”¨æ–‡æ¡£**: æœ¬æ–‡ä»¶
- **è¾“å‡ºç›®å½•**: `/tmp/openai-pipeline-captures/`