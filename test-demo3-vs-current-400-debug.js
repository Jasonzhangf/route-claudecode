#!/usr/bin/env node
/**
 * Demo3 vs Current Implementation 400é”™è¯¯è°ƒè¯•å¯¹æ¯”å·¥å…·
 * å…¨é¢æ•è·å’Œå¯¹æ¯”æ•°æ®æµï¼Œå®šä½API 400é”™è¯¯æ ¹æœ¬åŸå› 
 * é¡¹ç›®æ‰€æœ‰è€…: Jason Zhang
 */

const fs = require('fs');
const path = require('path');
const axios = require('axios');
const { spawn } = require('child_process');

class Demo3ComparisonDebugger {
  constructor() {
    this.debugDir = path.join(__dirname, 'debug-output/demo3-400-analysis');
    this.timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    
    // ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
    if (!fs.existsSync(this.debugDir)) {
      fs.mkdirSync(this.debugDir, { recursive: true });
    }
    
    this.demo3Port = 3457; // demo3é»˜è®¤ç«¯å£
    this.currentPort = 3456; // å½“å‰å®ç°ç«¯å£
  }

  /**
   * ä¸»è¦è°ƒè¯•æµç¨‹
   */
  async runFullComparison() {
    console.log('ğŸ” Demo3 vs Current Implementation 400é”™è¯¯å¯¹æ¯”åˆ†æ');
    console.log('==================================================');
    
    try {
      // 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
      await this.checkServicesStatus();
      
      // 2. æ•è·demo3çš„å®Œæ•´æµç¨‹æ•°æ®
      const demo3Data = await this.captureDemo3Pipeline();
      
      // 3. æ•è·å½“å‰å®ç°çš„å®Œæ•´æµç¨‹æ•°æ®
      const currentData = await this.captureCurrentPipeline();
      
      // 4. è¿›è¡Œè¯¦ç»†å¯¹æ¯”åˆ†æ
      const comparisonResult = await this.performDetailedComparison(demo3Data, currentData);
      
      // 5. éªŒè¯tokenè½®æ¢å½±å“
      const tokenRotationResult = await this.testTokenRotation();
      
      // 6. ç”Ÿæˆä¿®å¤å»ºè®®
      const fixSuggestions = await this.generateFixSuggestions(comparisonResult, tokenRotationResult);
      
      // 7. è¾“å‡ºå®Œæ•´åˆ†ææŠ¥å‘Š
      await this.generateComprehensiveReport({
        demo3Data,
        currentData,
        comparisonResult,
        tokenRotationResult,
        fixSuggestions
      });
      
      console.log('\nâœ… å®Œæ•´åˆ†ææŠ¥å‘Šå·²ç”Ÿæˆ');
      console.log(`ğŸ“ è¾“å‡ºç›®å½•: ${this.debugDir}`);
      
    } catch (error) {
      console.error('âŒ è°ƒè¯•è¿‡ç¨‹å¼‚å¸¸:', error.message);
      throw error;
    }\n  }\n\n  /**\n   * æ£€æŸ¥æœåŠ¡çŠ¶æ€\n   */\n  async checkServicesStatus() {\n    console.log('\\nğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€...');\n    \n    const services = [\n      { name: 'Demo3', port: this.demo3Port, path: '/health' },\n      { name: 'Current', port: this.currentPort, path: '/health' }\n    ];\n    \n    for (const service of services) {\n      try {\n        const response = await axios.get(`http://localhost:${service.port}${service.path}`, {\n          timeout: 3000\n        });\n        console.log(`  âœ… ${service.name}: è¿è¡Œæ­£å¸¸ (${response.status})`);\n      } catch (error) {\n        console.log(`  âŒ ${service.name}: æ— æ³•è¿æ¥ - ${error.message}`);\n        \n        if (service.name === 'Demo3') {\n          console.log('     æç¤º: è¯·å¯åŠ¨demo3æœåŠ¡: cd examples/demo3/AIClient-2-API && npm start');\n        } else {\n          console.log('     æç¤º: è¯·å¯åŠ¨å½“å‰æœåŠ¡: ./rcc start config.json');\n        }\n      }\n    }\n  }\n\n  /**\n   * æ•è·demo3çš„å®Œæ•´æµç¨‹æ•°æ®\n   */\n  async captureDemo3Pipeline() {\n    console.log('\\nğŸ¯ æ•è·Demo3æµç¨‹æ•°æ®...');\n    \n    const testRequest = {\n      model: 'CLAUDE_SONNET_4_20250514_V1_0',\n      max_tokens: 1000,\n      messages: [\n        { role: 'user', content: 'Hello, can you help me with a simple task?' }\n      ],\n      tools: [{\n        name: 'get_current_time',\n        description: 'Get the current time',\n        input_schema: {\n          type: 'object',\n          properties: {}\n        }\n      }]\n    };\n    \n    try {\n      // å‘é€åˆ°demo3\n      const demo3Response = await axios.post(`http://localhost:${this.demo3Port}/v1/messages`, testRequest, {\n        headers: {\n          'Content-Type': 'application/json',\n          'x-api-key': 'demo3-test-key'\n        },\n        timeout: 30000\n      });\n      \n      const demo3Data = {\n        request: testRequest,\n        response: demo3Response.data,\n        headers: demo3Response.headers,\n        status: demo3Response.status,\n        timestamp: new Date().toISOString()\n      };\n      \n      // ä¿å­˜demo3æ•°æ®\n      fs.writeFileSync(\n        path.join(this.debugDir, `demo3-pipeline-${this.timestamp}.json`),\n        JSON.stringify(demo3Data, null, 2)\n      );\n      \n      console.log('  âœ… Demo3æ•°æ®æ•è·æˆåŠŸ');\n      return demo3Data;\n      \n    } catch (error) {\n      console.log('  âŒ Demo3æ•°æ®æ•è·å¤±è´¥:', error.message);\n      \n      const errorData = {\n        request: testRequest,\n        error: {\n          message: error.message,\n          status: error.response?.status,\n          data: error.response?.data,\n          headers: error.response?.headers\n        },\n        timestamp: new Date().toISOString()\n      };\n      \n      // ä¿å­˜é”™è¯¯æ•°æ®\n      fs.writeFileSync(\n        path.join(this.debugDir, `demo3-error-${this.timestamp}.json`),\n        JSON.stringify(errorData, null, 2)\n      );\n      \n      return errorData;\n    }\n  }\n\n  /**\n   * æ•è·å½“å‰å®ç°çš„å®Œæ•´æµç¨‹æ•°æ®\n   */\n  async captureCurrentPipeline() {\n    console.log('\\nğŸ”§ æ•è·å½“å‰å®ç°æµç¨‹æ•°æ®...');\n    \n    const testRequest = {\n      model: 'CLAUDE_SONNET_4_20250514_V1_0',\n      max_tokens: 1000,\n      messages: [\n        { role: 'user', content: 'Hello, can you help me with a simple task?' }\n      ],\n      tools: [{\n        name: 'get_current_time',\n        description: 'Get the current time',\n        input_schema: {\n          type: 'object',\n          properties: {}\n        }\n      }]\n    };\n    \n    try {\n      // å‘é€åˆ°å½“å‰å®ç°\n      const currentResponse = await axios.post(`http://localhost:${this.currentPort}/v1/messages`, testRequest, {\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': 'Bearer test-key'\n        },\n        timeout: 30000\n      });\n      \n      const currentData = {\n        request: testRequest,\n        response: currentResponse.data,\n        headers: currentResponse.headers,\n        status: currentResponse.status,\n        timestamp: new Date().toISOString()\n      };\n      \n      // ä¿å­˜å½“å‰å®ç°æ•°æ®\n      fs.writeFileSync(\n        path.join(this.debugDir, `current-pipeline-${this.timestamp}.json`),\n        JSON.stringify(currentData, null, 2)\n      );\n      \n      console.log('  âœ… å½“å‰å®ç°æ•°æ®æ•è·æˆåŠŸ');\n      return currentData;\n      \n    } catch (error) {\n      console.log('  âŒ å½“å‰å®ç°æ•°æ®æ•è·å¤±è´¥:', error.message);\n      console.log(`     çŠ¶æ€ç : ${error.response?.status}`);\n      console.log(`     é”™è¯¯è¯¦æƒ…: ${JSON.stringify(error.response?.data, null, 2)}`);\n      \n      const errorData = {\n        request: testRequest,\n        error: {\n          message: error.message,\n          status: error.response?.status,\n          data: error.response?.data,\n          headers: error.response?.headers\n        },\n        timestamp: new Date().toISOString()\n      };\n      \n      // ä¿å­˜é”™è¯¯æ•°æ®\n      fs.writeFileSync(\n        path.join(this.debugDir, `current-error-${this.timestamp}.json`),\n        JSON.stringify(errorData, null, 2)\n      );\n      \n      return errorData;\n    }\n  }\n\n  /**\n   * æ‰§è¡Œè¯¦ç»†å¯¹æ¯”åˆ†æ\n   */\n  async performDetailedComparison(demo3Data, currentData) {\n    console.log('\\nğŸ”¬ æ‰§è¡Œè¯¦ç»†å¯¹æ¯”åˆ†æ...');\n    \n    const comparison = {\n      requestDifferences: this.compareRequests(demo3Data.request, currentData.request),\n      responseDifferences: this.compareResponses(demo3Data, currentData),\n      headerDifferences: this.compareHeaders(demo3Data.headers, currentData.headers),\n      statusComparison: {\n        demo3: demo3Data.status || demo3Data.error?.status,\n        current: currentData.status || currentData.error?.status,\n        match: (demo3Data.status || demo3Data.error?.status) === (currentData.status || currentData.error?.status)\n      },\n      criticalIssues: [],\n      recommendations: []\n    };\n    \n    // è¯†åˆ«å…³é”®é—®é¢˜\n    if (currentData.error?.status === 400) {\n      comparison.criticalIssues.push({\n        type: 'API_400_ERROR',\n        description: 'Current implementation returning 400 Bad Request',\n        currentError: currentData.error,\n        demo3Status: demo3Data.status\n      });\n    }\n    \n    // å·¥å…·å®šä¹‰å¯¹æ¯”\n    if (demo3Data.request?.tools && currentData.request?.tools) {\n      const toolsComparison = this.compareToolDefinitions(\n        demo3Data.request.tools,\n        currentData.request.tools\n      );\n      comparison.toolsComparison = toolsComparison;\n      \n      if (!toolsComparison.match) {\n        comparison.criticalIssues.push({\n          type: 'TOOLS_MISMATCH',\n          description: 'Tool definitions do not match between implementations',\n          differences: toolsComparison.differences\n        });\n      }\n    }\n    \n    // ä¿å­˜å¯¹æ¯”ç»“æœ\n    fs.writeFileSync(\n      path.join(this.debugDir, `comparison-analysis-${this.timestamp}.json`),\n      JSON.stringify(comparison, null, 2)\n    );\n    \n    console.log(`  âœ… å¯¹æ¯”åˆ†æå®Œæˆï¼Œå‘ç° ${comparison.criticalIssues.length} ä¸ªå…³é”®é—®é¢˜`);\n    return comparison;\n  }\n\n  /**\n   * æµ‹è¯•tokenè½®æ¢å½±å“\n   */\n  async testTokenRotation() {\n    console.log('\\nğŸ”„ æµ‹è¯•Tokenè½®æ¢å½±å“...');\n    \n    const testResults = {\n      beforeRotation: null,\n      afterRotation: null,\n      rotationEffect: null,\n      still400: false\n    };\n    \n    try {\n      // æµ‹è¯•è½®æ¢å‰\n      console.log('  ğŸ“ æµ‹è¯•Tokenè½®æ¢å‰çŠ¶æ€...');\n      testResults.beforeRotation = await this.sendTestRequest('before-rotation');\n      \n      // æ‰§è¡Œtokenè½®æ¢ (æ¨¡æ‹Ÿ)\n      console.log('  ğŸ”„ æ¨¡æ‹ŸTokenè½®æ¢...');\n      await this.simulateTokenRotation();\n      \n      // æµ‹è¯•è½®æ¢å\n      console.log('  ğŸ“ æµ‹è¯•Tokenè½®æ¢åçŠ¶æ€...');\n      testResults.afterRotation = await this.sendTestRequest('after-rotation');\n      \n      // åˆ†æè½®æ¢æ•ˆæœ\n      testResults.rotationEffect = this.analyzeRotationEffect(\n        testResults.beforeRotation,\n        testResults.afterRotation\n      );\n      \n      testResults.still400 = testResults.afterRotation.error?.status === 400;\n      \n      if (testResults.still400) {\n        console.log('  âŒ Tokenè½®æ¢åä»æœ‰400é”™è¯¯ - é—®é¢˜ä¸åœ¨Token');\n      } else {\n        console.log('  âœ… Tokenè½®æ¢åé”™è¯¯è§£å†³ - é—®é¢˜å¯èƒ½ä¸Tokenç›¸å…³');\n      }\n      \n      // ä¿å­˜è½®æ¢æµ‹è¯•ç»“æœ\n      fs.writeFileSync(\n        path.join(this.debugDir, `token-rotation-test-${this.timestamp}.json`),\n        JSON.stringify(testResults, null, 2)\n      );\n      \n      return testResults;\n      \n    } catch (error) {\n      console.log('  âŒ Tokenè½®æ¢æµ‹è¯•å¤±è´¥:', error.message);\n      testResults.error = error.message;\n      return testResults;\n    }\n  }\n\n  /**\n   * å‘é€æµ‹è¯•è¯·æ±‚\n   */\n  async sendTestRequest(phase) {\n    const testRequest = {\n      model: 'CLAUDE_SONNET_4_20250514_V1_0',\n      max_tokens: 500,\n      messages: [\n        { role: 'user', content: `Test request during ${phase}` }\n      ]\n    };\n    \n    try {\n      const response = await axios.post(`http://localhost:${this.currentPort}/v1/messages`, testRequest, {\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': 'Bearer test-key'\n        },\n        timeout: 15000\n      });\n      \n      return {\n        phase,\n        success: true,\n        status: response.status,\n        data: response.data,\n        timestamp: new Date().toISOString()\n      };\n      \n    } catch (error) {\n      return {\n        phase,\n        success: false,\n        error: {\n          message: error.message,\n          status: error.response?.status,\n          data: error.response?.data\n        },\n        timestamp: new Date().toISOString()\n      };\n    }\n  }\n\n  /**\n   * æ¨¡æ‹Ÿtokenè½®æ¢\n   */\n  async simulateTokenRotation() {\n    // è¿™é‡Œå¯ä»¥å®ç°å®é™…çš„tokenè½®æ¢é€»è¾‘\n    // ç›®å‰å…ˆæ¨¡æ‹Ÿç­‰å¾…\n    await new Promise(resolve => setTimeout(resolve, 2000));\n    console.log('    ğŸ’­ Tokenè½®æ¢æ¨¡æ‹Ÿå®Œæˆ (å®é™…å®ç°éœ€è¦è°ƒç”¨è®¤è¯åˆ·æ–°)');\n  }\n\n  /**\n   * åˆ†æè½®æ¢æ•ˆæœ\n   */\n  analyzeRotationEffect(before, after) {\n    return {\n      statusChanged: before.error?.status !== after.error?.status,\n      errorResolved: before.error && !after.error,\n      newErrorIntroduced: !before.error && after.error,\n      beforeStatus: before.error?.status || before.status,\n      afterStatus: after.error?.status || after.status\n    };\n  }\n\n  /**\n   * å¯¹æ¯”è¯·æ±‚\n   */\n  compareRequests(demo3Req, currentReq) {\n    const differences = [];\n    \n    if (JSON.stringify(demo3Req.model) !== JSON.stringify(currentReq.model)) {\n      differences.push({ field: 'model', demo3: demo3Req.model, current: currentReq.model });\n    }\n    \n    if (JSON.stringify(demo3Req.messages) !== JSON.stringify(currentReq.messages)) {\n      differences.push({ field: 'messages', demo3: demo3Req.messages, current: currentReq.messages });\n    }\n    \n    if (JSON.stringify(demo3Req.tools) !== JSON.stringify(currentReq.tools)) {\n      differences.push({ field: 'tools', demo3: demo3Req.tools, current: currentReq.tools });\n    }\n    \n    return {\n      match: differences.length === 0,\n      differences\n    };\n  }\n\n  /**\n   * å¯¹æ¯”å“åº”\n   */\n  compareResponses(demo3Data, currentData) {\n    if (demo3Data.error && currentData.error) {\n      return {\n        bothErrors: true,\n        demo3Error: demo3Data.error,\n        currentError: currentData.error,\n        sameErrorType: demo3Data.error.status === currentData.error.status\n      };\n    }\n    \n    if (demo3Data.error || currentData.error) {\n      return {\n        mixedResults: true,\n        demo3HasError: !!demo3Data.error,\n        currentHasError: !!currentData.error,\n        demo3Response: demo3Data.response,\n        currentResponse: currentData.response\n      };\n    }\n    \n    return {\n      bothSuccess: true,\n      demo3Response: demo3Data.response,\n      currentResponse: currentData.response\n    };\n  }\n\n  /**\n   * å¯¹æ¯”è¯·æ±‚å¤´\n   */\n  compareHeaders(demo3Headers, currentHeaders) {\n    const demo3Keys = Object.keys(demo3Headers || {});\n    const currentKeys = Object.keys(currentHeaders || {});\n    \n    return {\n      demo3Keys,\n      currentKeys,\n      commonKeys: demo3Keys.filter(key => currentKeys.includes(key)),\n      demo3Only: demo3Keys.filter(key => !currentKeys.includes(key)),\n      currentOnly: currentKeys.filter(key => !demo3Keys.includes(key))\n    };\n  }\n\n  /**\n   * å¯¹æ¯”å·¥å…·å®šä¹‰\n   */\n  compareToolDefinitions(demo3Tools, currentTools) {\n    const differences = [];\n    \n    if (demo3Tools.length !== currentTools.length) {\n      differences.push({\n        type: 'tool_count',\n        demo3: demo3Tools.length,\n        current: currentTools.length\n      });\n    }\n    \n    demo3Tools.forEach((demo3Tool, index) => {\n      const currentTool = currentTools[index];\n      if (currentTool) {\n        if (demo3Tool.name !== currentTool.name) {\n          differences.push({\n            type: 'tool_name',\n            index,\n            demo3: demo3Tool.name,\n            current: currentTool.name\n          });\n        }\n        \n        if (JSON.stringify(demo3Tool.input_schema) !== JSON.stringify(currentTool.input_schema)) {\n          differences.push({\n            type: 'input_schema',\n            index,\n            demo3: demo3Tool.input_schema,\n            current: currentTool.input_schema\n          });\n        }\n      }\n    });\n    \n    return {\n      match: differences.length === 0,\n      differences\n    };\n  }\n\n  /**\n   * ç”Ÿæˆä¿®å¤å»ºè®®\n   */\n  async generateFixSuggestions(comparisonResult, tokenRotationResult) {\n    console.log('\\nğŸ’¡ ç”Ÿæˆä¿®å¤å»ºè®®...');\n    \n    const suggestions = {\n      priority: 'high',\n      issues: comparisonResult.criticalIssues,\n      recommendations: [],\n      codeChanges: [],\n      configChanges: []\n    };\n    \n    // åŸºäº400é”™è¯¯çš„å»ºè®®\n    if (comparisonResult.criticalIssues.some(issue => issue.type === 'API_400_ERROR')) {\n      suggestions.recommendations.push({\n        type: 'API_400_FIX',\n        description: 'ä¿®å¤API 400é”™è¯¯',\n        actions: [\n          'æ£€æŸ¥è¯·æ±‚ä½“æ ¼å¼æ˜¯å¦ç¬¦åˆCodeWhisperer APIè§„èŒƒ',\n          'éªŒè¯å·¥å…·å®šä¹‰ç»“æ„æ˜¯å¦æ­£ç¡®',\n          'ç¡®è®¤profileArnå­—æ®µå¤„ç†é€»è¾‘',\n          'å¯¹æ¯”demo3çš„è¯·æ±‚æ ¼å¼è¿›è¡Œç²¾ç¡®åŒ¹é…'\n        ]\n      });\n      \n      suggestions.codeChanges.push({\n        file: 'src/providers/codewhisperer/converter.ts',\n        description: 'æ ¹æ®demo3æ ¼å¼è°ƒæ•´è¯·æ±‚è½¬æ¢é€»è¾‘',\n        priority: 'critical'\n      });\n    }\n    \n    // åŸºäºtokenè½®æ¢çš„å»ºè®®\n    if (tokenRotationResult.still400) {\n      suggestions.recommendations.push({\n        type: 'NON_TOKEN_ISSUE',\n        description: 'Tokenè½®æ¢åä»æœ‰400é”™è¯¯ï¼Œé—®é¢˜ä¸åœ¨è®¤è¯',\n        actions: [\n          'é‡ç‚¹æ£€æŸ¥è¯·æ±‚ä½“ç»“æ„',\n          'éªŒè¯APIç«¯ç‚¹å’Œè·¯å¾„',\n          'æ£€æŸ¥å¿…éœ€å­—æ®µæ˜¯å¦ç¼ºå¤±'\n        ]\n      });\n    }\n    \n    // å·¥å…·å®šä¹‰é—®é¢˜\n    if (comparisonResult.criticalIssues.some(issue => issue.type === 'TOOLS_MISMATCH')) {\n      suggestions.recommendations.push({\n        type: 'TOOLS_FORMAT_FIX',\n        description: 'ä¿®å¤å·¥å…·å®šä¹‰æ ¼å¼ä¸åŒ¹é…',\n        actions: [\n          'å¯¹æ¯”demo3å’Œå½“å‰å®ç°çš„å·¥å…·å®šä¹‰æ ¼å¼',\n          'ç¡®ä¿toolSpecificationç»“æ„æ­£ç¡®',\n          'éªŒè¯inputSchemaçš„jsonå­—æ®µ'\n        ]\n      });\n    }\n    \n    return suggestions;\n  }\n\n  /**\n   * ç”Ÿæˆç»¼åˆæŠ¥å‘Š\n   */\n  async generateComprehensiveReport(data) {\n    const reportPath = path.join(this.debugDir, `comprehensive-analysis-report-${this.timestamp}.md`);\n    \n    const report = `# Demo3 vs Current Implementation 400é”™è¯¯åˆ†ææŠ¥å‘Š\n\nç”Ÿæˆæ—¶é—´: ${new Date().toISOString()}\n\n## ğŸ“‹ æ‰§è¡Œæ‘˜è¦\n\n### å…³é”®å‘ç°\n- Demo3çŠ¶æ€: ${data.demo3Data.status || 'é”™è¯¯'}\n- å½“å‰å®ç°çŠ¶æ€: ${data.currentData.status || data.currentData.error?.status || 'é”™è¯¯'}\n- å…³é”®é—®é¢˜æ•°é‡: ${data.comparisonResult.criticalIssues.length}\n- Tokenè½®æ¢åä»æœ‰400é”™è¯¯: ${data.tokenRotationResult.still400 ? 'æ˜¯' : 'å¦'}\n\n### é—®é¢˜ä¼˜å…ˆçº§\n${data.fixSuggestions.issues.map(issue => `- **${issue.type}**: ${issue.description}`).join('\\n')}\n\n## ğŸ” è¯¦ç»†åˆ†æ\n\n### 1. è¯·æ±‚å¯¹æ¯”åˆ†æ\n${JSON.stringify(data.comparisonResult.requestDifferences, null, 2)}\n\n### 2. å“åº”å¯¹æ¯”åˆ†æ\n${JSON.stringify(data.comparisonResult.responseDifferences, null, 2)}\n\n### 3. Tokenè½®æ¢æµ‹è¯•ç»“æœ\n- è½®æ¢å‰çŠ¶æ€: ${data.tokenRotationResult.beforeRotation?.success ? 'æˆåŠŸ' : 'å¤±è´¥'}\n- è½®æ¢åçŠ¶æ€: ${data.tokenRotationResult.afterRotation?.success ? 'æˆåŠŸ' : 'å¤±è´¥'}\n- é—®é¢˜æ˜¯å¦ä¸Tokenç›¸å…³: ${data.tokenRotationResult.still400 ? 'å¦' : 'å¯èƒ½'}\n\n## ğŸ’¡ ä¿®å¤å»ºè®®\n\n${data.fixSuggestions.recommendations.map(rec => `\n### ${rec.type}\n${rec.description}\n\n**è¡ŒåŠ¨é¡¹:**\n${rec.actions.map(action => `- ${action}`).join('\\n')}\n`).join('\\n')}\n\n## ğŸ”§ éœ€è¦ä¿®æ”¹çš„ä»£ç æ–‡ä»¶\n\n${data.fixSuggestions.codeChanges.map(change => `- **${change.file}** (ä¼˜å…ˆçº§: ${change.priority})\\n  ${change.description}`).join('\\n')}\n\n## ğŸ“Š åŸå§‹æ•°æ®æ–‡ä»¶\n\n- Demo3æ•°æ®: \\`demo3-pipeline-${this.timestamp}.json\\`\n- å½“å‰å®ç°æ•°æ®: \\`current-pipeline-${this.timestamp}.json\\` æˆ– \\`current-error-${this.timestamp}.json\\`\n- å¯¹æ¯”åˆ†æ: \\`comparison-analysis-${this.timestamp}.json\\`\n- Tokenæµ‹è¯•: \\`token-rotation-test-${this.timestamp}.json\\`\n\n## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨\n\n1. **ç«‹å³è¡ŒåŠ¨**: ä¿®å¤å…³é”®çš„API 400é”™è¯¯\n2. **ä»£ç å¯¹æ¯”**: è¯¦ç»†å¯¹æ¯”demo3å’Œå½“å‰å®ç°çš„å·®å¼‚\n3. **æµ‹è¯•éªŒè¯**: åº”ç”¨ä¿®å¤åè¿›è¡Œå…¨é¢æµ‹è¯•\n4. **æ–‡æ¡£æ›´æ–°**: æ›´æ–°ç›¸å…³æŠ€æœ¯æ–‡æ¡£\n\n---\n*æ­¤æŠ¥å‘Šç”±Demo3ComparisonDebuggerè‡ªåŠ¨ç”Ÿæˆ*\n`;\n    \n    fs.writeFileSync(reportPath, report);\n    console.log(`  âœ… ç»¼åˆåˆ†ææŠ¥å‘Šå·²ç”Ÿæˆ: ${reportPath}`);\n  }\n}\n\n// è¿è¡Œè°ƒè¯•å™¨\nasync function runDebugger() {\n  const debugger = new Demo3ComparisonDebugger();\n  \n  try {\n    await debugger.runFullComparison();\n    console.log('\\nğŸ‰ Demo3å¯¹æ¯”åˆ†æå®Œæˆï¼');\n    console.log('ğŸ“ æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š:', debugger.debugDir);\n  } catch (error) {\n    console.error('ğŸ’¥ è°ƒè¯•å™¨æ‰§è¡Œå¤±è´¥:', error);\n    process.exit(1);\n  }\n}\n\nif (require.main === module) {\n  runDebugger();\n}\n\nmodule.exports = { Demo3ComparisonDebugger };