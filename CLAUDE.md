## ğŸ§ª é‡æ„åçš„æµ‹è¯•æ¡†æ¶è®¾è®¡ (REFACTORED TEST FRAMEWORK)

### ğŸ¯ æµ‹è¯•æ¡†æ¶é‡æ„ç›®æ ‡

åŸºäºä¸€æ¬¡æ€§é¢„å¤„ç†å™¨æ¶æ„çš„æ–°æµ‹è¯•æ¡†æ¶ï¼Œæ”¯æŒï¼š

1. **æ¨¡å—å†…èšæµ‹è¯•**ï¼šæ¯ä¸ªæ¨¡å—çš„æµ‹è¯•æ”¾åœ¨æ¨¡å—ç›®å½•ä¸‹çš„`__tests__`æ–‡ä»¶å¤¹
2. **é¢„å¤„ç†å™¨å•å…ƒæµ‹è¯•**ï¼šä¸“é—¨æµ‹è¯•ConfigPreprocessorå’ŒRouterPreprocessorçš„é›¶æ¥å£æš´éœ²è®¾è®¡
3. **è¾“å‡ºè¡¨éªŒè¯æµ‹è¯•**ï¼šéªŒè¯æ¯ä¸ªè¾“å‡ºè¡¨ä¸é…ç½®æ–‡ä»¶çš„å®Œæ•´å¯¹åº”å…³ç³»
4. **ç«¯åˆ°ç«¯æ•°æ®æµæµ‹è¯•**ï¼šå®Œæ•´çš„é…ç½®æ–‡ä»¶ â†’ è·¯ç”±è¡¨ â†’ æµæ°´çº¿é…ç½®æµç¨‹æµ‹è¯•
5. **è½¬æ¢åŠŸèƒ½æµ‹è¯•**ï¼šä¸“é—¨é’ˆå¯¹ Anthropic åˆ° OpenAI æ ¼å¼è½¬æ¢çš„æµ‹è¯•
6. **è‡ªåŠ¨åŒ–æ¯”è¾ƒéªŒè¯**ï¼šRCC v4.0 ä¸ Claude Code Router ç»“æœå¯¹æ¯”

### ğŸ“ æ–°çš„æµ‹è¯•ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ __tests__/
â”‚   â”‚   â”œâ”€â”€ config-preprocessor.test.ts     # ConfigPreprocessorå•å…ƒæµ‹è¯•
â”‚   â”‚   â””â”€â”€ test-outputs/                   # æµ‹è¯•è¾“å‡ºç›®å½•
â”‚   â”‚       â”œâ”€â”€ config-preprocessor-result.json
â”‚   â”‚       â”œâ”€â”€ routing-table.json
â”‚   â”‚       â””â”€â”€ end-to-end-result.json
â”‚   â”œâ”€â”€ config-preprocessor.ts              # ä¸€æ¬¡æ€§é…ç½®é¢„å¤„ç†å™¨
â”‚   â””â”€â”€ routing-table-types.ts              # è·¯ç”±è¡¨ç±»å‹å®šä¹‰
â”œâ”€â”€ router/
â”‚   â”œâ”€â”€ __tests__/
â”‚   â”‚   â”œâ”€â”€ router-preprocessor.test.ts     # RouterPreprocessorå•å…ƒæµ‹è¯•
â”‚   â”‚   â””â”€â”€ test-outputs/                   # æµ‹è¯•è¾“å‡ºç›®å½•
â”‚   â”‚       â”œâ”€â”€ router-preprocessor-result.json
â”‚   â”‚       â”œâ”€â”€ internal-routing-table.json
â”‚   â”‚       â””â”€â”€ pipeline-configs.json
â”‚   â”œâ”€â”€ router-preprocessor.ts              # ä¸€æ¬¡æ€§è·¯ç”±å™¨é¢„å¤„ç†å™¨
â”‚   â””â”€â”€ pipeline-router.ts                  # é‡æ„åçš„æµæ°´çº¿è·¯ç”±å™¨
â”œâ”€â”€ __tests__/                              # è½¬æ¢æµ‹è¯•ç”¨ä¾‹ç›®å½•
â”‚   â”œâ”€â”€ basic-transformer.test.ts           # åŸºæœ¬è½¬æ¢æµ‹è¯•
â”‚   â”œâ”€â”€ tool-calling-transformer.test.ts    # å·¥å…·è°ƒç”¨è½¬æ¢æµ‹è¯•
â”‚   â”œâ”€â”€ streaming-protocol.test.ts          # æµå¼åè®®è½¬æ¢æµ‹è¯•
â”‚   â””â”€â”€ complex-scenarios.test.ts           # å¤æ‚åœºæ™¯æµ‹è¯•
â””â”€â”€ pipeline/
    â”œâ”€â”€ __tests__/
    â”‚   â””â”€â”€ pipeline-lifecycle-manager.test.ts
    â””â”€â”€ pipeline-lifecycle-manager.ts
```

### ğŸ”¬ é¢„å¤„ç†å™¨æµ‹è¯•è§„èŒƒ

#### ConfigPreprocessoræµ‹è¯•è¦†ç›–
- **é…ç½®æ–‡ä»¶è§£æ**ï¼šæ”¯æŒç®€å•æ ¼å¼å’Œv4æ ¼å¼
- **Providerä¿¡æ¯è½¬æ¢**ï¼šéªŒè¯æ¯ä¸ªProviderçš„å®Œæ•´ä¿¡æ¯è½¬æ¢
- **è·¯ç”±æ˜ å°„ç”Ÿæˆ**ï¼šç¡®ä¿æ‰€æœ‰è·¯ç”±ï¼ˆæ˜¾å¼+è‡ªåŠ¨ç”Ÿæˆï¼‰çš„æ­£ç¡®æ€§
- **æœåŠ¡å™¨é…ç½®æ˜ å°„**ï¼šéªŒè¯æœåŠ¡å™¨é…ç½®çš„å®Œæ•´å¯¹åº”
- **é”™è¯¯å¤„ç†**ï¼šæµ‹è¯•æ— æ•ˆé…ç½®æ–‡ä»¶çš„æ‹’ç»æœºåˆ¶
- **é›¶æ¥å£æš´éœ²**ï¼šéªŒè¯åªèƒ½è°ƒç”¨`preprocess()`æ–¹æ³•

#### RouterPreprocessoræµ‹è¯•è¦†ç›–
- **è·¯ç”±è¡¨è¾“å…¥éªŒè¯**ï¼šç¡®ä¿è¾“å…¥æ•°æ®çš„å®Œæ•´æ€§éªŒè¯
- **å†…éƒ¨è·¯ç”±è¡¨ç”Ÿæˆ**ï¼šéªŒè¯PipelineRouteç»“æ„çš„æ­£ç¡®æ€§
- **æµæ°´çº¿é…ç½®ç”Ÿæˆ**ï¼šç¡®ä¿æ¯ä¸ªè·¯ç”±éƒ½æœ‰å¯¹åº”çš„æµæ°´çº¿é…ç½®
- **å…­å±‚æµæ°´çº¿æ¶æ„**ï¼šéªŒè¯æ¯ä¸ªæµæ°´çº¿çš„6å±‚ç»“æ„å®Œæ•´æ€§
- **ä¼˜å…ˆçº§å¤„ç†**ï¼šç¡®ä¿è·¯ç”±ä¼˜å…ˆçº§çš„æ­£ç¡®æ’åº
- **é›¶æ¥å£æš´éœ²**ï¼šéªŒè¯åªèƒ½è°ƒç”¨`preprocess()`æ–¹æ³•

### ğŸ” è½¬æ¢æµ‹è¯•è§„èŒƒ

#### åŸºæœ¬è½¬æ¢æµ‹è¯• (basic-transformer.test.ts)
- **ç®€å•æ¶ˆæ¯è½¬æ¢**ï¼šéªŒè¯åŸºç¡€ç”¨æˆ·æ¶ˆæ¯çš„è½¬æ¢
- **ç³»ç»Ÿæ¶ˆæ¯å¤„ç†**ï¼šéªŒè¯ç³»ç»Ÿæ¶ˆæ¯åˆ°system roleçš„è½¬æ¢
- **å¤šè½®å¯¹è¯è½¬æ¢**ï¼šéªŒè¯å¤šè½®å¯¹è¯ç»“æ„çš„ä¿æŒ
- **å‚æ•°ä¿ç•™éªŒè¯**ï¼šéªŒè¯temperatureã€max_tokensç­‰å‚æ•°çš„ä¿ç•™

#### å·¥å…·è°ƒç”¨è½¬æ¢æµ‹è¯• (tool-calling-transformer.test.ts)
- **å·¥å…·å®šä¹‰è½¬æ¢**ï¼šéªŒè¯toolsåˆ°functionsçš„è½¬æ¢
- **å·¥å…·ä½¿ç”¨è½¬æ¢**ï¼šéªŒè¯tool_useåˆ°tool_callsçš„è½¬æ¢
- **å·¥å…·ç»“æœè½¬æ¢**ï¼šéªŒè¯tool_resultåˆ°tool roleçš„è½¬æ¢

#### æµå¼åè®®æµ‹è¯• (streaming-protocol.test.ts)
- **æµå¼è¯·æ±‚å¤„ç†**ï¼šéªŒè¯streamå‚æ•°çš„æ­£ç¡®å¤„ç†
- **æµå¼å‚æ•°ä¿ç•™**ï¼šéªŒè¯æµå¼ä¼ è¾“æ—¶å…¶ä»–å‚æ•°çš„ä¿ç•™

#### å¤æ‚åœºæ™¯æµ‹è¯• (complex-scenarios.test.ts)
- **åµŒå¥—å†…å®¹å—å¤„ç†**ï¼šéªŒè¯å¤æ‚contentç»“æ„çš„å¤„ç†
- **æ··åˆå†…å®¹ä¸å·¥å…·è°ƒç”¨**ï¼šéªŒè¯åŒæ—¶åŒ…å«å†…å®¹å’Œå·¥å…·çš„åœºæ™¯
- **å¤æ‚å·¥å…·ä½¿ç”¨åºåˆ—**ï¼šéªŒè¯å¤šæ­¥éª¤å·¥å…·è°ƒç”¨çš„è½¬æ¢

### ğŸ“Š è¾“å‡ºè¡¨éªŒè¯æ ‡å‡†

#### å¿…é¡»ä¿å­˜çš„æµ‹è¯•è¾“å‡ºæ–‡ä»¶
1. **config-preprocessor-result.json**ï¼šConfigPreprocessorå®Œæ•´å¤„ç†ç»“æœ
2. **routing-table.json**ï¼šç”Ÿæˆçš„æ ‡å‡†è·¯ç”±è¡¨
3. **router-preprocessor-result.json**ï¼šRouterPreprocessorå®Œæ•´å¤„ç†ç»“æœ
4. **internal-routing-table.json**ï¼šå†…éƒ¨è·¯ç”±è¡¨ï¼ˆPipelineRouteæ ¼å¼ï¼‰
5. **pipeline-configs.json**ï¼šæµæ°´çº¿é…ç½®æ•°ç»„
6. **end-to-end-result.json**ï¼šç«¯åˆ°ç«¯å®Œæ•´æ•°æ®æµç»“æœ

#### å¯¹åº”å…³ç³»éªŒè¯è¦æ±‚
- **Providerå¯¹åº”**ï¼šæ¯ä¸ªè¾“å‡ºProviderå¿…é¡»å¯¹åº”é…ç½®æ–‡ä»¶ä¸­çš„Provider
- **è·¯ç”±å¯¹åº”**ï¼šæ¯ä¸ªè·¯ç”±å¿…é¡»å¯¹åº”é…ç½®æ–‡ä»¶ä¸­çš„æ˜¾å¼è·¯ç”±æˆ–è‡ªåŠ¨ç”Ÿæˆè§„åˆ™
- **æœåŠ¡å™¨é…ç½®å¯¹åº”**ï¼šè¾“å‡ºçš„æœåŠ¡å™¨é…ç½®å¿…é¡»å®Œå…¨åŒ¹é…è¾“å…¥é…ç½®
- **æµæ°´çº¿å¯¹åº”**ï¼šæ¯ä¸ªæµæ°´çº¿é…ç½®å¿…é¡»å¯¹åº”ä¸€ä¸ªæœ‰æ•ˆçš„è·¯ç”±æ˜ å°„
- **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿å¤„ç†è¿‡ç¨‹ä¸­æ²¡æœ‰æ•°æ®ä¸¢å¤±æˆ–é”™è¯¯è½¬æ¢

### ğŸ”„ è‡ªåŠ¨åŒ–æµ‹è¯•å’Œæ¯”è¾ƒç³»ç»Ÿ

#### æµ‹è¯•æ‰§è¡Œæµç¨‹
```bash
# å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
./scripts/start-test-environment.sh

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm run test:all

# ç”Ÿæˆæ¯”è¾ƒæŠ¥å‘Šï¼ˆä¸ Claude Code Router å¯¹æ¯”ï¼‰
npm run test:compare

# éªŒè¯è‡ªåŠ¨ä¿®å¤åŠŸèƒ½
npm run test:verify

# åœæ­¢æµ‹è¯•ç¯å¢ƒ
./scripts/stop-test-environment.sh
```

#### æ¯”è¾ƒéªŒè¯åŠŸèƒ½
- **ç»“æœå¯¹æ¯”**ï¼šè‡ªåŠ¨æ¯”è¾ƒ RCC v4.0 ä¸ Claude Code Router çš„è½¬æ¢ç»“æœ
- **å·®å¼‚åˆ†æ**ï¼šç”Ÿæˆè¯¦ç»†çš„å·®å¼‚æŠ¥å‘Š
- **åŒ¹é…ç‡ç»Ÿè®¡**ï¼šè®¡ç®—è½¬æ¢ç»“æœçš„åŒ¹é…ç‡
- **ä¿®å¤å»ºè®®**ï¼šåŸºäºå·®å¼‚è‡ªåŠ¨ç”Ÿæˆä¿®å¤å»ºè®®

### ğŸ§ª æµ‹è¯•é…ç½®æ–‡ä»¶è§„èŒƒ

#### æ ‡å‡†æµ‹è¯•é…ç½®ï¼š`/Users/fanzhang/.route-claudecode/config.json`
```json
{
  "version": "4.1",
  "Providers": [
    {
      "name": "lmstudio",
      "priority": 1,
      "api_base_url": "http://localhost:1234/v1",
      "api_key": "lm-studio",
      "models": ["llama-3.1-8b", "qwen2.5-coder-32b"]
    },
    {
      "name": "qwen",
      "priority": 2,
      "api_base_url": "https://portal.qwen.ai/v1",
      "api_key": "qwen-auth-1",
      "models": ["qwen3-coder-plus", "qwen-max"]
    }
  ],
  "router": {
    "default": "lmstudio,llama-3.1-8b",
    "coding": "lmstudio,qwen2.5-coder-32b",
    "longContext": "qwen,qwen-max",
    "reasoning": "qwen,qwen3-coder-plus"
  },
  "server": {
    "port": 5506,
    "host": "0.0.0.0",
    "debug": true
  },
  "APIKEY": "rcc4-proxy-key"
}
```

### ğŸƒâ€â™‚ï¸ æµ‹è¯•æ‰§è¡Œæµç¨‹

#### å•æ¨¡å—æµ‹è¯•
```bash
# ConfigPreprocessoræµ‹è¯•
npx jest src/config/__tests__/config-preprocessor.test.ts --verbose

# RouterPreprocessoræµ‹è¯•
npx jest src/router/__tests__/router-preprocessor.test.ts --verbose

# è½¬æ¢åŠŸèƒ½æµ‹è¯•
npm run test:basic
npm run test:tools
npm run test:streaming
npm run test:complex
```

#### å®Œæ•´æµ‹è¯•æµç¨‹
```bash
# ç¼–è¯‘TypeScriptä»£ç 
npm run build

# è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
npm test

# è¿è¡Œè½¬æ¢æµ‹è¯•å¥—ä»¶
npm run test:all

# ç”Ÿæˆæ¯”è¾ƒæŠ¥å‘Š
npm run test:compare

# æ£€æŸ¥æµ‹è¯•è¾“å‡º
ls -la src/config/__tests__/test-outputs/
ls -la src/router/__tests__/test-outputs/
ls -la test-results/
```

### âœ… æµ‹è¯•æˆåŠŸæ ‡å‡†

#### å¿…é¡»æ»¡è¶³çš„æ¡ä»¶
- **ç¼–è¯‘é€šè¿‡**ï¼šæ‰€æœ‰TypeScriptä»£ç æ— ç¼–è¯‘é”™è¯¯
- **æµ‹è¯•é€šè¿‡**ï¼šæ‰€æœ‰å•å…ƒæµ‹è¯•100%é€šè¿‡
- **è¾“å‡ºæ–‡ä»¶ç”Ÿæˆ**ï¼šæ‰€æœ‰å¿…éœ€çš„è¾“å‡ºæ–‡ä»¶æˆåŠŸç”Ÿæˆ
- **å¯¹åº”å…³ç³»éªŒè¯**ï¼šè¾“å‡ºè¡¨ä¸é…ç½®æ–‡ä»¶çš„å®Œå…¨å¯¹åº”
- **æ•°æ®å®Œæ•´æ€§**ï¼šç«¯åˆ°ç«¯æ•°æ®æµçš„å®Œæ•´æ€§éªŒè¯
- **é›¶æ¥å£æš´éœ²éªŒè¯**ï¼šç¡®è®¤åªèƒ½è®¿é—®é¢„å¤„ç†å™¨çš„å…¬å¼€æ–¹æ³•
- **è½¬æ¢å‡†ç¡®æ€§**ï¼šAnthropicåˆ°OpenAIè½¬æ¢çš„å‡†ç¡®æ€§éªŒè¯
- **å…¼å®¹æ€§éªŒè¯**ï¼šä¸Claude Code Routerçš„å…¼å®¹æ€§éªŒè¯

#### æ€§èƒ½è¦æ±‚
- **ConfigPreprocessorå¤„ç†æ—¶é—´**ï¼š< 50ms
- **RouterPreprocessorå¤„ç†æ—¶é—´**ï¼š< 30ms
- **ç«¯åˆ°ç«¯å¤„ç†æ—¶é—´**ï¼š< 100ms
- **è½¬æ¢å“åº”æ—¶é—´**ï¼š< 50ms
- **è¾“å‡ºæ–‡ä»¶å¤§å°**ï¼šåˆç†çš„JSONæ ¼å¼ï¼Œä¾¿äºåˆ†æ

### ğŸ“‹ æµ‹è¯•è¿ç§»è®¡åˆ’

#### Phase 1: æ–°æµ‹è¯•ç»“æ„å»ºç«‹ âœ…
- [x] åˆ›å»ºConfigPreprocessorå•å…ƒæµ‹è¯•
- [x] åˆ›å»ºRouterPreprocessorå•å…ƒæµ‹è¯•
- [x] å»ºç«‹æ¨¡å—å†…æµ‹è¯•ç›®å½•ç»“æ„
- [x] åˆ›å»ºè½¬æ¢æµ‹è¯•ç”¨ä¾‹
- [x] å®ç°è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

#### Phase 2: ç°æœ‰æµ‹è¯•è¿ç§»
- [ ] è¿ç§»configç›¸å…³æµ‹è¯•åˆ°`src/config/__tests__/`
- [ ] è¿ç§»routerç›¸å…³æµ‹è¯•åˆ°`src/router/__tests__/`
- [ ] è¿ç§»pipelineç›¸å…³æµ‹è¯•åˆ°å¯¹åº”æ¨¡å—

#### Phase 3: æµ‹è¯•æ¡†æ¶æ¸…ç†
- [ ] æ¸…ç†`tests/`ç›®å½•ä¸­çš„é‡å¤å•å…ƒæµ‹è¯•
- [ ] ä¿ç•™é›†æˆæµ‹è¯•å’ŒE2Eæµ‹è¯•åœ¨`tests/`ç›®å½•
- [ ] æ›´æ–°Jesté…ç½®ä»¥æ”¯æŒæ–°çš„æµ‹è¯•è·¯å¾„

è¿™ç§æ¨¡å—å†…èšçš„æµ‹è¯•ç»“æ„æ›´ç¬¦åˆç°ä»£å¼€å‘å®è·µï¼Œæ¯ä¸ªæ¨¡å—çš„æµ‹è¯•ä¸ä»£ç ç´§å¯†ç»“åˆï¼Œä¾¿äºç‹¬ç«‹å¼€å‘å’Œç»´æŠ¤ï¼ŒåŒæ—¶ç¡®ä¿äº†ä¸€æ¬¡æ€§é¢„å¤„ç†å™¨æ¶æ„çš„æµ‹è¯•å®Œæ•´æ€§ã€‚æ–°å¢çš„è½¬æ¢æµ‹è¯•å’Œè‡ªåŠ¨åŒ–æ¯”è¾ƒç³»ç»Ÿç¡®ä¿äº†RCC v4.0ä¸Claude Code Routerçš„å…¼å®¹æ€§ã€‚

è¯¦ç»†æ–‡æ¡£è¯·å‚è€ƒï¼š
- [æµ‹è¯•æ¨¡å—è®¾è®¡æ–‡æ¡£](.claude/project-details/modules/testing/README.md)
- [RCC v4.0 æµ‹è¯•æ¡†æ¶æ–‡æ¡£](.claude/project-details/modules/testing/test-framework-v4.md)
- [é‡æ„åçš„æµ‹è¯•æ¡†æ¶è®¾è®¡](.claude/project-details/modules/testing/refactored-test-framework.md)
- [æµ‹è¯•ç³»ç»Ÿç´¢å¼•](.claude/project-details/modules/testing/INDEX.md)