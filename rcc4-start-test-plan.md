# RCC4 Start命令完整测试方案

## 测试目标
验证rcc4 start命令是否按照指定流程正确执行：
1. 配置读取 → Router预处理 → 流水线组装 → 流水线自检 → 动态调度系统运行

## 测试环境
- 系统：macOS/Linux
- Node.js版本：>=16
- 测试配置文件：`~/.route-claudecode/config.json`

## 测试步骤和验证点

### 1. 配置读取测试 (ConfigPreprocessor)

#### 测试用例 1.1: 正常配置文件读取
**预期行为：**
- 系统应能正确读取配置文件
- 配置文件中的Providers应被正确解析
- 路由配置应被正确解析
- 服务器配置应被正确解析

**验证方法：**
- 检查日志输出：`📋 Step 1: 配置预处理...`
- 检查日志输出：`✅ 配置处理完成: X providers, Y routes`

#### 测试用例 1.2: 配置文件不存在
**预期行为：**
- 系统应抛出错误并给出明确提示
- 程序应优雅退出

#### 测试用例 1.3: 配置文件格式错误
**预期行为：**
- 系统应捕获JSON解析错误
- 给出明确的错误信息
- 程序应优雅退出

### 2. Router预处理测试 (RouterPreprocessor)

#### 测试用例 2.1: 正常路由预处理
**预期行为：**
- 应正确生成内部路由表
- 应正确生成流水线配置
- 每个Provider和Model应有对应的流水线配置

**验证方法：**
- 检查日志输出：`🗺️ Step 2: 路由预处理...`
- 检查日志输出：`✅ 路由处理完成: X pipeline configurations`

#### 测试用例 2.2: 路由配置缺失
**预期行为：**
- 系统应检测到路由配置缺失
- 应抛出明确错误信息
- 程序应优雅退出

### 3. 流水线组装测试 (PipelineAssembler)

#### 测试用例 3.1: 正常流水线组装
**预期行为：**
- 应正确扫描并注册模块
- 应正确组装每个流水线
- 应正确建立模块间的连接关系
- 应正确初始化每个模块

**验证方法：**
- 检查日志输出：`🔧 Step 3: 流水线组装...`
- 检查日志输出：`📦 按路由模型分组配置: X groups`
- 检查日志输出：`✅ 流水线组装完成: route_model -> X pipelines`

#### 测试用例 3.2: 模块缺失
**预期行为：**
- 系统应检测到模块缺失
- 应在日志中记录警告信息
- 应继续处理其他可用模块

### 4. 流水线自检测试 (SelfCheckService)

#### 测试用例 4.1: API密钥验证
**预期行为：**
- 应验证所有配置的API密钥
- 应缓存验证结果
- 应正确标记有效/无效的API密钥

**验证方法：**
- 检查日志输出：`🔍 Step 4: 自检系统...`
- 检查日志输出：`✅ 自检完成: 成功/失败`

#### 测试用例 4.2: 流水线健康检查
**预期行为：**
- 应检查所有流水线的健康状态
- 应更新流水线状态信息
- 应记录检查结果

#### 测试用例 4.3: 无效API密钥处理
**预期行为：**
- 检测到无效API密钥时应销毁相关流水线
- 应在日志中记录销毁操作

### 5. 动态调度系统测试 (HTTPServer/PipelineManager)

#### 测试用例 5.1: 负载均衡配置
**预期行为：**
- 应正确建立路由模型到流水线的映射
- 多流水线时应配置负载均衡策略
- 单一流水线时应直接映射

**验证方法：**
- 检查日志输出：`⚡ Step 5: 动态调度系统初始化...`
- 检查日志输出：`⚡ 动态调度系统就绪: X route keys, Y total pipelines`

#### 测试用例 5.2: HTTP服务器启动
**预期行为：**
- 应在指定端口启动HTTP服务器
- 应注册所有必要的路由
- 应正确处理请求

**验证方法：**
- 检查日志输出：`✅ HTTP Server successfully started on http://host:port`
- 通过curl或浏览器访问健康检查端点

### 6. 完整流程测试

#### 测试用例 6.1: 完整启动流程
**预期行为：**
- 所有步骤应按顺序正确执行
- 每个步骤应有明确的日志输出
- 系统应进入正常运行状态

**验证方法：**
- 检查完整的日志输出序列
- 验证系统状态：`rcc4 status`
- 发送测试请求验证功能

#### 测试用例 6.2: 错误处理流程
**预期行为：**
- 任一步骤出错应停止后续执行
- 应给出明确的错误信息
- 应优雅清理已分配资源

## 日志验证标准

### 必须出现的日志信息：
1. `🚀 Starting 配置->路由->流水线组装->自检->动态调度系统 initialization...`
2. `📋 Step 1: 配置预处理...`
3. `🗺️ Step 2: 路由预处理...`
4. `🔧 Step 3: 流水线组装...`
5. `🔍 Step 4: 自检系统...`
6. `⚡ Step 5: 动态调度系统初始化...`
7. `🎉 完整初始化流程完成!`
8. `✅ HTTP Server successfully started`

### 性能指标验证：
- 完整启动时间应小于30秒
- 内存使用应小于500MB
- CPU使用率应稳定在合理范围

## 测试执行步骤

### 准备阶段：
1. 准备测试配置文件
2. 确保所有依赖模块可用
3. 清理之前的日志文件

### 执行阶段：
1. 运行 `rcc4 start --config test-config.json --debug`
2. 监控日志输出
3. 验证每个步骤的完成状态
4. 检查系统最终状态

### 验证阶段：
1. 检查日志完整性
2. 验证系统功能
3. 检查资源使用情况
4. 记录测试结果

## 预期结果
- 所有测试用例应通过
- 日志应清晰显示完整的执行路径
- 系统应稳定运行并正确处理请求
- 错误情况应被正确处理并有明确提示