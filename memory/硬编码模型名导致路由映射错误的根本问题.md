---
id: hardcoded-model-routing-mapping-error
type: issue
title: 硬编码模型名导致路由映射错误的根本问题
created: 2025-07-28
tags: [architecture, routing, debugging, hardcode, model-mapping]
---

# 硬编码模型名导致路由映射错误的根本问题

## 一句话说明
> Claude Code Router中散布的硬编码模型名违反了架构原则，导致路由映射在错误的时机和位置进行，引发API 400/500错误

## 上下文链接
- 基于：[[Claude Code Router四层架构设计]]
- 导致：[[API调用400500错误频发]]
- 相关：[[路由引擎架构重构方案]], [[零硬编码原则在系统设计中的重要性]]

## 核心内容

### 问题发现过程
在调试Claude Code Router的API 400/500错误时，用户发现了系统中存在的根本性架构问题。初始症状是多个API调用失败，但通过系统性分析发现，这些都是由硬编码模型名导致的路由映射错误引起的。

### 关键错误模式

#### 1. 硬编码模型名问题 (Critical Architecture Issue)
**具体位置**:
- `src/providers/codewhisperer/parser-buffered.ts:385` - 硬编码 `'claude-3-sonnet-20240229'`
- `src/providers/codewhisperer/client.ts` - 复杂的targetModel处理逻辑

**用户明确反馈**: "我们不能在任何流程里面做模型硬编码"

这违反了系统的基本设计原则，导致路由映射无法正确工作。

#### 2. 错误的映射时机 (Timing Issue)
**错误做法**: 模型名替换在响应处理阶段进行
**正确做法**: 模型名替换应该在路由映射阶段完成
**用户纠正**: "模型名的替换应该在mapping的时候就做不应该再发送的里面做"

正确的架构应该是在路由引擎中直接替换 `request.model = targetModel`。

#### 3. 错误的路由架构理解 (Architecture Misunderstanding)
**初始错误理解**: 使用defaultProvider降级机制
**用户纠正**: "路由引擎是错误的，我们不需要选择默认的provider,我们只需要选择默认模型，我们是按照模型选择provider"
**正确架构**: 类别驱动的直接映射 `category → {provider, model}`

### AI调试中的认知偏差分析

#### 1. 过度复杂化问题
- **偏差**: 倾向于认为是复杂的服务商集成问题或网络问题
- **实际**: 是简单但关键的硬编码问题
- **学习**: 在复杂系统中，基础的硬编码问题往往是根本原因

#### 2. 局部优化vs整体架构
- **偏差**: 专注于修复特定的API调用错误
- **实际**: 需要整体的架构重构来解决根本问题
- **学习**: 当多个症状出现时，要考虑架构层面的根本原因

#### 3. 测试验证的重要性
- **偏差**: 修复后没有建立系统性的验证机制
- **实际**: 用户要求建立3步测试体系确保修复效果
- **学习**: 架构性修复必须有对应的系统性测试验证

### 成功的解决方案

#### 技术实现
1. **完全消除硬编码**: 所有模型名通过参数传递
2. **路由阶段映射**: `applyModelMapping()` 直接替换 `request.model`
3. **简化提供商逻辑**: provider只需使用已映射的 `request.model`

#### 验证体系
- **Step 1**: 基础路由测试 (5/5 类别) - 100%通过
- **Step 2**: 模型映射测试 (5/5 映射) - 100%通过
- **Step 3**: 实际API测试 (2/2 API) - 100%通过

### 关键学习点

#### 对于AI助手
1. **听取用户架构指导**: 用户对系统架构的理解往往比AI的推测更准确
2. **重视基础问题**: 硬编码、配置错误等基础问题可能是复杂错误的根源
3. **系统性验证**: 架构修复需要建立对应的测试体系

#### 对于系统设计
1. **零硬编码原则**: 任何模型名、配置都应该通过参数或配置文件管理
2. **单一职责**: 路由负责映射，提供商负责调用，不要混合职责
3. **测试驱动**: 重要的架构更改必须有对应的自动化测试

### 最终验证结果
用户确认: "重新执行3步测试" → "全部通过，问题完全解决"

这个案例完美展示了在复杂系统调试中，基础架构问题的重要性以及系统性解决方案的价值。

## 关键文件
- `src/providers/codewhisperer/parser-buffered.ts` - 硬编码问题发现位置
- `src/providers/codewhisperer/client.ts` - 复杂映射逻辑位置
- `src/routing/engine.ts` - 路由映射正确实现位置
- `test/functional/test-routing-*.js` - 验证测试文件